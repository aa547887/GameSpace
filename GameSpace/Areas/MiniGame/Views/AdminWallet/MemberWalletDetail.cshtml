@model GameSpace.Areas.MiniGame.Models.MemberWalletDetailViewModel
@{
    ViewData["Title"] = "會員錢包詳情";
    Layout = "~/Areas/MiniGame/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">會員錢包詳情</h1>
        <a href="@Url.Action("Index", "AdminWallet")" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> 返回列表
        </a>
    </div>

    <!-- 用戶基本信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">用戶基本信息</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>用戶ID:</strong> @Model.UserID
                        </div>
                        <div class="col-md-3">
                            <strong>用戶名稱:</strong> @Model.UserName
                        </div>
                        <div class="col-md-3">
                            <strong>暱稱:</strong> @Model.NickName
                        </div>
                        <div class="col-md-3">
                            <strong>最後活動:</strong> @Model.LastActivity.ToString("yyyy-MM-dd HH:mm")
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 錢包統計 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                當前點數
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.CurrentPoints.ToString("N0")</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-coins fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                活躍優惠券
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ActiveCoupons</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                活躍電子禮券
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ActiveEVouchers</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-gift fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                總優惠券
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalCoupons</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速操作 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">快速操作</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-primary btn-block" onclick="showIssuePointsModal()">
                                <i class="fas fa-plus"></i> 發放點數
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-success btn-block" onclick="showIssueCouponModal()">
                                <i class="fas fa-ticket-alt"></i> 發放優惠券
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-info btn-block" onclick="showIssueEVoucherModal()">
                                <i class="fas fa-gift"></i> 發放電子禮券
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-warning btn-block" onclick="refreshData()">
                                <i class="fas fa-sync"></i> 刷新數據
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 錢包異動記錄 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">錢包異動記錄</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="walletHistoryTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>記錄ID</th>
                                    <th>異動類型</th>
                                    <th>金額</th>
                                    <th>物品代碼</th>
                                    <th>描述</th>
                                    <th>時間</th>
                                    <th>狀態</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var history in Model.RecentWalletHistory)
                                {
                                    <tr>
                                        <td>@history.LogID</td>
                                        <td>@history.ChangeType</td>
                                        <td class="text-right">@history.PointsChanged.ToString("N0")</td>
                                        <td>@history.ItemCode</td>
                                        <td>@history.Description</td>
                                        <td>@history.ChangeTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>
                                            <span class="badge badge-success">@history.Status</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 優惠券列表 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">優惠券列表</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="couponTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>優惠券ID</th>
                                    <th>優惠券代碼</th>
                                    <th>類型名稱</th>
                                    <th>折扣類型</th>
                                    <th>折扣值</th>
                                    <th>最低消費</th>
                                    <th>狀態</th>
                                    <th>獲得時間</th>
                                    <th>使用時間</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var coupon in Model.UserCoupons)
                                {
                                    <tr>
                                        <td>@coupon.CouponID</td>
                                        <td>@coupon.CouponCode</td>
                                        <td>@coupon.CouponTypeName</td>
                                        <td>@coupon.DiscountType</td>
                                        <td class="text-right">@coupon.DiscountValue.ToString("N0")</td>
                                        <td class="text-right">@coupon.MinSpend.ToString("N0")</td>
                                        <td>
                                            @if (coupon.IsUsed)
                                            {
                                                <span class="badge badge-secondary">已使用</span>
                                            }
                                            else if (coupon.IsExpired)
                                            {
                                                <span class="badge badge-danger">已過期</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-success">可用</span>
                                            }
                                        </td>
                                        <td>@coupon.AcquiredTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>@(coupon.UsedTime?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 電子禮券列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">電子禮券列表</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="evoucherTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>電子禮券ID</th>
                                    <th>電子禮券代碼</th>
                                    <th>類型名稱</th>
                                    <th>面額</th>
                                    <th>狀態</th>
                                    <th>獲得時間</th>
                                    <th>使用時間</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evoucher in Model.UserEVouchers)
                                {
                                    <tr>
                                        <td>@evoucher.EVoucherID</td>
                                        <td>@evoucher.EVoucherCode</td>
                                        <td>@evoucher.EVoucherTypeName</td>
                                        <td class="text-right">@evoucher.ValueAmount.ToString("N0")</td>
                                        <td>
                                            @if (evoucher.IsUsed)
                                            {
                                                <span class="badge badge-secondary">已使用</span>
                                            }
                                            else if (evoucher.IsExpired)
                                            {
                                                <span class="badge badge-danger">已過期</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-success">可用</span>
                                            }
                                        </td>
                                        <td>@evoucher.AcquiredTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>@(evoucher.UsedTime?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 發放點數模態框 -->
<div class="modal fade" id="issuePointsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">發放點數</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="issuePointsForm">
                    <div class="form-group">
                        <label for="userId">用戶ID</label>
                        <input type="number" class="form-control" id="userId" name="userId" value="@Model.UserID" readonly>
                    </div>
                    <div class="form-group">
                        <label for="amount">點數金額</label>
                        <input type="number" class="form-control" id="amount" name="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="description">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="issuePoints()">發放</button>
            </div>
        </div>
    </div>
</div>

<!-- 發放優惠券模態框 -->
<div class="modal fade" id="issueCouponModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">發放優惠券</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="issueCouponForm">
                    <div class="form-group">
                        <label for="couponUserId">用戶ID</label>
                        <input type="number" class="form-control" id="couponUserId" name="userId" value="@Model.UserID" readonly>
                    </div>
                    <div class="form-group">
                        <label for="couponTypeId">優惠券類型</label>
                        <select class="form-control" id="couponTypeId" name="couponTypeId" required>
                            <option value="">請選擇優惠券類型</option>
                            <!-- 這裡可以通過AJAX加載優惠券類型 -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="issueCoupon()">發放</button>
            </div>
        </div>
    </div>
</div>

<!-- 發放電子禮券模態框 -->
<div class="modal fade" id="issueEVoucherModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">發放電子禮券</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="issueEVoucherForm">
                    <div class="form-group">
                        <label for="evoucherUserId">用戶ID</label>
                        <input type="number" class="form-control" id="evoucherUserId" name="userId" value="@Model.UserID" readonly>
                    </div>
                    <div class="form-group">
                        <label for="evoucherTypeId">電子禮券類型</label>
                        <select class="form-control" id="evoucherTypeId" name="evoucherTypeId" required>
                            <option value="">請選擇電子禮券類型</option>
                            <!-- 這裡可以通過AJAX加載電子禮券類型 -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" onclick="issueEVoucher()">發放</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 顯示發放點數模態框
        function showIssuePointsModal() {
            #issuePointsModal.modal('show');
        }

        // 顯示發放優惠券模態框
        function showIssueCouponModal() {
            #issueCouponModal.modal('show');
        }

        // 顯示發放電子禮券模態框
        function showIssueEVoucherModal() {
            #issueEVoucherModal.modal('show');
        }

        // 刷新數據
        function refreshData() {
            location.reload();
        }

        // 發放點數
        function issuePoints() {
            var formData = {
                userId: #userId.val(),
                amount: #amount.val(),
                description: #description.val()
            };

            $.ajax({
                url: '@Url.Action("IssuePoints", "AdminWallet")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        alert('點數發放成功');
                        #issuePointsModal.modal('hide');
                        location.reload();
                    } else {
                        alert('發放失敗: ' + response.message);
                    }
                },
                error: function() {
                    alert('發放失敗，請稍後再試');
                }
            });
        }

        // 發放優惠券
        function issueCoupon() {
            var formData = {
                userId: #couponUserId.val(),
                couponTypeId: #couponTypeId.val()
            };

            $.ajax({
                url: '@Url.Action("IssueCoupon", "AdminWallet")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        alert('優惠券發放成功，代碼: ' + response.couponCode);
                        #issueCouponModal.modal('hide');
                        location.reload();
                    } else {
                        alert('發放失敗: ' + response.message);
                    }
                },
                error: function() {
                    alert('發放失敗，請稍後再試');
                }
            });
        }

        // 發放電子禮券
        function issueEVoucher() {
            var formData = {
                userId: #evoucherUserId.val(),
                evoucherTypeId: #evoucherTypeId.val()
            };

            $.ajax({
                url: '@Url.Action("IssueEVoucher", "AdminWallet")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        alert('電子禮券發放成功，代碼: ' + response.evoucherCode);
                        #issueEVoucherModal.modal('hide');
                        location.reload();
                    } else {
                        alert('發放失敗: ' + response.message);
                    }
                },
                error: function() {
                    alert('發放失敗，請稍後再試');
                }
            });
        }

        // 初始化DataTable
        .ready(function() {
            #walletHistoryTable.DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese-traditional.json"
                },
                "pageLength": 25,
                "order": [[5, "desc"]]
            });

            #couponTable.DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese-traditional.json"
                },
                "pageLength": 25,
                "order": [[7, "desc"]]
            });

            #evoucherTable.DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese-traditional.json"
                },
                "pageLength": 25,
                "order": [[5, "desc"]]
            });
        });
    </script>
}
