@model GameSpace.Areas.MiniGame.Models.AdminWalletViewModel
@{
    ViewData["Title"] = "會員錢包管理";
}

<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">會員錢包管理</h1>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-sm btn-primary" id="refreshWallet">
            <i class="fas fa-sync-alt"></i> 重新整理
        </button>
        <button type="button" class="btn btn-sm btn-success" id="adjustPoints" data-toggle="modal" data-target="#adjustPointsModal">
            <i class="fas fa-coins"></i> 調整點數
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="exportWallet">
            <i class="fas fa-download"></i> 匯出報表
        </button>
    </div>
</div>

<!-- Statistics Cards Row -->
<div class="row">
    <!-- Total Points Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">總點數發放</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPoints">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="totalPointsChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-coins fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Today Changes Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">今日點數異動</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayPointChanges">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="todayPointChangesChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-exchange-alt fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Coupons Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">總優惠券發放</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCoupons">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="totalCouponsChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-ticket-alt fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total EVouchers Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">總禮券發放</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalEVouchers">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="totalEVouchersChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-gift fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Search Section -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">用戶錢包查詢</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="userSearch">搜尋用戶</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="userSearch" placeholder="輸入用戶ID或用戶名">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button" id="searchUser">
                                <i class="fas fa-search"></i> 搜尋
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="userInfo" class="card" style="display: none;">
                    <div class="card-body">
                        <h6 class="card-title" id="userInfoTitle">用戶資訊</h6>
                        <div id="userInfoContent"></div>
                        <button class="btn btn-sm btn-success" id="adjustUserPoints">調整點數</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wallet History Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">錢包異動記錄</h6>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshHistory">
                <i class="fas fa-sync-alt"></i> 重新整理
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" id="exportHistory">
                <i class="fas fa-download"></i> 匯出
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="walletHistoryTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>記錄ID</th>
                        <th>會員ID</th>
                        <th>會員名稱</th>
                        <th>類型</th>
                        <th>金額</th>
                        <th>描述</th>
                        <th>時間</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Adjust Points Modal -->
<div class="modal fade" id="adjustPointsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">調整用戶點數</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="adjustPointsForm">
                    <div class="form-group">
                        <label for="modalUserId">用戶ID</label>
                        <input type="number" class="form-control" id="modalUserId" required>
                    </div>
                    <div class="form-group">
                        <label for="pointsChange">點數變動</label>
                        <input type="number" class="form-control" id="pointsChange" placeholder="正數為增加，負數為扣除" required>
                    </div>
                    <div class="form-group">
                        <label for="adjustReason">調整原因</label>
                        <textarea class="form-control" id="adjustReason" rows="3" required placeholder="請詳細說明調整原因"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAdjust">確認調整</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
<script>
$(document).ready(function() {
    var currentUserId = null;
    
    // Load wallet overview data
    function loadWalletData() {
        showLoading();
        makeAjaxRequest("@Url.Action("GetWalletOverview", "AdminWallet")", null,
            function(response) {
                $("#totalPoints").text(response.data.totalPoints.toLocaleString());
                $("#todayPointChanges").text(response.data.todayPointChanges.toLocaleString());
                $("#totalCoupons").text(response.data.totalCoupons.toLocaleString());
                $("#totalEVouchers").text(response.data.totalEVouchers.toLocaleString());
                
                // Update change percentages
                $("#totalPointsChange").html("<span class=\"text-success mr-2\"><i class=\"fas fa-arrow-up\"></i> 10%</span> 較上月");
                $("#todayPointChangesChange").html("<span class=\"text-danger mr-2\"><i class=\"fas fa-arrow-down\"></i> 5%</span> 較昨日");
                $("#totalCouponsChange").html("<span class=\"text-success mr-2\"><i class=\"fas fa-arrow-up\"></i> 15%</span> 較上週");
                $("#totalEVouchersChange").html("<span class=\"text-success mr-2\"><i class=\"fas fa-arrow-up\"></i> 7%</span> 較上月");
                
                loadWalletHistoryTable();
                hideLoading();
            },
            function() {
                hideLoading();
                showError("無法載入錢包數據，請重試", loadWalletData);
            }
        );
    }
    
    function loadWalletHistoryTable() {
        if ($.fn.dataTable.isDataTable("#walletHistoryTable")) {
            $("#walletHistoryTable").DataTable().destroy();
        }
        
        $("#walletHistoryTable").DataTable({
            processing: true,
            ajax: {
                url: "@Url.Action("GetWalletHistory", "AdminWallet")",
                dataSrc: function(json) {
                    return json.data || [];
                }
            },
            columns: [
                { data: "logId" },
                { data: "userId" },
                { data: "userName" },
                { data: "changeType" },
                { 
                    data: "amount",
                    render: function(data) {
                        return data > 0 ? 
                            "<span class=\"text-success\">+" + data.toLocaleString() + "</span>" :
                            "<span class=\"text-danger\">" + data.toLocaleString() + "</span>";
                    }
                },
                { data: "description" },
                { data: "changeTime" },
                { 
                    data: "status",
                    render: function(data) {
                        return "<span class=\"badge badge-success\">" + data + "</span>";
                    }
                },
                { 
                    data: null,
                    render: function(data, type, row) {
                        return "<button class=\"btn btn-info btn-sm view-detail\" data-id=\"" + row.logId + "\">" +
                               "<i class=\"fas fa-eye\"></i> 查看</button>";
                    }
                }
            ],
            order: [[0, "desc"]],
            pageLength: 25,
            language: {
                processing: "處理中...",
                lengthMenu: "顯示 _MENU_ 項記錄",
                zeroRecords: "沒有符合的記錄",
                info: "顯示第 _START_ 至 _END_ 項記錄，共 _TOTAL_ 項",
                infoEmpty: "顯示第 0 至 0 項記錄，共 0 項",
                search: "搜尋:",
                paginate: {
                    first: "首頁",
                    previous: "上頁",
                    next: "下頁",
                    last: "末頁"
                }
            }
        });
    }
    
    // Search user functionality
    $("#searchUser").click(function() {
        var searchTerm = $("#userSearch").val().trim();
        if (!searchTerm) {
            showError("請輸入用戶ID或用戶名");
            return;
        }
        
        var userId = parseInt(searchTerm);
        if (!isNaN(userId)) {
            getUserWalletInfo(userId);
        } else {
            showError("請輸入有效的用戶ID");
        }
    });
    
    $("#userSearch").keypress(function(e) {
        if (e.which == 13) {
            $("#searchUser").click();
        }
    });
    
    function getUserWalletInfo(userId) {
        makeAjaxRequest("@Url.Action("GetUserWalletInfo", "AdminWallet")", { userId: userId },
            function(response) {
                currentUserId = userId;
                displayUserInfo(response.data);
                $("#userInfo").show();
            },
            function(xhr) {
                $("#userInfo").hide();
                showError(xhr.responseJSON?.message || "無法獲取用戶信息");
            }
        );
    }
    
    function displayUserInfo(data) {
        var html = "<p><strong>用戶ID:</strong> " + data.userId + "</p>";
        html += "<p><strong>用戶名:</strong> " + data.userName + "</p>";
        html += "<p><strong>當前點數:</strong> <span class=\"text-primary font-weight-bold\">" + data.currentPoints.toLocaleString() + "</span></p>";
        
        if (data.recentHistory && data.recentHistory.length > 0) {
            html += "<div class=\"mt-3\"><strong>最近記錄:</strong></div>";
            html += "<div class=\"small\" style=\"max-height: 150px; overflow-y: auto;\">";
            data.recentHistory.forEach(function(record) {
                var amountClass = record.amount > 0 ? "text-success" : "text-danger";
                html += "<div class=\"border-bottom py-1\">";
                html += "<span class=\"" + amountClass + "\">" + (record.amount > 0 ? "+" : "") + record.amount + "</span> ";
                html += record.description + " <small class=\"text-muted\">(" + record.changeTime + ")</small>";
                html += "</div>";
            });
            html += "</div>";
        }
        
        $("#userInfoContent").html(html);
    }
    
    // Adjust points functionality
    $("#adjustUserPoints").click(function() {
        if (currentUserId) {
            $("#modalUserId").val(currentUserId);
            $("#adjustPointsModal").modal("show");
        }
    });
    
    $("#adjustPoints").click(function() {
        $("#modalUserId").val("");
        $("#adjustPointsModal").modal("show");
    });
    
    $("#confirmAdjust").click(function() {
        var userId = parseInt($("#modalUserId").val());
        var pointsChange = parseInt($("#pointsChange").val());
        var reason = $("#adjustReason").val().trim();
        
        if (!userId || isNaN(pointsChange) || !reason) {
            showError("請填寫所有必填欄位");
            return;
        }
        
        makeAjaxRequest("@Url.Action("AdjustUserPoints", "AdminWallet")", 
            {
                userId: userId,
                pointsChange: pointsChange,
                reason: reason
            },
            function(response) {
                showSuccess(response.message);
                $("#adjustPointsModal").modal("hide");
                $("#adjustPointsForm")[0].reset();
                
                // Refresh data
                loadWalletData();
                if (currentUserId === userId) {
                    getUserWalletInfo(userId);
                }
            },
            function(xhr) {
                showError(xhr.responseJSON?.message || "調整失敗");
            }
        );
    });
    
    // View detail functionality
    $(document).on("click", ".view-detail", function() {
        var logId = $(this).data("id");
        var rowData = $("#walletHistoryTable").DataTable().row($(this).parents("tr")).data();
        showWalletDetail(rowData);
    });
    
    function showWalletDetail(data) {
        var detail = "記錄詳情：\n";
        detail += "記錄ID: " + data.logId + "\n";
        detail += "會員: " + data.userName + " (ID: " + data.userId + ")\n";
        detail += "類型: " + data.changeType + "\n";
        detail += "金額: " + data.amount + "\n";
        detail += "描述: " + data.description + "\n";
        detail += "時間: " + data.changeTime + "\n";
        detail += "狀態: " + data.status;
        
        alert(detail);
    }
    
    // Export functionality
    $("#exportWallet").click(function() {
        window.open("@Url.Action("ExportWalletReport", "AdminWallet")", "_blank");
    });
    
    $("#exportHistory").click(function() {
        var table = $("#walletHistoryTable").DataTable();
        var data = table.data().toArray();
        exportToCSV(data, "wallet_history.csv");
    });
    
    function exportToCSV(data, filename) {
        var csv = "data:text/csv;charset=utf-8,";
        csv += "記錄ID,會員ID,會員名稱,類型,金額,描述,時間,狀態\n";
        data.forEach(function(row) {
            csv += [
                row.logId,
                row.userId,
                row.userName,
                row.changeType,
                row.amount,
                row.description.replace(/,/g, ";"),
                row.changeTime,
                row.status
            ].join(",") + "\n";
        });
        
        var encodedUri = encodeURI(csv);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Refresh functionality
    $("#refreshWallet").click(function() {
        loadWalletData();
    });
    
    $("#refreshHistory").click(function() {
        $("#walletHistoryTable").DataTable().ajax.reload();
    });
    
    // Initialize
    loadWalletData();
});
</script>
}
