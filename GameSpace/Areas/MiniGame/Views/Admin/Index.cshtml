@model GameSpace.Areas.MiniGame.Models.AdminDashboardViewModel
@{
    ViewData["Title"] = "MiniGame 後台儀表板";
}

<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">MiniGame 後台儀表板</h1>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-sm btn-primary" id="refreshDashboard">
            <i class="fas fa-sync-alt"></i> 重新整理
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="exportReport">
            <i class="fas fa-download"></i> 匯出報表
        </button>
    </div>
</div>

<!-- Statistics Cards Row -->
<div class="row">
    <!-- Total Users Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">總會員數</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="totalUsersChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-users fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Today Sign-ins Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">今日簽到數</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="todaySignIns">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="todaySignInsChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-calendar-check fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Games Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">總遊戲次數</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalGamesPlayed">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="totalGamesPlayedChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-gamepad fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Pets Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2 card-hover">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">活躍寵物數</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="activePets">
                            <div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">載入中...</span></div>
                        </div>
                        <div class="text-xs text-gray-500" id="activePetsChange"></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-paw fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Activity Chart -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">系統活動趨勢</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Module Usage Chart -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">模組使用分佈</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="moduleUsageChart"></canvas>
                </div>
                <div class="mt-4 text-center small">
                    <span class="mr-2"><i class="fas fa-circle text-primary"></i> 簽到系統</span>
                    <span class="mr-2"><i class="fas fa-circle text-success"></i> 小遊戲</span>
                    <span class="mr-2"><i class="fas fa-circle text-info"></i> 寵物系統</span>
                    <span class="mr-2"><i class="fas fa-circle text-warning"></i> 錢包系統</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">最近系統活動</h6>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshTable">
                <i class="fas fa-sync-alt"></i> 重新整理
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" id="exportTable">
                <i class="fas fa-download"></i> 匯出
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="recentActivityTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>時間</th>
                        <th>模組</th>
                        <th>操作</th>
                        <th>會員</th>
                        <th>狀態</th>
                        <th>詳情</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>


@section Scripts {
<script>
$(document).ready(function() {
    // Load dashboard data
    function loadDashboardData() {
        showLoading();
        makeAjaxRequest("@Url.Action("GetDashboardData", "Admin")", null, 
            function(response) {
                $("#totalUsers").text(response.data.totalUsers.toLocaleString());
                $("#todaySignIns").text(response.data.todaySignIns.toLocaleString());
                $("#totalGamesPlayed").text(response.data.totalGamesPlayed.toLocaleString());
                $("#activePets").text(response.data.activePets.toLocaleString());
                
                // Update change percentages
                $("#totalUsersChange").html("<span class=\"text-success mr-2\"><i class=\"fas fa-arrow-up\"></i> 12%</span> 較上月");
                $("#todaySignInsChange").html("<span class=\"text-info mr-2\"><i class=\"fas fa-arrow-up\"></i> 8%</span> 較昨日");
                $("#totalGamesPlayedChange").html("<span class=\"text-success mr-2\"><i class=\"fas fa-arrow-up\"></i> 15%</span> 較上週");
                $("#activePetsChange").html("<span class=\"text-warning mr-2\"><i class=\"fas fa-arrow-up\"></i> 5%</span> 較上月");
                
                initializeCharts(response.data);
                loadActivityTable();
                hideLoading();
            },
            function() {
                hideLoading();
                showError("無法載入儀表板數據，請重試", loadDashboardData);
            }
        );
    }
    
    function loadActivityTable() {
        if ($.fn.dataTable.isDataTable("#recentActivityTable")) {
            $("#recentActivityTable").DataTable().destroy();
        }
        
        $("#recentActivityTable").DataTable({
            processing: true,
            ajax: {
                url: "@Url.Action("GetDashboardData", "Admin")",
                dataSrc: function(json) {
                    return json.data.recentActivity || [];
                }
            },
            columns: [
                { 
                    data: "timestamp",
                    render: function(data) {
                        return new Date(data).toLocaleString("zh-TW");
                    }
                },
                { data: "module" },
                { data: "operation" },
                { data: "userName" },
                { 
                    data: "status",
                    render: function(data) {
                        var className = data === "成功" ? "badge-success" : 
                                       data === "失敗" ? "badge-danger" : "badge-info";
                        return "<span class=\"badge " + className + "\">" + data + "</span>";
                    }
                },
                { 
                    data: null,
                    render: function(data, type, row) {
                        return "<button class=\"btn btn-info btn-sm view-detail\" data-toggle=\"tooltip\" title=\"查看詳情\">" +
                               "<i class=\"fas fa-eye\"></i></button>";
                    }
                }
            ],
            order: [[0, "desc"]],
            pageLength: 15,
            language: {
                processing: "處理中...",
                lengthMenu: "顯示 _MENU_ 項記錄",
                zeroRecords: "沒有符合的記錄",
                info: "顯示第 _START_ 至 _END_ 項記錄，共 _TOTAL_ 項",
                infoEmpty: "顯示第 0 至 0 項記錄，共 0 項",
                search: "搜尋:",
                paginate: {
                    first: "首頁",
                    previous: "上頁",
                    next: "下頁",
                    last: "末頁"
                }
            }
        });
    }
    
    function initializeCharts(data) {
        // Activity trend chart
        var ctx = document.getElementById("activityChart");
        var myLineChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: ["1日", "2日", "3日", "4日", "5日", "6日", "7日"],
                datasets: [{
                    label: "簽到數",
                    lineTension: 0.3,
                    backgroundColor: "rgba(78, 115, 223, 0.05)",
                    borderColor: "rgba(78, 115, 223, 1)",
                    data: [120, 135, 140, 128, 155, 168, 175]
                }, {
                    label: "遊戲次數",
                    lineTension: 0.3,
                    backgroundColor: "rgba(28, 200, 138, 0.05)",
                    borderColor: "rgba(28, 200, 138, 1)",
                    data: [85, 92, 88, 95, 102, 98, 105]
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
        
        // Module usage pie chart
        var ctx2 = document.getElementById("moduleUsageChart");
        var myPieChart = new Chart(ctx2, {
            type: "doughnut",
            data: {
                labels: ["簽到系統", "小遊戲", "寵物系統", "錢包系統"],
                datasets: [{
                    data: [35, 28, 22, 15],
                    backgroundColor: ["#4e73df", "#1cc88a", "#36b9cc", "#f6c23e"]
                }]
            },
            options: {
                maintainAspectRatio: false,
                cutoutPercentage: 80
            }
        });
    }
    
    // Event handlers
    $("#refreshDashboard").click(function() {
        loadDashboardData();
    });
    
    $("#refreshTable").click(function() {
        $("#recentActivityTable").DataTable().ajax.reload();
    });
    
    $("#exportReport").click(function() {
        window.open("@Url.Action("ExportReport", "Admin")", "_blank");
    });
    
    $("#exportTable").click(function() {
        var table = $("#recentActivityTable").DataTable();
        var data = table.data().toArray();
        exportToCSV(data, "activity_report.csv");
    });
    
    function exportToCSV(data, filename) {
        var csv = "data:text/csv;charset=utf-8,";
        csv += "時間,模組,操作,會員,狀態\n";
        data.forEach(function(row) {
            csv += [
                new Date(row.timestamp).toLocaleString("zh-TW"),
                row.module,
                row.operation,
                row.userName,
                row.status
            ].join(",") + "\n";
        });
        
        var encodedUri = encodeURI(csv);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Initialize dashboard
    loadDashboardData();
    
    // Auto refresh every 5 minutes
    setInterval(function() {
        loadDashboardData();
    }, 300000);
});
</script>
}
