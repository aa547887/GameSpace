@model IEnumerable<GameSpace.Areas.OnlineStore.ViewModels.ProductIndexRowVM>
@{
    var keyword = (string)(ViewBag.Keyword ?? "");
    var currentType = (string?)ViewBag.Type;
    var status = (string)(ViewBag.Status ?? "active");
    var createdFrom = (string?)ViewBag.CreatedFrom;
    var createdTo = (string?)ViewBag.CreatedTo;
    var hasLog = (string?)ViewBag.HasLog;

    int? supplierId = (int?)ViewBag.SupplierId;
    int? platformId = (int?)ViewBag.PlatformId;
    int? merchTypeId = (int?)ViewBag.MerchTypeId;
    string gameType = (string)(ViewBag.GameType ?? "");

    var suppliers = (IEnumerable<dynamic>?)ViewBag.SupplierList ?? Enumerable.Empty<dynamic>();
    var merchTypes = (IEnumerable<dynamic>?)ViewBag.MerchTypeList ?? Enumerable.Empty<dynamic>();
    var platforms = (IEnumerable<dynamic>?)ViewBag.PlatformList ?? Enumerable.Empty<dynamic>();
}

@if (ViewBag.ModelErrors != null)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var err in ViewBag.ModelErrors)
            {
                <li><strong>@err.Key</strong>:
                    @foreach (var msg in err.Errors)
                    {
                        @msg <br />
                    }
                </li>
            }
        </ul>
    </div>

}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .page-card {
            border: 0;
            border-radius: 1rem;
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
            overflow: hidden
        }

        .table-wrap {
            border-radius: .75rem;
            overflow: hidden;
            border: 1px solid #e9ecef
        }

        .table {
            margin-bottom: 0
        }

            .table thead th {
                background: #f8fafc;
                vertical-align: middle
            }

        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: rgba(0,0,0,.02)
        }

        .dataTables_wrapper .dataTables_paginate {
            float: none !important;
            text-align: center !important
        }

            .dataTables_wrapper .dataTables_paginate .pagination {
                justify-content: center !important
            }

        .filter-row .form-label {
            font-size: .8rem;
            color: #6c757d;
            margin-bottom: .25rem
        }

        .filter-row .form-control, .filter-row .form-select {
            height: 38px
        }

        .link-quiet {
            color: var(--bs-primary);
            text-decoration: none
        }

            .link-quiet:hover {
                text-decoration: underline
            }

        .action-icons a {
            margin-left: .5rem;
            font-size: 1.1rem
        }

        .toast-container-center {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1080
        }
    </style>
}

<h2 class="mb-3">商品清單</h2>

<div class="card page-card mb-4">
    <div class="card-body">

        <!-- 檢視切換 -->
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div class="d-flex gap-2">
                <button id="btnShowTable" type="button" class="btn btn-outline-secondary"><i class="bi bi-table"></i> 表單</button>
                @* <button id="btnShowStrips" type="button" class="btn btn-outline-secondary"><i class="bi bi-view-stacked"></i> 寬版</button> *@
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-primary"
                   href="javascript:;"
                   data-modal-url="@Url.Action("Create", "ProductInfoes", new { area = "OnlineStore" })">
                    <i class="bi bi-plus-circle me-1"></i> 新增商品
                </a>
            </div>
        </div>

        <!-- 基本篩選（表單/寬版共用） -->
        <form method="get" class="row row-cols-1 row-cols-md-3 row-cols-lg-6 g-2 filter-row align-items-end mb-2">
            <div>
                <label class="form-label">名稱/類別 關鍵字</label>
                <input class="form-control" name="keyword" value="@keyword" placeholder="關鍵字" />
            </div>
            <div>
                <label class="form-label">類別</label>
                <select class="form-select" name="type">
                    <option value="">全部類別</option>
                    @foreach (var t in (IEnumerable<string>)ViewBag.TypeList)
                    {
                        <option value="@t" selected="@(currentType == t ? "selected" : null)">@t</option>
                    }
                </select>
            </div>
            <div>
                <label class="form-label">狀態</label>
                <select class="form-select" name="status">
                    <option value="active" selected="@(status == "active" ? "selected" : null)">上架</option>
                    <option value="inactive" selected="@(status == "inactive" ? "selected" : null)">下架</option>
                    <option value="all" selected="@(status == "all" ? "selected" : null)">全部</option>
                </select>
            </div>
            <div>
                <label class="form-label">建立日期</label>
                <div class="input-group">
                    <input type="date" class="form-control" name="createdFrom" value="@createdFrom" />
                    <span class="input-group-text">~</span>
                    <input type="date" class="form-control" name="createdTo" value="@createdTo" />
                </div>
            </div>
            <div>
                <label class="form-label">異動紀錄</label>
                <select class="form-select" name="hasLog">
                    <option value="" selected="@(string.IsNullOrEmpty(hasLog) ? "selected" : null)">全部</option>
                    <option value="yes" selected="@(hasLog == "yes" ? "selected" : null)">有異動</option>
                    <option value="no" selected="@(hasLog == "no" ? "selected" : null)">無異動</option>
                </select>
            </div>
            <div>
                <label class="form-label">顯示筆數</label>
                <select id="pageLenSelect" class="form-select">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="-1">全部</option>
                </select>
            </div>

            <div class="col-12 d-flex gap-2 mt-1 ">
                <button type="submit" class="btn btn-primary" ><i class="bi bi-search"></i> 套用條件</button>
                <button type="reset" id="btnClearFilters" class="btn btn-outline-secondary">
                    <i class="bi bi-eraser"></i> 清除條件
                </button>
            </div>
        </form>

        <!-- 寬版進階（只在寬版展開） -->
        <div class="collapse" id="advFilters">
            <form method="get" class="row row-cols-1 row-cols-md-3 row-cols-lg-6 g-2 filter-row align-items-end mb-2">
                <input type="hidden" name="keyword" value="@keyword" />
                <input type="hidden" name="type" value="@currentType" />
                <input type="hidden" name="status" value="@status" />

                <div>
                    <label class="form-label">供應商</label>
                    <select class="form-select" name="supplierId">
                        <option value="">全部</option>
                        @foreach (var s in suppliers)
                        {
                            <option value="@s.SupplierId" selected="@(supplierId == (int?)s.SupplierId ? "selected" : null)">@s.SupplierName</option>
                        }
                    </select>
                </div>
                <div>
                    <label class="form-label">平台（game）</label>
                    <select class="form-select" name="platformId">
                        <option value="">全部</option>
                        @foreach (var p in platforms)
                        {
                            <option value="@p.PlatformId" selected="@(platformId == (int?)p.PlatformId ? "selected" : null)">@p.PlatformName</option>
                        }
                    </select>
                </div>
                <div>
                    <label class="form-label">分類（notgame）</label>
                    <select class="form-select" name="merchTypeId">
                        <option value="">全部</option>
                        @foreach (var m in merchTypes)
                        {
                            <option value="@m.MerchTypeId" selected="@(merchTypeId == (int?)m.MerchTypeId ? "selected" : null)">@m.MerchTypeName</option>
                        }
                    </select>
                </div>
                <div>
                    <label class="form-label">遊戲種類（game）</label>
                    <input class="form-control" name="gameType" value="@gameType" placeholder="例：RPG / ACT">
                </div>

                <div class="col-12 d-flex gap-2 mt-1">
                    <button type="submit" class="btn btn-outline-primary"><i class="bi bi-funnel"></i> 套用進階</button>
                    <a class="btn btn-outline-secondary" href="@Url.Action("Index", "ProductInfoes", new { area = "OnlineStore" })"><i class="bi bi-x-circle"></i> 清除進階</a>
                </div>
            </form>
        </div>

        <!-- 表格檢視 -->
        <div id="listHost" class="table-wrap">
            <table id="productTable" class="table table-striped table-hover table-bordered align-middle">
                <thead>
                    <tr>
                        <th style="width:80px;">商品ID</th>
                        <th style="width:120px;">商品代碼</th>
                        <th>名稱</th>
                        <th style="width:70px;" class="text-center">詳細</th>
                        <th>類別</th>
                        <th class="text-end">價格</th>
                        <th class="text-center">存量</th>
                        <th class="text-center">狀態</th>
                        <th>建立時間</th>
                        <th>最後異動</th>
                        <th style="width:160px;" class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var x in Model)
                    {
                        <tr data-id="@x.ProductId">
                            <td data-order="@x.ProductId">#@x.ProductId</td>
                            <td data-order="@(x.ProductCodeSort?.ToString() ?? "2147483647")">@x.ProductCode</td>
                            <td>@x.ProductName</td>
                            <td class="text-center">
                                <a href="javascript:;" title="Info + Detail"
                                   data-modal-url="@Url.Action("DetailModal", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                            </td>
                            <td>@x.ProductType</td>
                            <td class="text-end">@x.Price.ToString("N0")</td>
                            <td class="text-center">@x.ShipmentQuantity</td>
                            <td class="text-center">
                                @Html.Raw(x.IsActive ? "<span class=\"badge bg-success\">上架</span>" : "<span class=\"badge bg-secondary\">下架</span>")
                            </td>
                            <td>@x.ProductCreatedAt.ToString("yyyy/MM/dd tt hh:mm")</td>
                            <td>
                                @if (x.LastLog is not null)
                                {
                                    <a href="javascript:;" class="link-quiet"
                                       data-modal-url="@Url.Action("AuditLog", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                                        @x.LastLog.ChangedAt.ToString("yyyy/MM/dd tt hh:mm")
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted small">—</span>
                                }
                            </td>
                            <td class="text-end action-icons">
                                @* <a href="javascript:;" class="text-info" title="詳細"
                                   data-modal-url="@Url.Action("DetailModal", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                                    <i class="bi bi-aspect-ratio"></i>
                                </a> *@
                                <a href="javascript:;" class="text-success" title="編輯"
                                   data-modal-url="@Url.Action("Edit", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="javascript:;" class="text-danger" title="下架"
                                   data-modal-url="@Url.Action("Delete", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                                    <i class="bi bi-trash"></i>
                                </a>
                                <a href="javascript:;" class="text-secondary" title="異動紀錄"
                                   data-modal-url="@Url.Action("AuditLog", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                                    <i class="bi bi-clock-history"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- 寬版容器 -->
        <div id="stripsHost" class="d-none"></div>

    </div>
</div>

<!-- Anti-Forgery Token（AJAX 用） -->
<form id="__af" method="post">@Html.AntiForgeryToken()</form>

<!-- 通用 Modal Host -->
<div class="modal fade" id="modalHost" tabindex="-1" aria-hidden="true"></div>

<!-- Toast -->
<div class="toast-container-center">
    <div id="mainToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">已完成</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- 建議把 Toast 容器放在 _Layout（一次就好）；暫時也可放 Index 頁最底下 -->
<div id="toastHost" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080">
  <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
    <div class="d-flex">
      <div class="toast-body" id="toastErrorBody">😿 發生錯誤</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mt-2" role="alert" aria-live="polite" aria-atomic="true" data-bs-delay="2500">
    <div class="d-flex">
      <div class="toast-body" id="toastSuccessBody">🎉 成功！</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>



@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        (() => {
          // 取得 URL 參數
          const getParam = k => new URL(location.href).searchParams.get(k);

          // DataTables 初始化（只關閉「詳細」欄排序）
          const initLen = parseInt(getParam('len') ?? localStorage.getItem('product.len') ?? '10', 10);
          const dt = $('#productTable').DataTable({
            searching: false,
            ordering:  true,
            order:     [[0,'desc']],
            pageLength: isNaN(initLen) ? 10 : initLen,
            lengthMenu: [[10,20,30,50,100,-1],[10,20,30,50,100,'全部']],
            language: {
              emptyTable: "沒有資料",
              info: "第 _PAGE_ 頁，共 _PAGES_ 頁（共 _TOTAL_ 筆）",
              infoEmpty: "顯示第 0 到 0 筆，共 0 筆",
              lengthMenu: "每頁顯示 _MENU_ 筆",
              loadingRecords: "載入中...",
              processing: "處理中...",
              zeroRecords: "查無符合資料",
              paginate:{ first:"第一頁", last:"最後一頁", next:"下一頁", previous:"上一頁" }
            },
            dom: "t<'row mt-3'<'col-12'p>>",
            columnDefs: [{ targets:[3], orderable:false }] // 只把「詳細」欄關閉排序
          });

          // 顯示筆數下拉
          const pageLenSel = document.getElementById('pageLenSelect');
          if (pageLenSel) {
            pageLenSel.value = String(dt.page.len());
            pageLenSel.addEventListener('change', e => {
              const v = parseInt(e.target.value,10);
              dt.page.len(v).draw(false);
              localStorage.setItem('product.len', String(v));
              const url = new URL(location.href);
              url.searchParams.set('len', String(v));
              history.replaceState(null,'',url);
            });
          }

          // 清除基本條件：改為導回 Index（可保留每頁筆數 len）
          const clearBtn = document.getElementById('btnClearFilters');
          clearBtn?.addEventListener('click', e => {
            e.preventDefault();
            const len = dt.page.len();
            const base = '@Url.Action("Index", "ProductInfoes", new { area = "OnlineStore" })';
            window.location = len && len !== 10 ? (base + '?len=' + encodeURIComponent(len)) : base;
          });

          // Toast
          const showToast = (msg, ok=true) => {
            const el = document.getElementById('mainToast');
            const body = document.getElementById('mainToastBody');
            body.textContent = msg || (ok ? '已完成' : '處理失敗');
            el.classList.toggle('bg-success', ok);
            el.classList.toggle('bg-danger', !ok);
            new bootstrap.Toast(el, { delay: 2000 }).show();
          };

          // 寬版載入/切換 + 自動展開進階
          const listHost = document.getElementById('listHost');
          const stripsHost = document.getElementById('stripsHost');
          const adv = document.getElementById('advFilters');
          const advCollapse = adv ? new bootstrap.Collapse(adv, { toggle:false }) : null;
          let stripsLoaded = false;

          async function showStrips(){
            if(!stripsLoaded){
              const url = '@Url.Action("Strips", "ProductInfoes", new { area = "OnlineStore" })' + window.location.search;
              const html = await (await fetch(url, { credentials:'include' })).text();
              stripsHost.innerHTML = html; stripsLoaded = true;
            }
            listHost.classList.add('d-none');
            stripsHost.classList.remove('d-none');
            advCollapse?.show();
          }
          function showTable(){
            stripsHost.classList.add('d-none');
            listHost.classList.remove('d-none');
            advCollapse?.hide();
          }
          document.getElementById('btnShowStrips')?.addEventListener('click', showStrips);
          document.getElementById('btnShowTable')?.addEventListener('click', showTable); // ← 這裡不能有空白

          // 通用：點 data-modal-url → 載入 Partial 至通用 Modal
          document.addEventListener('click', async ev => {
            const a = ev.target.closest('[data-modal-url]');
            if (!a) return;
            ev.preventDefault();
            const res  = await fetch(a.getAttribute('data-modal-url'), { credentials:'include' });
            const html = await res.text();
            const host = document.getElementById('modalHost');
            host.innerHTML = html;
            // 若有 MVC Unobtrusive 驗證
            if (window.jQuery && $.validator && $.validator.unobtrusive) {
              $.validator.unobtrusive.parse($('#modalHost'));
            }
            new bootstrap.Modal(host).show();
            host.querySelectorAll('form.js-ajax-form').forEach(f => f.addEventListener('submit', submitAjaxOnce));
          });

          // Modal 內 Ajax 表單（Create/Edit/Delete）
          async function submitAjaxOnce(ev){
            ev.preventDefault();
            const form = ev.currentTarget;
            if (form.dataset.submitting === '1') return;
            form.dataset.submitting = '1';
            try {
              const res = await fetch(form.action, { method:'POST', body:new FormData(form), credentials:'include' });
              const ct  = res.headers.get('content-type') || '';
              if (ct.includes('application/json')) {
                const json = await res.json();
                showToast(json.msg || '已完成', json.ok);
                if (json.ok) setTimeout(() => location.reload(), 600);
              } else {
                const host = document.getElementById('modalHost');
                host.innerHTML = await res.text();
                if (window.jQuery && $.validator && $.validator.unobtrusive) {
                  $.validator.unobtrusive.parse($('#modalHost'));
                }
                host.querySelectorAll('form.js-ajax-form').forEach(f => f.addEventListener('submit', submitAjaxOnce));
              }
            } finally {
              form.dataset.submitting = '0';
            }
          }
        })();
    </script>
    <script>
(function(){
  // 代理監聽：當 modal 內容替換（Create/Edit），仍可抓到 form
  document.addEventListener('submit', async function(e){
    const form = e.target;
    if (!form.classList.contains('js-ajax-form')) return;

    e.preventDefault();

    const fd = new FormData(form);
    const action = form.getAttribute('action') || location.href;
    const method = (form.getAttribute('method') || 'post').toUpperCase();

    try {
      const resp = await fetch(action, { method, body: fd });
      const data = await resp.json();  // 你的 Create/Edit 都回 JSON
      if (data && data.ok) {
        // 成功 → 跳成功 toast、關 modal、再刷新清單
        showToast('toastSuccess', data.msg || '已儲存成功！');
        const modalEl = form.closest('.modal');
        if (modalEl) {
          bootstrap.Modal.getOrCreateInstance(modalEl).hide();  // 官方建議 API
        }
        // TODO：重載列表（依你的實作）
        // e.g. reloadProductTable();
      } else {
        // 後端回傳失敗 → 顯示錯誤
        showToast('toastError', (data && data.msg) ? data.msg : '儲存失敗');
      }
    } catch (err) {
      showToast('toastError', '連線或伺服器錯誤，請稍後再試');
    }
  });

  // 簡單的 toast helper
  window.showToast = function(id, msg){
    const el = document.getElementById(id);
    if (!el) return;
    const body = el.querySelector('.toast-body');
    if (body && msg) body.textContent = msg;
    bootstrap.Toast.getOrCreateInstance(el).show(); // 官方 JS API
  };
})();
</script>

}


