@model IEnumerable<dynamic>

@{
    string keyword = (string)(ViewBag.Keyword ?? "");
    string type = (string)(ViewBag.Type ?? "");
    string status = (string)(ViewBag.Status ?? "all");
    int? supplierId = (int?)ViewBag.SupplierId;
    int? platformId = (int?)ViewBag.PlatformId;
    int? merchTypeId = (int?)ViewBag.MerchTypeId;
    string gameType = (string)(ViewBag.GameType ?? "");

    int page = (int)(ViewBag.Page ?? 1);
    int pageSize = (int)(ViewBag.PageSize ?? 12);
    int total = (int)(ViewBag.Total ?? 0);

    var typeList = (IEnumerable<string>)(ViewBag.TypeList ?? Enumerable.Empty<string>());
    var suppliers = (IEnumerable<dynamic>)(ViewBag.SupplierList ?? Enumerable.Empty<dynamic>());
    var platforms = (IEnumerable<dynamic>)(ViewBag.PlatformList ?? Enumerable.Empty<dynamic>());
    var merchTypes = (IEnumerable<dynamic>)(ViewBag.MerchTypeList ?? Enumerable.Empty<dynamic>());
}

<div class="container-fluid">

    <!-- 篩選列（直接撈 Strips 以保持局部刷新） -->
    <form method="get" action="@Url.Action("Strips","ProductInfoes", new { area="OnlineStore" })" class="row g-2 align-items-end mb-3">
        <div class="col-lg-3 col-md-4">
            <label class="form-label">關鍵字</label>
            <input type="text" name="keyword" value="@keyword" class="form-control" placeholder="輸入商品名稱或代碼">
        </div>
        <div class="col-lg-2 col-md-3">
            <label class="form-label">類別</label>
            <select name="type" class="form-select">
                <option value="">全部</option>
                @foreach (var t in typeList)
                {
                    <option value="@t" selected="@(type == t)">@t</option>
                }
            </select>
        </div>
        <div class="col-lg-2 col-md-3">
            <label class="form-label">狀態</label>
            <select name="status" class="form-select">
                <option value="all" selected="@(status == "all")">全部</option>
                <option value="active" selected="@(status == "active")">上架</option>
                <option value="inactive" selected="@(status == "inactive")">下架</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-3">
            <label class="form-label">供應商</label>
            <select name="supplierId" class="form-select">
                <option value="">全部</option>
                @foreach (var s in suppliers)
                {
                    <option value="@s.SupplierId" selected="@(supplierId == (int?)s.SupplierId)">@s.SupplierName</option>
                }
            </select>
        </div>
        <div class="col-lg-2 col-md-3">
            <label class="form-label">平台（game）</label>
            <select name="platformId" class="form-select">
                <option value="">全部</option>
                @foreach (var p in platforms)
                {
                    <option value="@p.PlatformId" selected="@(platformId == (int?)p.PlatformId)">@p.PlatformName</option>
                }
            </select>
        </div>
        <div class="col-lg-2 col-md-3">
            <label class="form-label">遊戲種類（game）</label>
            <input type="text" name="gameType" value="@gameType" class="form-control" placeholder="RPG、ACT...">
        </div>
        <div class="col-lg-2 col-md-3">
            <label class="form-label">周邊分類（notgame）</label>
            <select name="merchTypeId" class="form-select">
                <option value="">全部</option>
                @foreach (var m in merchTypes)
                {
                    <option value="@m.MerchTypeId" selected="@(merchTypeId == (int?)m.MerchTypeId)">@m.MerchTypeName</option>
                }
            </select>
        </div>

        <div class="col-lg-2 col-md-3">
            <label class="form-label">每頁顯示</label>
            <select name="pageSize" class="form-select" onchange="this.form.submit()">
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="12" selected="@(pageSize == 12)">12</option>
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
                <option value="100" selected="@(pageSize == 100)">100</option>
            </select>
        </div>

        <div class="col-12 mt-1">
            <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> 套用條件</button>
            <a class="btn btn-outline-secondary" href="@Url.Action("Strips", "ProductInfoes", new { area = "OnlineStore" })"><i class="bi bi-eraser"></i> 清除</a>
        </div>
    </form>

    <!-- 表頭 -->
    <div class="row fw-bold border-bottom py-2 mb-2 text-muted">
        <div class="col-1">ID</div>
        <div class="col-2">圖片</div>
        <div class="col-3">商品名稱</div>
        <div class="col-4">詳細資料</div>
        <div class="col-2 text-end">操作</div>
    </div>

    <!-- 清單內容 -->
    @foreach (var x in Model)
    {
        <div class="row align-items-center border rounded-3 shadow-sm mb-2 py-2 strip-item">
            <!-- ID -->
            <div class="col-1 text-muted">#@x.ProductId</div>

            <!-- 圖片 + 全部圖片 -->
            <div class="col-2">
                <img src="@(x.ImageUrl ?? "/img/noimage.png")"
                     alt="@Convert.ToString(x.ProductName)"
                     class="rounded border"
                     style="width:80px;height:80px;object-fit:cover;">
                <div class="mt-1">
                    <a href="javascript:;" data-modal-url="@Url.Action("ImagesModal", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })" class="small">顯示全部圖片</a>
                </div>
            </div>

            <!-- 商品名稱 -->
            <div class="col-3">
                <div class="fw-bold">@Convert.ToString(x.ProductName)</div>
                <div class="small text-muted mt-1">
                    @if (!string.IsNullOrWhiteSpace(Convert.ToString(x.ProductCode)))
                    {
                        <span class="badge bg-light text-dark border"> @("#" + Convert.ToString(x.ProductCode)) </span>
                    }
                    <span class="badge bg-secondary ms-1">@Convert.ToString(x.ProductType)</span>
                    @if ((bool)x.IsActive)
                    {
                        <span class="badge bg-success ms-1 js-active-cell">上架</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary ms-1 js-active-cell">下架</span>
                    }
                </div>
            </div>

            <!-- 詳細資料 -->
            <div class="col-4 small text-muted">
                <span>售價：@((decimal)x.Price)</span>
                @if (!string.IsNullOrWhiteSpace(Convert.ToString(x.SupplierName)))
                {
                    <span class="mx-1 text-secondary">|</span>
                    <span>供應商：@Convert.ToString(x.SupplierName)</span>
                }
                @if (!string.IsNullOrWhiteSpace(Convert.ToString(x.PlatformName)))
                {
                    <span class="mx-1 text-secondary">|</span>
                    <span>平台：@Convert.ToString(x.PlatformName)</span>
                }
                @if (!string.IsNullOrWhiteSpace(Convert.ToString(x.GameType)))
                {
                    <span class="mx-1 text-secondary">|</span>
                    <span>類型：@Convert.ToString(x.GameType)</span>
                }
                @if (!string.IsNullOrWhiteSpace(Convert.ToString(x.MerchTypeName)))
                {
                    <span class="mx-1 text-secondary">|</span>
                    <span>分類：@Convert.ToString(x.MerchTypeName)</span>
                }
                <br />
                <span>建立：@(((DateTime)x.ProductCreatedAt).ToString("yyyy/MM/dd HH:mm"))</span>
                @if (x.LastChangedAt != null)
                {
                    <span class="mx-1 text-secondary">|</span>
                    <span>最後異動：@(((DateTime)x.LastChangedAt).ToString("yyyy/MM/dd HH:mm"))</span>
                }
            </div>

            <!-- 操作（三顆） -->
            <div class="col-2 text-end">
                <a href="javascript:;" class="text-primary me-2" title="編輯"
                   data-modal-url="@Url.Action("Edit", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                    <i class="bi bi-pencil-square fs-5"></i>
                </a>
                <a href="javascript:;" class="text-danger me-2" title="下架"
                   data-modal-url="@Url.Action("Delete", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                    <i class="bi bi-trash fs-5"></i>
                </a>
                <a href="javascript:;" class="text-secondary" title="修改紀錄"
                   data-modal-url="@Url.Action("AuditLog", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                    <i class="bi bi-clock-history fs-5"></i>
                </a>
            </div>
        </div>
    }

    <!-- 簡易分頁 -->
    @{
        int pageCount = (int)Math.Ceiling(total / (double)pageSize);
        string qsBase(string key, object? val)
        {
            var dict = new Dictionary<string, string?>
            {
                ["keyword"] = keyword,
                ["type"] = type,
                ["status"] = status,
                ["supplierId"] = supplierId?.ToString(),
                ["platformId"] = platformId?.ToString(),
                ["merchTypeId"] = merchTypeId?.ToString(),
                ["gameType"] = gameType,
                ["pageSize"] = pageSize.ToString()
            };
            dict[key] = val?.ToString();

            var arr = dict.Where(kv => !string.IsNullOrWhiteSpace(kv.Value))
            .Select(kv => $"{kv.Key}={Uri.EscapeDataString(kv.Value!)}");
            return "?" + string.Join("&", arr);
        }
    }
    <nav class="mt-3">
        <ul class="pagination pagination-sm justify-content-center">
            <li class="page-item @(page <= 1 ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Strips", "ProductInfoes", new { area = "OnlineStore" })@qsBase("page", page - 1)">上一頁</a>
            </li>
            <li class="page-item disabled">
                <span class="page-link">第 @(page) / @pageCount 頁（共 @total 筆）</span>
            </li>
            <li class="page-item @(page >= pageCount ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Strips", "ProductInfoes", new { area = "OnlineStore" })@qsBase("page", page + 1)">下一頁</a>
            </li>
        </ul>
    </nav>
</div>
