@model GameSpace.Areas.OnlineStore.ViewModels.ProductInfoFormVM

@{
    var suppliers = (IEnumerable<dynamic>)(ViewBag.SupplierList ?? Enumerable.Empty<dynamic>());
    var platforms = (IEnumerable<dynamic>)(ViewBag.PlatformList ?? Enumerable.Empty<dynamic>());
    var merchTypes = (IEnumerable<dynamic>)(ViewBag.MerchTypeList ?? Enumerable.Empty<dynamic>());
    var gameTypes = (IEnumerable<string>)(ViewBag.GameTypeList ?? Enumerable.Empty<string>());
    var currencies = (IEnumerable<string>)(ViewBag.CurrencyList ?? new[] { "TWD", "USD" });

    var sizeList = (IEnumerable<string>)(ViewBag.SizeList ?? Enumerable.Empty<string>());
    var colorList = (IEnumerable<string>)(ViewBag.ColorList ?? Enumerable.Empty<dynamic>());
    var weightList = (IEnumerable<string>)(ViewBag.WeightList ?? Enumerable.Empty<dynamic>());
    var dimensionsList = (IEnumerable<string>)(ViewBag.DimensionsList ?? Enumerable.Empty<dynamic>());
    var materialList = (IEnumerable<string>)(ViewBag.MaterialList ?? Enumerable.Empty<dynamic>());

    var isEdit = (string)(ViewBag.Mode ?? "create") == "edit";
    bool hasType = !string.IsNullOrWhiteSpace(Model.ProductType);
}

@if (ViewBag.ModelErrors != null)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var err in ViewBag.ModelErrors)
            {
                <li><strong>@err.Key</strong>:
                    @foreach (var msg in err.Errors)
                    {
                        @msg <br />
                    }
                </li>
            }
        </ul>
    </div>
}

@section Styles {
    <style>
        /* 保留你原有樣式 */
        fieldset[disabled] {
            pointer-events: none;
            opacity: .6;
        }
        .thumb {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
        }
        .snapshot-box {
            background: #f8f9fa;
            padding: 10px;
            border: 1px dashed #ccc;
            font-size: 0.9rem;
        }

        .modal-dialog.modal-xxl-custom {
            max-width: 95%;
        }

        .modal-dialog-centered {
          min-height: calc(100vh - var(--bs-modal-margin) * 2);
        }

        .modal-dialog.modal-dialog-scrollable .modal-content {
          max-height: calc(100vh - var(--bs-modal-margin) * 2);
          display: flex;
          flex-direction: column;
        }

        .modal-dialog.modal-dialog-scrollable .modal-body {
          overflow: auto;
        }
    </style>
}

<div class="modal-dialog modal-dialog-centered modal-xxl-custom" style="max-width:55vw;">
    <div class="modal-content shadow-lg">
        <div class="modal-header bg-light">
            <h5 class="modal-title">@((isEdit ? "編輯商品" : "新增商品"))</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form class="js-ajax-form" method="post"
              action="@Url.Action(isEdit? "Edit":"Create","ProductInfoes", new { area="OnlineStore" })"
              enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            @if (isEdit)
            {
                @Html.HiddenFor(m => m.ProductId)
            }

            <div class="modal-body">

                <!-- 商品名稱 + 類別 + 基本資訊 -->
                <div class="row g-3 mb-3 align-items-center">
                    <div class="col-md-8">
                        <label class="form-label">商品名稱 *</label>
                        @Html.TextBoxFor(m => m.ProductName, new {
                            @class = "form-control",
                            @data_bs_toggle = "tooltip",
                            title = "在這裡寫提示：商品名稱"
                        })
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">類別 *</label>
                    <select id="productType" name="ProductType" class="form-select"
                            data-bs-toggle="tooltip" title="在這裡寫提示：先選擇類別">
                        <option value="">請先選擇類別</option>
                        <option value="game"   selected="@(Model.ProductType == "game")">game</option>
                        <option value="notgame" selected="@(Model.ProductType == "notgame")">notgame</option>
                    </select>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label">供應商 *</label>
                        <select name="SupplierId" class="form-select" data-bs-toggle="tooltip" title="在這裡寫提示：供應商">
                            <option value="">請選擇</option>
                            @foreach (var s in suppliers)
                            {
                                <option value="@s.SupplierId" selected="@(Model.SupplierId == (int?)s.SupplierId)">
                                    @s.SupplierName
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">幣別 *</label>
                        <select name="CurrencyCode" class="form-select" data-bs-toggle="tooltip" title="在這裡寫提示：幣別">
                            @foreach (var c in currencies)
                            {
                                <option value="@c" selected="@(Model.CurrencyCode == c)">@c</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">價格 *</label>
                        @Html.TextBoxFor(m => m.Price, new {
                            @class = "form-control",
                            type = "number", min = "0",
                            @data_bs_toggle = "tooltip",
                            title = "免費遊戲類別的允許價錢為0"
                        })
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">數量 *</label>
                        @Html.TextBoxFor(m => m.ShipmentQuantity, new {
                            @class = "form-control",
                            type = "number", min = "0",
                            @data_bs_toggle = "tooltip",
                            title = "下載型遊戲；沒上限請輸入:0"
                        })
                    </div>

                    <div class="col-md-4 d-flex align-items-center">
                        <input type="hidden" name="IsActive" value="false" />
                        <input type="checkbox" class="form-check-input" id="chkIsActive" name="IsActive" value="true"
                               @(Model.IsActive || !isEdit ? "checked" : "") />
                        <label class="form-check-label ms-1" for="chkIsActive"
                               data-bs-toggle="tooltip" >上架</label>
                    </div>
                </div>

                <!-- 插入：平台 + hidden 的區塊 -->
                @if (Model.ProductType == "game")
                {
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">平台 *</label>

                           <select id="PlatformId" class="form-select" disabled>
                                @foreach (var p in platforms)
                                {
                                    if (Model.PlatformId == (int?)p.PlatformId)
                                    {
                                        @:<option value="@p.PlatformId" selected="selected">@p.PlatformName</option>
                                    }
                                    else
                                    {
                                        @:<option value="@p.PlatformId">@p.PlatformName</option>
                                    }
                                }
                                </select>

                                <input type="hidden" name="PlatformId" value="@(Model.PlatformId)" />

                            <span class="text-danger">
                                @Html.ValidationMessage("PlatformId", null, new { @class = "text-danger" })
                            </span>
                        </div>
                    </div>
                }

                <!-- 接下來遊戲類型 GameType + DownloadLink + 描述等 -->
                <fieldset id="fsGame" class="border rounded p-3 mb-3">
                    <legend class="float-none w-auto px-2 small">Game Detail</legend>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">遊戲類型</label>
                            <input type="text" name="GameType" class="form-control"
                                   value="@(Model.GameType ?? "")" list="gameTypeList"
                                   data-bs-toggle="tooltip" />
                            <datalist id="gameTypeList">
                                @foreach (var gt in gameTypes) { <option value="@gt"></option> }
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">下載網址</label>
                            @Html.TextBoxFor(m => m.DownloadLink, new {
                                @class = "form-control",
                                type = "url",
                                placeholder = "https://...",
                                @data_bs_toggle = "tooltip",
                                title = "在這裡寫提示：下載網址"
                            })
                            <div class="form-text">若提供可下載版本，可填入 URL。</div>
                        </div>
                    </div>
                    <div class="mb-3 mt-2">
                        <label class="form-label">遊戲描述</label>
                        @Html.TextAreaFor(m => m.GameProductDescription, new {
                            @class = "form-control",
                            @data_bs_toggle = "tooltip",
                            title = "在這裡寫提示：遊戲描述"
                        })
                    </div>
                </fieldset>

                <!-- 周邊商品 NotGame 的欄位保持原樣 -->
                <fieldset id="fsOther" class="border rounded p-3 mb-3">
                    <legend class="float-none w-auto px-2 small">NotGame Detail</legend>

                    <div class="mb-3">
                        <label class="form-label">商品種類</label>
                        <select asp-for="MerchTypeId"
                                asp-items="@(new SelectList(merchTypes, "MerchTypeId", "MerchTypeName", Model.MerchTypeId))"
                                class="form-select"
                                data-bs-toggle="tooltip"
                                title="在這裡寫提示：商品種類">
                            <option value="">請選擇種類</option>
                        </select>
                    </div>

                    <div class="row g-3">
                        <!-- 你的 size, color, weight, dimensions, material, stock 等欄位 -->
                        <div class="col-md-3">
                            <label class="form-label">尺寸</label>
                            @Html.TextBoxFor(m => m.Size, new {
                                @class="form-control", list="sizeList", placeholder="例如 S / 350ml",
                                @data_bs_toggle="tooltip", title="在這裡寫提示：尺寸"
                            })
                            <datalist id="sizeList">@foreach (var v in sizeList){ <option value="@v"></option> }</datalist>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">顏色</label>
                            @Html.TextBoxFor(m => m.Color, new {
                                @class="form-control", list="colorList", placeholder="例如 黑 / 白",
                                @data_bs_toggle="tooltip", title="在這裡寫提示：顏色"
                            })
                            <datalist id="colorList">@foreach (var v in colorList){ <option value="@v"></option> }</datalist>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">重量</label>
                            @Html.TextBoxFor(m => m.Weight, new {
                                @class="form-control", list="weightList", placeholder="例如 220g",
                                @data_bs_toggle="tooltip", title="在這裡寫提示：重量"
                            })
                            <datalist id="weightList">@foreach (var v in weightList){ <option value="@v"></option> }</datalist>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">尺寸(mm/cm)</label>
                            @Html.TextBoxFor(m => m.Dimensions, new {
                                @class="form-control", list="dimensionsList", placeholder="例如 29.7x21.0 cm",
                                @data_bs_toggle="tooltip", title="在這裡寫提示：尺寸(mm/cm)"
                            })
                            <datalist id="dimensionsList">@foreach (var v in dimensionsList){ <option value="@v"></option> }</datalist>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">材質</label>
                            @Html.TextBoxFor(m => m.Material, new {
                                @class="form-control", list="materialList", placeholder="例如 棉 / ABS",
                                @data_bs_toggle="tooltip", title="在這裡寫提示：材質"
                            })
                            <datalist id="materialList">@foreach (var v in materialList){ <option value="@v"></option> }</datalist>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">庫存數量</label>
                            @Html.TextBoxFor(m => m.StockQuantity, new {
                                @class="form-control", type="number", min="0",
                                @data_bs_toggle="tooltip", title="在這裡寫提示：庫存數量"
                            })
                        </div>
                    </div>

                    <div class="mb-3 mt-3">
                        <label class="form-label">周邊商品描述</label>
                        @Html.TextAreaFor(m => m.OtherProductDescription, new {
                            @class = "form-control", rows = 3,
                            @data_bs_toggle = "tooltip", title = "在這裡寫提示：周邊商品描述"
                        })
                    </div>
                </fieldset>

                <!-- 圖片上傳等後面的欄位保留不動 -->
                <div class="border rounded p-3 mb-3">
                    <h6>商品圖片</h6>

                    @if (isEdit)
                    {
                        if (!string.IsNullOrEmpty(Model.ProductImageUrl))
                        {
                            <div class="mb-2">
                                <img class="thumb" src="@Model.ProductImageUrl" alt="商品圖片" />
                            </div>
                            <div class="text-muted small mb-2">目前圖片（可選擇更換）</div>
                        }
                        <input type="file" name="Image" class="form-control" accept="image/*"
                                data-bs-toggle="tooltip" title="選擇新檔案可覆蓋現有圖片（不選就維持原圖）" />
                    }
                    else
                    {
                        <input type="file" name="Image" class="form-control" accept="image/*"
                                data-bs-toggle="tooltip" title="新增商品需上傳一張圖片" />
                    }
                </div>

                @if (isEdit)
                {
                    <div class="text-muted small">
                        創立時間: @Model.ProductCreatedAt.ToString("yyyy/MM/dd HH:mm")<br />
                        最後異動時間: @(Model.ProductUpdatedAt?.ToString("yyyy/MM/dd HH:mm") ?? "-")
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="submit" class="btn btn-primary">儲存</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // 在提交之前把 disabled 的 select 解鎖（避免不送值）
        document.addEventListener('submit', function (e) {
            var form = e.target.closest('form.js-ajax-form');
            if (!form) return;
            var sel = form.querySelector('#PlatformId');
            if (sel && sel.disabled) {
                sel.disabled = false;
            }
        });
    </script>

    @* 你原有的 tooltips / ajax submit 部分 保留 *@
}
