@* =======================================================================
   _Composer.cshtml — 工單對話輸入區（前/後台通用）

   ★ 本版維持：
     - 送出按鈕 type="button"（避免表單原生 submit）
     - Enter 送出 / Shift+Enter 換行（IME 組字中不送）
     - 不主動 AJAX；由父頁監聽 #btn-send click 處理送出
   ======================================================================= *@

@model int
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

<div class="d-flex gap-2 align-items-start" id="gp-support-composer">
    <textarea id="msg-text" class="form-control" rows="2" maxlength="255"
              placeholder="輸入訊息…" aria-label="訊息內容（最多 255 字）"></textarea>

    <div class="d-flex flex-column align-items-end" style="min-width: 110px;">
        <button id="btn-send" type="button" class="btn btn-primary" data-ticket-id="@Model">送出</button>
        <small class="text-muted mt-1"><span id="msg-count">0</span>/255</small>
    </div>
</div>

<!-- Anti-forgery：父頁可直接讀取 -->
<input type="hidden" id="af-token"
       value="@Antiforgery.GetAndStoreTokens(ViewContext.HttpContext).RequestToken" />

<script>
    (() => {
      const root = document.getElementById('gp-support-composer');
      const ta   = root.querySelector('#msg-text');
      const btn  = root.querySelector('#btn-send');
      const cnt  = root.querySelector('#msg-count');
      const MAX  = 255;

      let composing = false;

      function update(){
        let v = ta.value || '';
        if (v.length > MAX) { ta.value = v.slice(0, MAX); v = ta.value; }
        cnt.textContent = v.length;
        const near = v.length >= MAX - 10;
        cnt.parentElement.classList.toggle('text-danger', near);
        cnt.parentElement.classList.toggle('text-muted', !near);
        btn.disabled = v.trim().length === 0;
      }

      ta.addEventListener('input', update);
      ta.addEventListener('paste', ()=> setTimeout(update, 0));
      ta.addEventListener('compositionstart', ()=> composing = true);
      ta.addEventListener('compositionend',  ()=> composing = false);
      ta.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey && !composing){
          e.preventDefault();
          btn.click(); // 交由父頁 click 監聽送出
        }
      });

      // 不在此處 AJAX；交由父頁處理
      btn.addEventListener('click', ()=> {
        // 可選：派發事件讓父頁攔截使用
        const text = (ta.value || '').trim();
        if(!text || text.length > MAX) { update(); return; }
        root.dispatchEvent(new CustomEvent('gp-support-send', {
          bubbles: true,
          detail: { ticketId: +(btn.dataset.ticketId||0), text,
            token: document.getElementById('af-token')?.value || '' }
        }));
      });

      update();
    })();
</script>
