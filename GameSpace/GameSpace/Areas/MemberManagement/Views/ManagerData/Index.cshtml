@model IEnumerable<GameSpace.Areas.MemberManagement.Models.ManagerDatumVM>

@{
    ViewData["Title"] = "GameSpace";
    var totalManagerId = Model?.Select(m => m.ManagerId).Distinct().Count() ?? 0;

    // 🟡 取回目前搜尋值以便回填
    int? currentManagerId = ViewBag.ManagerId as int?;
   


    // 由 Controller 的 ViewBag 帶入目前的查詢/排序狀態
    int? currentId = ViewBag.ManagerId as int?;
    string currentName = ViewBag.ManagerName as string;
    string sortBy = (ViewBag.SortBy as string) ?? "id";      // id | date
    string sortDir = (ViewBag.SortDir as string) ?? "asc";   // asc | desc

    // 計算下一次點擊時的排序方向（同欄位切換方向、換欄位預設升冪）
    string nextIdDir = (sortBy == "id" && sortDir == "asc") ? "desc" : "asc";
    string nextDateDir = (sortBy == "date" && sortDir == "asc") ? "desc" : "asc";

    var idArrow = sortBy == "id" ? (sortDir == "asc" ? "▲" : "▼") : "";
    var dateArrow = sortBy == "date" ? (sortDir == "asc" ? "▲" : "▼") : "";

    // ★ 保留側欄狀態（預設 admin）
    var sidebar = (string)(ViewBag.Sidebar ?? Context.Request.Query["sidebar"].ToString() ?? "admin");
}

<h1 class="d-flex align-items-center gap-3">
    管理者資訊
    <span class="mb-0 fw-normal">(總人數：@totalManagerId)</span>
</h1>

<!-- 搜尋表單（GET） -->
<form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-auto">
            <label for="managerId" class="form-label">管理者編號</label>
            <input id="managerId" name="managerId" type="number" class="form-control"
                   value="@(currentId?.ToString() ?? "")" placeholder="例如：10000001" />
        </div>
        <div class="col-auto">
            <label for="managerName" class="form-label">管理者姓名</label>
            <input id="managerName" name="managerName" type="text" class="form-control"
                   value="@(currentName ?? "")" placeholder="關鍵字" />
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">搜尋</button>
            <a asp-action="Index"
               asp-route-sidebar="@sidebar"
               class="btn btn-outline-secondary">清除</a>
        </div>
    </div>

    @* 搜尋時保留目前排序與側欄 *@
    <input type="hidden" name="sortBy" value="@sortBy" />
    <input type="hidden" name="sortDir" value="@sortDir" />
    <input type="hidden" name="sidebar" value="@sidebar" />
</form>

<table id="managersTable" class="table table-striped table-hover align-middle w-100">
    <thead>
        <tr>
            <th>管理者編號</th>
            <th>管理者姓名</th>
            <th>管理者帳號</th>
            <th>管理者信箱</th>
            <th>註冊日期</th>
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr><td colspan="5" class="text-center text-muted">沒有符合條件的資料</td></tr>
        }
        else
        {
            foreach (var item in Model)
            {
                <tr>
                    <td>@item.ManagerId</td>
                    <td>@item.ManagerName</td>
                    <td>@item.ManagerAccount</td>
                    <td>@item.ManagerEmail</td>
                    @* 用 data-order 放 ISO 格式，讓 DataTables 依真正日期值排序 *@
                    <td data-order="@item.AdministratorRegistrationDate?.ToString("O")">
                        @item.AdministratorRegistrationDate?.ToString("yyyy-MM-dd HH:mm")
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(function () {
            $('#managersTable').DataTable({
                searching: false,          // ← 關閉搜尋功能，同時不產生搜尋框
                columnDefs: [ { targets: [1,2,3], orderable: false } ],
                paging: true,
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                autoWidth: false,
                stateSave: true,                 // 記住使用者的每頁條數、搜尋字等
                order: [],                       // 不覆蓋你輸出的初始順序（需要預設排序再改成 [[0,'asc']] 等）
                language: {
                    search: "",                           // 移除「搜尋：」文字
                    searchPlaceholder: "輸入關鍵字…",      // 只留 placeholder
                    processing:   "處理中…",
                    lengthMenu:   "每頁顯示 _MENU_ 筆",
                    zeroRecords:  "沒有符合的結果",
                    info:         "第 _START_–_END_ 筆，共 _TOTAL_ 筆",
                    infoEmpty:    "顯示第 0–0 筆，共 0 筆",
                    infoFiltered: "(自 _MAX_ 筆資料中篩選)",
                    paginate: {
                        first:    "第一頁",
                        previous: "上一頁",
                        next:     "下一頁",
                        last:     "最後一頁"
                    }
                },
                // Bootstrap 5 版面配置（可依需求調整）
                dom:
                  "<'row'<'col-md-6'l><'col-md-6 text-md-end'f>>" +
                  "<'row'<'col-12'tr>>" +
                  "<'row'<'col-md-5'i><'col-md-7'p>>"
            });
        });
    </script>
}

