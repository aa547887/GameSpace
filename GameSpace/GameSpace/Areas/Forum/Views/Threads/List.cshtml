@model GameSpace.Areas.Forum.Models.ThreadsListVm
@{
    ViewData["Title"] = "主題列表";
    int totalPages = (int)Math.Ceiling((double)Model.Total / Model.Size);
    string Fmt(DateTime? dt) => dt?.ToLocalTime().ToString("yyyy/MM/dd HH:mm") ?? "-";
}

@section Styles {
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .mono {
            font-variant-numeric: tabular-nums;
        }

        .action-bar {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
        }

        .badge-pill {
            border-radius: 999px;
            padding: .35rem .6rem;
            font-size: .75rem;
        }
    </style>
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<form method="get" class="row g-2 mb-3">
    <input type="hidden" name="forumId" value="@Model.ForumId" />
    <div class="col-md-4 col-sm-6">
        <input class="form-control" name="q" value="@Model.Q" placeholder="搜尋標題關鍵字">
    </div>
    <div class="col-auto">
        <select class="form-select" name="status">
            <option value="ALL" selected="@(Model.Status == "ALL")">全部</option>
            <option value="normal" selected="@(Model.Status == "normal")">normal</option>
            <option value="hidden" selected="@(Model.Status == "hidden")">hidden</option>
            <option value="archived" selected="@(Model.Status == "archived")">archived</option>
        </select>
    </div>
    <div class="col-auto">
        <select class="form-select" name="size">
            <option value="10" selected="@(Model.Size == 10)">10/頁</option>
            <option value="20" selected="@(Model.Size == 20)">20/頁</option>
            <option value="50" selected="@(Model.Size == 50)">50/頁</option>
        </select>
    </div>
    <div class="col-auto d-flex gap-2">
        <button class="btn btn-primary" type="submit">查詢</button>
        <a class="btn btn-outline-secondary"
           asp-area="Forum" asp-controller="Threads" asp-action="Index">← 回論壇清單</a>
    </div>
</form>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width:90px" class="mono">ID</th>
                    <th>標題</th>
                    <th style="width:120px">狀態</th>
                    <th style="width:90px" class="text-center">回覆</th>
                    <th style="width:90px" class="text-center">讚</th>
                    <th style="width:90px" class="text-center">收藏</th>
                    <th style="width:170px" class="mono">建立</th>
                    <th style="width:170px" class="mono">更新</th>
                    <th style="width:280px">操作</th>
                </tr>
            </thead>
            <tbody>
                @if (!(Model.Items?.Any() ?? false))
                {
                    <tr><td colspan="9" class="text-center text-muted py-5">沒有資料</td></tr>
                }
                else
                {
                    @foreach (var x in Model.Items)
                    {
                        var (badge, label) = x.Status switch
                        {
                            "normal" => ("badge bg-success badge-pill", "正常"),
                            "hidden" => ("badge bg-warning text-dark badge-pill", "隱藏"),
                            "archived" => ("badge bg-secondary badge-pill", "封存"),
                            _ => ("badge bg-light text-dark badge-pill", x.Status ?? "-")
                        };
                        <tr>
                            <td class="mono">@x.ThreadId</td>
                            <td><div class="line-clamp-2 text-break">@x.Title</div></td>
                            <td><span class="@badge">@label</span></td>
                            <td class="text-center mono">@x.ReplyCount</td>
                            <td class="text-center mono">@x.LikeCount</td>
                            <td class="text-center mono">@x.BookmarkCount</td>
                            <td class="mono">@Fmt(x.CreatedAt)</td>
                            <td class="mono">@Fmt(x.UpdatedAt)</td>
                            <td>
                                <div class="action-bar">
                                    <a class="btn btn-sm btn-info"
                                       asp-area="Forum" asp-controller="Threads" asp-action="Posts"
                                       asp-route-threadId="@x.ThreadId">查看回覆</a>

                                    <form asp-area="Forum" asp-controller="Threads" asp-action="ChangeStatus"
                                          method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@x.ThreadId" />
                                        <input type="hidden" name="status" value="hidden" />
                                        <input type="hidden" name="forumId" value="@x.ForumId" />
                                        <button type="submit" class="btn btn-sm btn-warning"
                                                @(x.Status == "hidden" ? "disabled" : null)>
                                            隱藏
                                        </button>
                                    </form>

                                    <form asp-area="Forum" asp-controller="Threads" asp-action="ChangeStatus"
                                          method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@x.ThreadId" />
                                        <input type="hidden" name="status" value="archived" />
                                        <input type="hidden" name="forumId" value="@x.ForumId" />
                                        <button type="submit" class="btn btn-sm btn-secondary"
                                                @(x.Status == "archived" ? "disabled" : null)>
                                            封存
                                        </button>
                                    </form>

                                    <form asp-area="Forum" asp-controller="Threads" asp-action="ChangeStatus"
                                          method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@x.ThreadId" />
                                        <input type="hidden" name="status" value="normal" />
                                        <input type="hidden" name="forumId" value="@x.ForumId" />
                                        <button type="submit" class="btn btn-sm btn-success"
                                                @(x.Status == "normal" ? "disabled" : null)>
                                            恢復
                                        </button>
                                    </form>

                                    <!-- 刪除：彈出確認 -->
                                    <button type="button" class="btn btn-sm btn-danger"
                                            data-bs-toggle="modal" data-bs-target="#deleteModal"
                                            data-thread-id="@x.ThreadId" data-forum-id="@x.ForumId">
                                        刪除
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@* 分頁 *@
@if (totalPages > 1)
{
    <nav class="mt-3">
        <ul class="pagination">
            <li class="page-item @(Model.Page <= 1 ? "disabled" : null)">
                <a class="page-link"
                   asp-area="Forum" asp-controller="Threads" asp-action="List"
                   asp-route-forumId="@Model.ForumId"
                   asp-route-q="@Model.Q"
                   asp-route-status="@Model.Status"
                   asp-route-page="@(Model.Page - 1)"
                   asp-route-size="@Model.Size">上一頁</a>
            </li>

            @for (int p = Math.Max(1, Model.Page - 2); p <= Math.Min(totalPages, Model.Page + 2); p++)
            {
                <li class="page-item @(p == Model.Page ? "active" : null)">
                    <a class="page-link"
                       asp-area="Forum" asp-controller="Threads" asp-action="List"
                       asp-route-forumId="@Model.ForumId"
                       asp-route-q="@Model.Q"
                       asp-route-status="@Model.Status"
                       asp-route-page="@p"
                       asp-route-size="@Model.Size">@p</a>
                </li>
            }

            <li class="page-item @(Model.Page >= totalPages ? "disabled" : null)">
                <a class="page-link"
                   asp-area="Forum" asp-controller="Threads" asp-action="List"
                   asp-route-forumId="@Model.ForumId"
                   asp-route-q="@Model.Q"
                   asp-route-status="@Model.Status"
                   asp-route-page="@(Model.Page + 1)"
                   asp-route-size="@Model.Size">下一頁</a>
            </li>
        </ul>
    </nav>
}

@* 刪除確認 Modal（送到 ChangeStatus，status=deleted） *@
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-area="Forum" asp-controller="Threads" asp-action="ChangeStatus" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">確認刪除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
                </div>
                <div class="modal-body">
                    要確定文章有問題才可以刪除喔!!!!!
                </div>
                <div class="modal-footer">
                    <input type="hidden" name="id" id="del-thread-id" />
                    <input type="hidden" name="forumId" id="del-forum-id" />
                    <input type="hidden" name="status" value="deleted" />
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">確認刪除</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 把按鈕上的 threadId/forumId 帶進表單 hidden 欄位
        var deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var btn = event.relatedTarget;
            document.getElementById('del-thread-id').value = btn.getAttribute('data-thread-id');
            document.getElementById('del-forum-id').value  = btn.getAttribute('data-forum-id');
        });
    </script>
}
