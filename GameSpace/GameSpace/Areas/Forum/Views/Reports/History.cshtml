@model List<GameSpace.Areas.Forum.Controllers.ReportsController.DailyIndexVm>
@using System.Text.Json

@{
    ViewData["Title"] = "歷史指數查詢";
    int[] selectedMetrics = ViewBag.SelectedMetrics ?? Array.Empty<int>();
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<form method="get" class="row g-3 mb-3">
    <div class="col-md-3">
        <label class="form-label">遊戲</label>
        <select name="gameId" class="form-select">
            <option value="">請選擇</option>
            @if (ViewBag.Games != null)
            {
                foreach (var g in ViewBag.Games)
                {
                    int gid = (int)g.GameId;
                    string name = string.IsNullOrWhiteSpace((string)g.NameZh) ? (string)g.Name : (string)g.NameZh;
                    <option value="@gid" selected="@(ViewBag.GameId == gid ? "selected" : null)">@name</option>
                }
            }
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">起始日</label>
        <input type="date" name="from" value="@ViewBag.From" class="form-control" />
    </div>
    <div class="col-md-3">
        <label class="form-label">結束日</label>
        <input type="date" name="to" value="@ViewBag.To" class="form-control" />
    </div>

    <div class="col-md-6">
        <label class="form-label">指標（可多選）</label>
        <select name="metricIds" class="form-select" multiple size="6">
            @if (ViewBag.Metrics != null)
            {
                foreach (var m in ViewBag.Metrics)
                {
                    int mid = (int)m.MetricId;
                    bool sel = selectedMetrics.Contains(mid);
                    <option value="@mid" selected="@(sel ? "selected" : null)">
                        @m.Code (@m.Description) @(m.IsActive ? "" : "※未啟用")
                    </option>
                }
            }
        </select>
        <small class="text-muted">不選 = 依照啟用中的指標自動計算</small>
    </div>

    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100">查詢</button>
    </div>
</form>

@if (Model != null && Model.Any())
{
    <div class="mb-2 d-flex flex-wrap gap-2">
       @*  <!-- CSV -->
        <form method="get" target="_blank" asp-area="Forum" asp-controller="Reports" asp-action="ExportCsv" class="d-inline">
            <input type="hidden" name="gameId" value="@ViewBag.GameId" />
            <input type="hidden" name="from" value="@ViewBag.From" />
            <input type="hidden" name="to" value="@ViewBag.To" />
            @foreach (var mid in selectedMetrics)
            {
                <input type="hidden" name="metricIds" value="@mid" />
            }
            <button type="submit" class="btn btn-outline-secondary">匯出 CSV</button>
        </form> *@

        <!-- Excel（純資料） -->
        <form method="get" target="_blank" asp-area="Forum" asp-controller="Reports" asp-action="ExportExcel" class="d-inline">
            <input type="hidden" name="gameId" value="@ViewBag.GameId" />
            <input type="hidden" name="from" value="@ViewBag.From" />
            <input type="hidden" name="to" value="@ViewBag.To" />
            @foreach (var mid in selectedMetrics)
            {
                <input type="hidden" name="metricIds" value="@mid" />
            }
            <button type="submit" class="btn btn-outline-success">匯出 Excel</button>
        </form>

        <!-- Excel（含折線圖 PNG） -->
        <form id="exportWithChartForm" method="post" target="_blank"
              asp-area="Forum" asp-controller="Reports" asp-action="ExportExcelWithChartImage"
              class="d-inline">
            <input type="hidden" name="gameId" value="@ViewBag.GameId" />
            <input type="hidden" name="from" value="@ViewBag.From" />
            <input type="hidden" name="to" value="@ViewBag.To" />
            @foreach (var mid in selectedMetrics)
            {
                <input type="hidden" name="metricIds" value="@mid" />
            }
            <input type="hidden" id="chartDataUrl" name="chartDataUrl" />
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-outline-primary">匯出 Excel（含折線圖）</button>
        </form>

        <!-- 直接下載前端 PNG（好展示） -->
        <button type="button" id="btnDownloadPng" class="btn btn-outline-dark">下載折線圖 PNG</button>
    </div>

    <table class="table table-striped table-sm mt-2">
        <thead>
            <tr><th>日期</th><th>遊戲</th><th>Index</th></tr>
        </thead>
        <tbody>
            @foreach (var r in Model)
            {
                <tr>
                    <td>@r.Date.ToString("yyyy-MM-dd")</td>
                    <td>@r.GameName</td>
                    <td>@r.IndexValue</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="mt-4" style="height: 360px;">
        <h5 class="mb-2">指數走勢</h5>
        <canvas id="idxChart" height="160"></canvas>
    </div>
}
else
{
    <p class="text-muted">請先選擇條件查詢。</p>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const hasData = @((Model != null && Model.Any()) ? "true" : "false");
            if (!hasData) return;

            const labels = @Html.Raw(JsonSerializer.Serialize(Model.Select(m => m.Date.ToString("yyyy-MM-dd")).ToList()));
            const series = @Html.Raw(JsonSerializer.Serialize(Model.Select(m => m.IndexValue).ToList()));

            const canvas = document.getElementById('idxChart');
            if (!canvas) return;

            const chart = new Chart(canvas, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Popularity Index', data: series, tension: 0.25, fill: false, pointRadius: 2, borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: { display: true, text: '日期' } }, y: { title: { display: true, text: 'Index' }, beginAtZero: false } },
                    plugins: { legend: { display: true } }
                }
            });

            function toHiDpiPngDataUrl(srcCanvas) {
                const dpr = Math.max(1, window.devicePixelRatio || 1);
                const rect = srcCanvas.getBoundingClientRect();
                const w = Math.max(1, Math.round(rect.width));
                const h = Math.max(1, Math.round(rect.height));
                const tmp = document.createElement('canvas');
                tmp.width = w * dpr; tmp.height = h * dpr;
                const ctx = tmp.getContext('2d'); ctx.scale(dpr, dpr);
                ctx.drawImage(srcCanvas, 0, 0, w, h);
                return tmp.toDataURL('image/png', 1.0);
            }

            // 匯出（含圖）：submit 時塞圖
            const form = document.getElementById('exportWithChartForm');
            const hidden = document.getElementById('chartDataUrl');
            if (form && hidden) {
                form.addEventListener('submit', function () {
                    hidden.value = toHiDpiPngDataUrl(canvas);
                });
            }

            // 下載 PNG
            document.getElementById('btnDownloadPng')?.addEventListener('click', () => {
                const a = document.createElement('a');
                a.href = toHiDpiPngDataUrl(canvas);
                a.download = `PopularityIndex_${new Date().toISOString().slice(0,10)}.png`;
                a.click();
            });
        })();
    </script>
}

