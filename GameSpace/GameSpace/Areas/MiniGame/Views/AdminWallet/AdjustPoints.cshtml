@model GameSpace.Areas.MiniGame.Models.ViewModels.AdminWalletIndexViewModel
@{
    ViewData["Title"] = "�վ�|���I��";
    Layout = "~/Areas/MiniGame/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-edit mr-2"></i>�վ�|���I��
        </h1>
        <div class="d-flex">
            <a href="@Url.Action("Index")" class="btn btn-secondary mr-2">
                <i class="fas fa-arrow-left"></i> ��^
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- �վ��I�ƪ�� -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit"></i> �I�ƽվ�
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="AdjustPoints" id="adjustForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="userId">�Τ�ID *</label>
                                    <input type="number" class="form-control" id="userId" name="userId"
                                           value="@ViewBag.UserId" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="points">�վ��I�� *</label>
                                    <input type="number" class="form-control" id="points" name="points"
                                           placeholder="���Ƭ��W�[�A�t�Ƭ����" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="reason">�վ��] *</label>
                                    <textarea class="form-control" id="reason" name="reason" rows="3"
                                              placeholder="�п�J�վ��]" required></textarea>        
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> �T�{�վ�
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> ���m
                            </button>
                            <button type="button" class="btn btn-info" onclick="previewAdjust()">
                                <i class="fas fa-eye"></i> �w��
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- �Τ�H�� -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user"></i> �Τ�H��
                    </h6>
                </div>
                <div class="card-body">
                    <div id="userInfo">
                        <p class="text-muted">�п�J�Τ�ID�d�ݫH��</p>
                    </div>
                </div>
            </div>

            <!-- �վ㶷�� -->
            <div class="card shadow mt-3">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-info-circle"></i> �վ㶷��
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> ���Ƭ��W�[�I��</li>
                        <li><i class="fas fa-check text-success"></i> �t�Ƭ�����I��</li>
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> �վ��ߧY�ͮ�</li>
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> �t�η|�O���Ҧ��վ�</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- �̪�վ�O�� -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> �̪�վ�O��
                    </h6>
                    <button class="btn btn-sm btn-info" onclick="refreshRecords()">
                        <i class="fas fa-sync"></i> ��s
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="adjustRecordsTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>�Τ�ID</th>
                                    <th>�վ��I��</th>
                                    <th>�վ��]</th>
                                    <th>�վ�ɶ�</th>
                                    <th>�ާ@��</th>
                                    <th>�ާ@</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center text-muted">�ȵL�վ�O��</td>   
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- �w�� Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">�վ�w��</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- �w�����e�N�b�o����� -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">����</button>
                <button type="button" class="btn btn-primary" onclick="confirmAdjust()">�T�{�վ�</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // ��l�� DataTable
    $("#adjustRecordsTable").DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese-traditional.json"
        },
        "pageLength": 10,
        "order": [[ 3, "desc" ]]
    });
});

// �Τ�ID��J�ɦ۰ʬd�ߥΤ�H��
document.getElementById('userId').addEventListener('input', function() {
    const userId = this.value;
    if (userId) {
        document.getElementById('userInfo').innerHTML = '<p class="text-info">���b�d�ߥΤ�H��...</p>';
        
        $.ajax({
            url: "@Url.Action("GetUserInfo", "AdminWallet")",
            type: "GET",
            data: { userId: userId },
            success: function(response) {
                if (response.success) {
                    document.getElementById("userInfo").innerHTML =
                        `<p class="text-success">�Τ�: ${response.data.userName} (${response.data.email})</p>
                         <p class="text-info">��e�I��: ${response.data.currentPoints.toLocaleString()}</p>`;
                } else {
                    document.getElementById("userInfo").innerHTML =
                        `<p class="text-danger">�Τᤣ�s�b�άd�ߥ���</p>`;
                }
            },
            error: function() {
                document.getElementById("userInfo").innerHTML =
                    `<p class="text-danger">�d�ߥ��ѡA�еy��A��</p>`;
            }
        });
    } else {
        document.getElementById('userInfo').innerHTML = '<p class="text-muted">�п�J�Τ�ID�d�ݫH��</p>';
    }
});

function resetForm() {
    if (confirm("�T�w�n���m���ܡH�Ҧ����x�s���ܧ�N�|�򥢡C")) {
        document.getElementById("adjustForm").reset();
        document.getElementById('userInfo').innerHTML = '<p class="text-muted">�п�J�Τ�ID�d�ݫH��</p>';
    }
}

function previewAdjust() {
    var formData = $("#adjustForm").serialize();
    var isValid = validateForm();

    if (!isValid) {
        return;
    }

    $.ajax({
        url: "@Url.Action("PreviewAdjustPoints", "AdminWallet")",
        type: "POST",
        data: formData,
        success: function(response) {
            if (response.success) {
                showPreview(response.data);
            } else {
                alert("�w������: " + response.message);
            }
        },
        error: function() {
            alert("�w���ШD���ѡA�еy��A��");
        }
    });
}

function showPreview(data) {
    var previewHtml = "<h6>�վ�]�w�w��</h6>";
    previewHtml += "<p><strong>�Τ�ID:</strong> " + data.userId + "</p>";
    previewHtml += "<p><strong>�Τ�W��:</strong> " + data.userName + "</p>";
    previewHtml += "<p><strong>��e�I��:</strong> " + data.currentPoints + "</p>";
    previewHtml += "<p><strong>�վ��I��:</strong> " + data.adjustPoints + "</p>";
    previewHtml += "<p><strong>�վ���I��:</strong> " + data.newPoints + "</p>";
    previewHtml += "<p><strong>�վ��]:</strong> " + data.reason + "</p>";

    $("#previewContent").html(previewHtml);
    $("#previewModal").modal("show");
}

function confirmAdjust() {
    $("#previewModal").modal("hide");
    $("#adjustForm").submit();
}

function refreshRecords() {
    $.ajax({
        url: "@Url.Action("GetAdjustRecords", "AdminWallet")",
        type: "GET",
        success: function(response) {
            if (response.success) {
                loadRecordsToTable(response.data);
            } else {
                alert("����O������: " + response.message);
            }
        },
        error: function() {
            alert("����O�����ѡA�еy��A��");
        }
    });
}

function loadRecordsToTable(data) {
    var table = $("#adjustRecordsTable").DataTable();
    table.clear();
    
    if (data && data.length > 0) {
        data.forEach(function(record) {
            var pointsClass = record.adjustPoints > 0 ? "text-success" : "text-danger";
            var pointsText = record.adjustPoints > 0 ? "+" + record.adjustPoints : record.adjustPoints;
            
            table.row.add([
                record.userId,
                "<span class='" + pointsClass + "'>" + pointsText + "</span>",
                record.reason,
                record.adjustTime,
                record.operator,
                "<button class='btn btn-sm btn-info' onclick='viewRecordDetail(" + record.id + ")'>�d��</button>"
            ]);
        });
    } else {
        table.row.add([
            "�ȵL�վ�O��", "", "", "", "", ""
        ]);
    }
    
    table.draw();
}

function viewRecordDetail(recordId) {
    // �d�ݰO���Ա�
    alert("�d�ݰO���Ա�: " + recordId);
}

// �������
function validateForm() {
    const userId = document.getElementById("userId").value.trim();
    const points = document.getElementById("points").value;
    const reason = document.getElementById("reason").value.trim();

    if (!userId) {
        alert("�п�J�Τ�ID");
        return false;
    }

    if (!points || points == 0) {
        alert("�п�J���Ī��վ��I��");
        return false;
    }

    if (!reason) {
        alert("�п�J�վ��]");
        return false;
    }

    return true;
}

// ��洣������
document.getElementById("adjustForm").addEventListener("submit", function(e) {
    if (!validateForm()) {
        e.preventDefault();
        return;
    }

    const userId = document.getElementById("userId").value.trim();
    const points = document.getElementById("points").value;

    if (!confirm(`�T�w�n�վ�Τ� ${userId} ���I�� ${points} �ܡH`)) {
        e.preventDefault();
        return;
    }
});
</script>

