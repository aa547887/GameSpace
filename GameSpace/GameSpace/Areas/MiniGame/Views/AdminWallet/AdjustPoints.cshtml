@model GameSpace.Areas.MiniGame.Models.AdminWalletIndexViewModel
@{
    ViewData["Title"] = "調整會員點數";
    Layout = "~/Areas/MiniGame/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-edit mr-2"></i>調整會員點數
        </h1>
        <div class="d-flex">
            <a href="@Url.Action("Index")" class="btn btn-secondary mr-2">
                <i class="fas fa-arrow-left"></i> 返回
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- 調整點數表單 -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit"></i> 點數調整
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="AdjustPoints" id="adjustForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="userId">用戶ID *</label>
                                    <input type="number" class="form-control" id="userId" name="userId"
                                           value="@ViewBag.UserId" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="points">調整點數 *</label>
                                    <input type="number" class="form-control" id="points" name="points"
                                           placeholder="正數為增加，負數為減少" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="reason">調整原因 *</label>
                                    <textarea class="form-control" id="reason" name="reason" rows="3"
                                              placeholder="請輸入調整原因" required></textarea>        
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 確認調整
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> 重置
                            </button>
                            <button type="button" class="btn btn-info" onclick="previewAdjust()">
                                <i class="fas fa-eye"></i> 預覽
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 用戶信息 -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user"></i> 用戶信息
                    </h6>
                </div>
                <div class="card-body">
                    <div id="userInfo">
                        <p class="text-muted">請輸入用戶ID查看信息</p>
                    </div>
                </div>
            </div>

            <!-- 調整須知 -->
            <div class="card shadow mt-3">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-info-circle"></i> 調整須知
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> 正數為增加點數</li>
                        <li><i class="fas fa-check text-success"></i> 負數為減少點數</li>
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> 調整後立即生效</li>
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> 系統會記錄所有調整</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近調整記錄 -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> 最近調整記錄
                    </h6>
                    <button class="btn btn-sm btn-info" onclick="refreshRecords()">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="adjustRecordsTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>用戶ID</th>
                                    <th>調整點數</th>
                                    <th>調整原因</th>
                                    <th>調整時間</th>
                                    <th>操作員</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center text-muted">暫無調整記錄</td>   
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 預覽 Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">調整預覽</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- 預覽內容將在這裡顯示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" onclick="confirmAdjust()">確認調整</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 初始化 DataTable
    $("#adjustRecordsTable").DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese-traditional.json"
        },
        "pageLength": 10,
        "order": [[ 3, "desc" ]]
    });
});

// 用戶ID輸入時自動查詢用戶信息
document.getElementById('userId').addEventListener('input', function() {
    const userId = this.value;
    if (userId) {
        document.getElementById('userInfo').innerHTML = '<p class="text-info">正在查詢用戶信息...</p>';
        
        $.ajax({
            url: "@Url.Action("GetUserInfo", "AdminWallet")",
            type: "GET",
            data: { userId: userId },
            success: function(response) {
                if (response.success) {
                    document.getElementById("userInfo").innerHTML =
                        `<p class="text-success">用戶: ${response.data.userName} (${response.data.email})</p>
                         <p class="text-info">當前點數: ${response.data.currentPoints.toLocaleString()}</p>`;
                } else {
                    document.getElementById("userInfo").innerHTML =
                        `<p class="text-danger">用戶不存在或查詢失敗</p>`;
                }
            },
            error: function() {
                document.getElementById("userInfo").innerHTML =
                    `<p class="text-danger">查詢失敗，請稍後再試</p>`;
            }
        });
    } else {
        document.getElementById('userInfo').innerHTML = '<p class="text-muted">請輸入用戶ID查看信息</p>';
    }
});

function resetForm() {
    if (confirm("確定要重置表單嗎？所有未儲存的變更將會遺失。")) {
        document.getElementById("adjustForm").reset();
        document.getElementById('userInfo').innerHTML = '<p class="text-muted">請輸入用戶ID查看信息</p>';
    }
}

function previewAdjust() {
    var formData = $("#adjustForm").serialize();
    var isValid = validateForm();

    if (!isValid) {
        return;
    }

    $.ajax({
        url: "@Url.Action("PreviewAdjustPoints", "AdminWallet")",
        type: "POST",
        data: formData,
        success: function(response) {
            if (response.success) {
                showPreview(response.data);
            } else {
                alert("預覽失敗: " + response.message);
            }
        },
        error: function() {
            alert("預覽請求失敗，請稍後再試");
        }
    });
}

function showPreview(data) {
    var previewHtml = "<h6>調整設定預覽</h6>";
    previewHtml += "<p><strong>用戶ID:</strong> " + data.userId + "</p>";
    previewHtml += "<p><strong>用戶名稱:</strong> " + data.userName + "</p>";
    previewHtml += "<p><strong>當前點數:</strong> " + data.currentPoints + "</p>";
    previewHtml += "<p><strong>調整點數:</strong> " + data.adjustPoints + "</p>";
    previewHtml += "<p><strong>調整後點數:</strong> " + data.newPoints + "</p>";
    previewHtml += "<p><strong>調整原因:</strong> " + data.reason + "</p>";

    $("#previewContent").html(previewHtml);
    $("#previewModal").modal("show");
}

function confirmAdjust() {
    $("#previewModal").modal("hide");
    $("#adjustForm").submit();
}

function refreshRecords() {
    $.ajax({
        url: "@Url.Action("GetAdjustRecords", "AdminWallet")",
        type: "GET",
        success: function(response) {
            if (response.success) {
                loadRecordsToTable(response.data);
            } else {
                alert("獲取記錄失敗: " + response.message);
            }
        },
        error: function() {
            alert("獲取記錄失敗，請稍後再試");
        }
    });
}

function loadRecordsToTable(data) {
    var table = $("#adjustRecordsTable").DataTable();
    table.clear();
    
    if (data && data.length > 0) {
        data.forEach(function(record) {
            var pointsClass = record.adjustPoints > 0 ? "text-success" : "text-danger";
            var pointsText = record.adjustPoints > 0 ? "+" + record.adjustPoints : record.adjustPoints;
            
            table.row.add([
                record.userId,
                "<span class='" + pointsClass + "'>" + pointsText + "</span>",
                record.reason,
                record.adjustTime,
                record.operator,
                "<button class='btn btn-sm btn-info' onclick='viewRecordDetail(" + record.id + ")'>查看</button>"
            ]);
        });
    } else {
        table.row.add([
            "暫無調整記錄", "", "", "", "", ""
        ]);
    }
    
    table.draw();
}

function viewRecordDetail(recordId) {
    // 查看記錄詳情
    alert("查看記錄詳情: " + recordId);
}

// 表單驗證
function validateForm() {
    const userId = document.getElementById("userId").value.trim();
    const points = document.getElementById("points").value;
    const reason = document.getElementById("reason").value.trim();

    if (!userId) {
        alert("請輸入用戶ID");
        return false;
    }

    if (!points || points == 0) {
        alert("請輸入有效的調整點數");
        return false;
    }

    if (!reason) {
        alert("請輸入調整原因");
        return false;
    }

    return true;
}

// 表單提交驗證
document.getElementById("adjustForm").addEventListener("submit", function(e) {
    if (!validateForm()) {
        e.preventDefault();
        return;
    }

    const userId = document.getElementById("userId").value.trim();
    const points = document.getElementById("points").value;

    if (!confirm(`確定要調整用戶 ${userId} 的點數 ${points} 嗎？`)) {
        e.preventDefault();
        return;
    }
});
</script>
