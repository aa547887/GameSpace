@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.EntityFrameworkCore
@using GameSpace.Models
@inject GameSpacedatabaseContext Db

@{
    // 先決定要用哪個 Principal
    var adminAuth = await Context.AuthenticateAsync("AdminCookie");
    var principal =
        (User?.Identity?.IsAuthenticated == true && User.HasClaim(c => c.Type == "IsManager" && c.Value == "true"))
        ? User
        : (adminAuth?.Principal ?? User);

    bool isAuthed = principal?.Identity?.IsAuthenticated == true;

    // 取 ManagerId
    int? managerId = null;
    var idStr =
        principal?.FindFirst("ManagerId")?.Value ??
        principal?.FindFirst(ClaimTypes.NameIdentifier)?.Value ??
        principal?.FindFirst("uid")?.Value;

    if (int.TryParse(idStr, out var parsed)) managerId = parsed;

    // 檢查MiniGame權限（寵物權限管理）
    bool hasMiniGameAccess = principal?.HasClaim("perm:Pet", "true") ?? false;
    
    // 如果 Claims 沒帶權限，再回 DB 撈一次
    if (!hasMiniGameAccess && isAuthed && managerId.HasValue)
    {
        var mid = managerId.Value;
        var flags = await Db.ManagerRolePermissions
            .Where(p => p.Managers.Any(m => m.ManagerId == mid))
            .Select(p => new { p.PetRightsManagement })
            .ToListAsync();

        hasMiniGameAccess = flags.Any(x => x.PetRightsManagement == true);
    }
}

@if (isAuthed && hasMiniGameAccess)
{
<nav class="navbar-nav flex-column w-100">
    <!-- Dashboard -->
    <a class="nav-link d-flex align-items-center text-white sidebar-item" asp-area="MiniGame" asp-controller="Home" asp-action="Index">
        <i class="fas fa-tachometer-alt me-2"></i>
        <span class="sidebar-text d-none d-sm-inline">小遊戲管理系統</span>
    </a>

    <!-- 會員錢包 折疊 -->
    <a class="nav-link d-flex align-items-center text-white sidebar-item" data-bs-toggle="collapse" href="#collapseWallet" role="button" aria-expanded="false" aria-controls="collapseWallet">
        <i class="fas fa-wallet me-2"></i>
        <span class="sidebar-text d-none d-sm-inline">會員錢包</span>
        <i class="fas fa-angle-down ms-auto transition-icon"></i>
    </a>
    <div class="collapse ps-3 bg-white rounded-bottom" id="collapseWallet">
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="Index">
            <i class="fas fa-home me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">錢包管理首頁</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="QueryPoints">
            <i class="fas fa-search me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查詢會員點數</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="QueryCoupons">
            <i class="fas fa-ticket-alt me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查詢會員優惠券</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="QueryEVouchers">
            <i class="fas fa-gift me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查詢會員電子券</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="GrantPoints">
            <i class="fas fa-plus-circle me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">發放會員點數</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="GrantCoupons">
            <i class="fas fa-ticket-alt me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">發放會員優惠券</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="AdjustEVouchers">
            <i class="fas fa-edit me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">調整會員電子券</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminWallet" asp-action="ViewHistory">
            <i class="fas fa-history me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查看收支明細</span>
        </a>
    </div>

    <!-- 會員簽到系統 折疊 -->
    <a class="nav-link d-flex align-items-center text-white sidebar-item" data-bs-toggle="collapse" href="#collapseSignIn" role="button" aria-expanded="false" aria-controls="collapseSignIn">
        <i class="fas fa-calendar-check me-2"></i>
        <span class="sidebar-text d-none d-sm-inline">會員簽到系統</span>
        <i class="fas fa-angle-down ms-auto transition-icon"></i>
    </a>
    <div class="collapse ps-3 bg-white rounded-bottom" id="collapseSignIn">
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminSignInStats" asp-action="Index">
            <i class="fas fa-home me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">簽到管理首頁</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminSignInStats" asp-action="RuleSettings">
            <i class="fas fa-cog me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">簽到規則設定</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminSignInStats" asp-action="QueryRecords">
            <i class="fas fa-search me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查詢簽到記錄</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminSignInStats" asp-action="ViewRecords">
            <i class="fas fa-list me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查看簽到紀錄</span>
        </a>
    </div>

    <!-- 寵物系統 折疊 -->
    <a class="nav-link d-flex align-items-center text-white sidebar-item" data-bs-toggle="collapse" href="#collapsePet" role="button" aria-expanded="false" aria-controls="collapsePet">
        <i class="fas fa-paw me-2"></i>
        <span class="sidebar-text d-none d-sm-inline">寵物系統</span>
        <i class="fas fa-angle-down ms-auto transition-icon"></i>
    </a>
    <div class="collapse ps-3 bg-white rounded-bottom" id="collapsePet">
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminPet" asp-action="Index">
            <i class="fas fa-home me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">寵物管理首頁</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminPet" asp-action="SystemRules">
            <i class="fas fa-cog me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">整體寵物系統規則</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminPet" asp-action="QueryPets">
            <i class="fas fa-search me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查詢寵物資訊</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminPet" asp-action="IndividualSettings">
            <i class="fas fa-user-cog me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">會員個別寵物設定</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminPet" asp-action="ListWithQuery">
            <i class="fas fa-list me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">寵物清單查詢</span>
        </a>
    </div>

    <!-- 小遊戲系統 折疊 -->
    <a class="nav-link d-flex align-items-center text-white sidebar-item" data-bs-toggle="collapse" href="#collapseMiniGame" role="button" aria-expanded="false" aria-controls="collapseMiniGame">
        <i class="fas fa-gamepad me-2"></i>
        <span class="sidebar-text d-none d-sm-inline">小遊戲系統</span>
        <i class="fas fa-angle-down ms-auto transition-icon"></i>
    </a>
    <div class="collapse ps-3 bg-white rounded-bottom" id="collapseMiniGame">
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminMiniGame" asp-action="Index">
            <i class="fas fa-home me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">遊戲管理首頁</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminMiniGame" asp-action="GameRules">
            <i class="fas fa-cog me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">遊戲規則設定</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminMiniGame" asp-action="QueryRecords">
            <i class="fas fa-search me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查詢遊戲記錄</span>
        </a>
        <a class="nav-link d-flex align-items-center text-dark submenu-item" asp-area="MiniGame" asp-controller="AdminMiniGame" asp-action="ViewGameRecords">
            <i class="fas fa-list me-2"></i>
            <span class="sidebar-text d-none d-sm-inline">查看遊戲紀錄</span>
        </a>
    </div>

</nav>
}
else
{
    <div class="text-white p-3">
        <i class="fas fa-lock me-2"></i>
        <span>需要小遊戲管理權限才能存取此功能。</span>
    </div>
}

<style>
    .sidebar-item {
        transition: all 0.3s ease;
        border-radius: 0.375rem;
        margin: 0.125rem 0;
    }
    
    .sidebar-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }
    
    .submenu-item {
        transition: all 0.3s ease;
        border-radius: 0.25rem;
        margin: 0.125rem 0;
        font-size: 0.9rem;
    }
    
    .submenu-item:hover {
        background-color: rgba(0, 123, 255, 0.1);
        transform: translateX(3px);
    }
    
    .transition-icon {
        transition: transform 0.3s ease;
    }
    
    .collapsed .transition-icon {
        transform: rotate(-90deg);
    }
    
    .nav-link.active {
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: bold;
    }
    
    .sidebar-text {
        transition: all 0.3s ease;
    }
</style>

<script>
    $(document).ready(function() {
        // 處理折疊圖標旋轉
        $("[data-bs-toggle=\"collapse\"]").on("click", function() {
            var icon = $(this).find(".transition-icon");
            var target = $(this).attr("href");
            var isExpanded = $(target).hasClass("show");
            
            if (isExpanded) {
                icon.removeClass("collapsed");
            } else {
                icon.addClass("collapsed");
            }
        });
        
        // 高亮當前頁面
        var currentPath = window.location.pathname;
        $(".nav-link").each(function() {
            var href = $(this).attr("href");
            if (href && currentPath.includes(href)) {
                $(this).addClass("active");
            }
        });
    });
</script>
