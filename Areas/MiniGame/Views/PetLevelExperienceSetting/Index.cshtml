@model List<GameSpace.Areas.MiniGame.Models.ViewModels.PetLevelExperienceSettingListViewModel>
@{
    ViewData["Title"] = "寵物等級經驗值設定管理";
    var searchModel = ViewBag.SearchModel as GameSpace.Areas.MiniGame.Models.ViewModels.PetLevelExperienceSettingSearchViewModel;
    var totalCount = ViewBag.TotalCount as int? ?? 0;
    var statistics = ViewBag.Statistics as dynamic;
}

<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">@ViewData["Title"]</h1>
        <div>
            <a href="@Url.Action("Create")" class="btn btn-primary btn-sm">
                <i class="fas fa-plus fa-sm text-white-50"></i> 新增設定
            </a>
        </div>
    </div>

    <!-- 統計卡片 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">總設定數</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@(statistics?.TotalCount ?? 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">啟用設定</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@(statistics?.EnabledCount ?? 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">停用設定</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@(statistics?.DisabledCount ?? 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">等級範圍</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@(statistics?.MinLevel ?? 0) - @(statistics?.MaxLevel ?? 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-layer-group fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋表單 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">搜尋條件</h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="@searchModel.Keyword">搜尋關鍵字</label>
                            <input asp-for="@searchModel.Keyword" class="form-control" placeholder="等級名稱或描述">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label asp-for="@searchModel.MinLevel">最小等級</label>
                            <input asp-for="@searchModel.MinLevel" type="number" class="form-control" min="1" max="100">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label asp-for="@searchModel.MaxLevel">最大等級</label>
                            <input asp-for="@searchModel.MaxLevel" type="number" class="form-control" min="1" max="100">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label asp-for="@searchModel.IsEnabled">啟用狀態</label>
                            <select asp-for="@searchModel.IsEnabled" class="form-control">
                                <option value="">全部</option>
                                <option value="true">啟用</option>
                                <option value="false">停用</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label asp-for="@searchModel.PageSize">每頁筆數</label>
                            <select asp-for="@searchModel.PageSize" class="form-control">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> 搜尋
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 資料表格 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">等級經驗值設定列表</h6>
            <span class="badge badge-primary">共 @totalCount 筆</span>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>等級</th>
                                <th>等級名稱</th>
                                <th>所需經驗值</th>
                                <th>描述</th>
                                <th>狀態</th>
                                <th>建立時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        <span class="badge badge-info">@item.Level</span>
                                    </td>
                                    <td>@item.LevelName</td>
                                    <td>
                                        <span class="font-weight-bold text-primary">@item.RequiredExperience.ToString("N0")</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            <span title="@item.Description">
                                                @(item.Description.Length > 30 ? item.Description.Substring(0, 30) + "..." : item.Description)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">無</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.IsEnabled)
                                        {
                                            <span class="badge badge-success">啟用</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-secondary">停用</span>
                                        }
                                    </td>
                                    <td>@item.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="@Url.Action("Details", new { id = item.Id })" class="btn btn-info btn-sm" title="檢視">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("Edit", new { id = item.Id })" class="btn btn-warning btn-sm" title="編輯">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="post" asp-action="ToggleStatus" asp-route-id="@item.Id" style="display: inline;">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-@(item.IsEnabled ? "secondary" : "success") btn-sm" 
                                                        title="@(item.IsEnabled ? "停用" : "啟用")"
                                                        onclick="return confirm('確定要@(item.IsEnabled ? "停用" : "啟用")此設定嗎？')">
                                                    <i class="fas fa-@(item.IsEnabled ? "pause" : "play")"></i>
                                                </button>
                                            </form>
                                            <a href="@Url.Action("Delete", new { id = item.Id })" class="btn btn-danger btn-sm" title="刪除">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                @if (totalCount > (searchModel?.PageSize ?? 10))
                {
                    <nav aria-label="分頁導航">
                        <ul class="pagination justify-content-center">
                            @{
                                var currentPage = searchModel?.Page ?? 1;
                                var pageSize = searchModel?.PageSize ?? 10;
                                var totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
                                var startPage = Math.Max(1, currentPage - 2);
                                var endPage = Math.Min(totalPages, currentPage + 2);
                            }

                            @if (currentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { Page = currentPage - 1, PageSize = pageSize, Keyword = searchModel?.Keyword, MinLevel = searchModel?.MinLevel, MaxLevel = searchModel?.MaxLevel, IsEnabled = searchModel?.IsEnabled })">上一頁</a>
                                </li>
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { Page = i, PageSize = pageSize, Keyword = searchModel?.Keyword, MinLevel = searchModel?.MinLevel, MaxLevel = searchModel?.MaxLevel, IsEnabled = searchModel?.IsEnabled })">@i</a>
                                </li>
                            }

                            @if (currentPage < totalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { Page = currentPage + 1, PageSize = pageSize, Keyword = searchModel?.Keyword, MinLevel = searchModel?.MinLevel, MaxLevel = searchModel?.MaxLevel, IsEnabled = searchModel?.IsEnabled })">下一頁</a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                    <h5 class="text-gray-600">尚無等級經驗值設定</h5>
                    <p class="text-gray-500">請點擊上方「新增設定」按鈕來建立第一個等級經驗值設定</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 自動隱藏提示訊息
        setTimeout(function() {
            .alert.fadeOut('slow');
        }, 5000);
    </script>
}
