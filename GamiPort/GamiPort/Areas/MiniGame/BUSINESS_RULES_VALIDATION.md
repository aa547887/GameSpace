# 商業規則驗證報告

## 📋 檢查日期：2025-11-06

本報告針對 **寵物系統** 和 **小遊戲（寵物冒險）** 進行商業規則符合性檢查。

---

## ✅ 已正確實現的規則

### 1. 寵物升級公式 ✓
**位置**: `PetService.cs` Line 514-546

- Level 1–10：`EXP = 40 × level + 60` ✓
- Level 11–100：`EXP = 0.8 × level² + 380` ✓
- Level ≥ 101：`EXP = 285.69 × (1.06^level)` ✓

### 2. 寵物升級點數獎勵 ✓
**位置**: `PetService.cs` Line 551-571

- Level 1-10 每升級 +10 點
- Level 11-20 每升級 +20 點
- 以此類推
- Level 241-250 每升級 +250 點（上限）

計算公式：`tier = Math.Min((level - 1) / 10 + 1, 25); return tier * 10;`

### 3. 每日遊戲次數限制 ✓
**位置**: `GamePlayService.cs` Line 35-69

- 每日最多 3 次（可從 SystemSettings 配置）
- 使用 UTC+8 時區計算
- 每日 00:00 重置

### 4. 互動點數扣除 ✓
**位置**: `PetService.cs` Line 64-75, 110-111

- 檢查用戶錢包是否有足夠點數
- 每次互動消耗 5 點
- 使用事務保護原子性

### 5. 遊戲結果影響寵物屬性 ✓
**位置**: `GamePlayService.cs` Line 363-381

- 冒險勝利時：飢餓值 -20、心情值 +30、體力值 -20、清潔值 -20
- 冒險失敗時：飢餓值 -20、心情值 -30、體力值 -20、清潔值 -20

### 6. 原子性與回滾 ✓
**位置**: `PetService.cs` Line 78-134, `GamePlayService.cs` Line 161-241

- 所有涉及會員點數和寵物狀態的操作都使用資料庫交易
- 失敗時自動回滾

---

## ❌ 未符合或缺失的規則

### 1. 寵物屬性鉗位不完整 ❌
**問題**: `PetService.cs` Line 87-99

**現狀**:
```csharp
pet.Hunger = Math.Min(pet.Hunger + 10, 100);  // 只有上限100
```

**缺失**:
- ✓ 有上限 100
- ❌ **沒有下限 0 的鉗位**
- ❌ **沒有在屬性變化後統一鉗位到 0-100**

**影響**: 如果遊戲結果或每日衰減導致屬性為負數，系統不會自動鉗位。

---

### 2. 互動動作用詞不一致 ❌
**問題**: `PetService.cs` Line 82-108

**商業規則用詞**:
- 餵食 (feed) ✓
- 洗澡 (bath) ✓
- **哄睡** → 心情值 +10
- **休息** → 體力值 +10

**代碼實際用詞**:
- feed → 飢餓值 +10 ✓
- bath → 清潔值 +10 ✓
- **play → 心情值 +10** ❌ (應該是哄睡，不是玩耍)
- **sleep → 體力值 +10** ❌ (應該是休息，不是睡覺)

**建議**:
```csharp
case "comfort": // 哄睡：心情值增加10
    pet.Mood = Math.Min(pet.Mood + 10, 100);
    break;
case "rest": // 休息：體力值增加10
    pet.Stamina = Math.Min(pet.Stamina + 10, 100);
    break;
```

---

### 3. 遊戲關卡設計不符合 ❌
**問題**: `GamePlayService.cs` Line 332-355

#### 怪物數量錯誤:
**商業規則**:
- 第 1 關：怪物數量 **6**
- 第 2 關：怪物數量 **8**
- 第 3 關：怪物數量 **10**

**代碼實際** (Line 332-340):
```csharp
1 => 3,  // ❌ 應該是 6
2 => 5,  // ❌ 應該是 8
3 => 7,  // ❌ 應該是 10
```

#### 移動速度錯誤:
**商業規則**:
- 第 1 關：移動速度 **1.0** 倍
- 第 2 關：移動速度 **1.5** 倍
- 第 3 關：移動速度 **2.0** 倍

**代碼實際** (Line 347-355):
```csharp
1 => 1.0m,  // ✓
2 => 1.2m,  // ❌ 應該是 1.5
3 => 1.5m,  // ❌ 應該是 2.0
```

#### 獎勵配置:
**商業規則**:
- 第 1 關：+100 寵物經驗值，+10 會員點數
- 第 2 關：+200 寵物經驗值，+20 會員點數
- 第 3 關：+300 寵物經驗值，+30 會員點數，+1 張商城優惠券

**代碼實際**:
- ❌ **獎勵數值沒有在 GamePlayService.cs 中定義**
- 需要在 `EndGameAsync` 方法中根據 level 計算正確的獎勵

---

### 4. 冒險開始前健康狀態檢查缺失 ❌
**問題**: `GamePlayService.cs` Line 75-146 `StartGameAsync`

**商業規則**:
> "冒險開始前檢查寵物狀態，若飢餓、心情、體力、清潔、健康任一屬性值為 0，則無法開始冒險（需先透過互動恢復寵物狀態）"

**代碼現狀**:
- 只檢查寵物是否存在 (Line 103-110)
- ❌ **沒有檢查寵物的 5 個屬性值**

**需要添加**:
```csharp
// 檢查寵物健康狀態
if (pet.Hunger == 0 || pet.Mood == 0 || pet.Stamina == 0 ||
    pet.Cleanliness == 0 || pet.Health == 0)
{
    return (false, "寵物狀態不佳（飢餓/心情/體力/清潔/健康值為0），請先進行互動恢復狀態", null);
}
```

---

### 5. 全滿回復規則未實現 ❌
**問題**: `PetService.cs` 完全缺失

**商業規則**:
> "全滿回復：當飢餓、心情、體力、清潔四項值均達到 100 時，寵物健康值恢復至 100"

**需要實現**: 在 `InteractWithPetAsync` 方法中添加檢查：
```csharp
// 檢查全滿回復
if (pet.Hunger == 100 && pet.Mood == 100 &&
    pet.Stamina == 100 && pet.Cleanliness == 100)
{
    pet.Health = 100;
}
```

---

### 6. 每日狀態全滿獎勵未實現 ❌
**問題**: `PetService.cs` 完全缺失

**商業規則**:
> "每日狀態全滿獎勵：寵物若於每日首次同時達到飢餓、心情、體力、清潔值皆 100，則額外獲得 100 點寵物經驗值"

**需要實現**:
1. 在 Pet 表中添加 `LastFullStatsDate` 欄位
2. 在互動後檢查是否首次達到全滿
3. 如果是當日首次，發放 100 經驗值獎勵

---

### 7. 遊戲結果屬性變化未真正應用 ❌
**問題**: `GamePlayService.cs` Line 363-381

**現狀**:
- 只在 `MiniGame` 表中記錄了 Delta 值（HungerDelta, MoodDelta 等）
- ❌ **沒有真正更新 Pet 表的屬性值**

**需要實現**: 在 `EndGameAsync` 中添加：
```csharp
// 更新寵物實際屬性
var pet = await _context.Pets.FirstOrDefaultAsync(p => p.PetId == game.PetId);
if (pet != null)
{
    pet.Hunger = Math.Max(0, Math.Min(100, pet.Hunger + game.HungerDelta));
    pet.Mood = Math.Max(0, Math.Min(100, pet.Mood + game.MoodDelta));
    pet.Stamina = Math.Max(0, Math.Min(100, pet.Stamina + game.StaminaDelta));
    pet.Cleanliness = Math.Max(0, Math.Min(100, pet.Cleanliness + game.CleanlinessDelta));
    _context.Pets.Update(pet);
}
```

---

### 8. 難度進程機制未實現 ❌
**問題**: 整個系統缺失

**商業規則**:
> "難度進程：冒險首次從第 1 關開始。若當前關卡勝利，則下次冒險提升至下一關；若失敗則留在同一關卡（最高第 3 關）"

**需要實現**:
1. 在 Pet 表或 User 表中添加 `CurrentGameLevel` 欄位
2. 每次 StartGameAsync 時讀取用戶當前關卡
3. EndGameAsync 勝利時提升關卡（最高 3）
4. EndGameAsync 失敗時保持當前關卡

---

### 9. 每日衰減機制未實現 ❌
**問題**: 整個系統缺失

**商業規則**:
> "每日衰減：每日UTC+8 00:00，飢餓值 -20、心情值 -30、體力值 -10、清潔值 -20"

**需要實現**:
1. 創建背景服務或定時任務（Hosted Service）
2. 每日 UTC+8 00:00 執行
3. 更新所有寵物的 4 個屬性值
4. 使用鉗位確保不低於 0

**建議實現位置**: 新增 `PetDailyDecayService.cs`

---

### 10. 狀態描述邏輯缺失 ❌
**問題**: 整個系統缺失

**商業規則**:
> "狀態：飢餓、心情、體力、清潔、健康值 < 20，分別代表寵物處於飢餓、難過、很累、身體很臭、生病的狀態，否則為飽食、開心、充分休息、身體乾淨、很健康的狀態"

**需要實現**: 在前端或 ViewModel 中添加狀態文字描述邏輯。

---

## 📝 用詞一致性問題

### 商業規則用詞 vs 代碼用詞

| 商業規則 | 代碼實際 | 建議 |
|---------|---------|------|
| 關卡 | level | 保持 level，但註釋說明為"關卡" |
| 冒險 | game | 統一使用 "adventure" 或保持 game 並註釋 |
| 餵食 | feed | ✓ 一致 |
| 洗澡 | bath | ✓ 一致 |
| **哄睡** | **play** | ❌ 改為 comfort |
| **休息** | **sleep** | ❌ 改為 rest |
| 會員點數 | UserPoint | ✓ 一致 |
| 寵物經驗值 | Experience | ✓ 一致 |

---

## 🔧 修正優先級

### P0 - 關鍵問題（影響核心遊戲邏輯）
1. ❌ 遊戲關卡設計錯誤（怪物數量、速度、獎勵）
2. ❌ 遊戲結果屬性變化未真正應用到 Pet 表
3. ❌ 冒險開始前健康狀態檢查缺失
4. ❌ 寵物屬性鉗位不完整（缺少下限 0）

### P1 - 重要功能缺失
5. ❌ 全滿回復規則未實現
6. ❌ 難度進程機制未實現
7. ❌ 每日狀態全滿獎勵未實現

### P2 - 體驗優化
8. ❌ 互動動作用詞不一致
9. ❌ 每日衰減機制未實現
10. ❌ 狀態描述邏輯缺失

---

## 📊 符合性總結（2025-11-06 15:30 更新）

| 類別 | 已實現 | 未實現 | 符合率 |
|-----|--------|--------|--------|
| 寵物系統 | 6 | 4 | 60% |
| 小遊戲系統 | 7 | 0 | 100% |
| **總計** | **13** | **4** | **76%** |

### 最新修正完成狀態

**✅ 已修正（本次更新）**:
1. ✅ 遊戲關卡設計數值（怪物數量、速度、獎勵）
2. ✅ 遊戲結果真正應用到寵物屬性
3. ✅ 冒險前健康狀態檢查
4. ✅ 屬性鉗位完整（含下限0）
5. ✅ 全滿回復規則
6. ✅ 互動動作用詞統一

**✅ 剩餘未實現（經資料庫調查後，可使用現有欄位實現）**:

根據 `REMAINING_FEATURES_IMPLEMENTATION_PLAN.md` 的詳細分析：

1. ✅ **每日狀態全滿獎勵** - 可使用 `WalletHistory` 表的 `ItemCode` 欄位追蹤（模式：`PET-FULLSTATS-YYYY-MM-DD`）
2. ✅ **難度進程機制** - 可查詢 `MiniGame` 表的 `Level` 和 `Result` 欄位計算下次關卡
3. ⚠️ **每日衰減機制** - 需創建背景服務（跨越 Areas\MiniGame 邊界，需用戶批准）
4. ✅ **狀態描述邏輯** - 純前端實現（JavaScript + HTML）

**詳細實現方案**：請參閱 `REMAINING_FEATURES_IMPLEMENTATION_PLAN.md`

---

## 💡 建議修正順序

### ✅ 已完成 (P0 + 部分 P1/P2)
1. ✅ 修正遊戲關卡設計數值
2. ✅ 實現遊戲結果真正應用到寵物屬性
3. ✅ 添加冒險前健康狀態檢查
4. ✅ 完善屬性鉗位邏輯
5. ✅ 實現全滿回復規則
6. ✅ 統一互動動作用詞

### ✅ 已完成（階段 1：無需跨邊界） - 2025-11-06 02:15
7. ✅ 實現難度進程機制（修改 `GamePlayService.cs`、`IGamePlayService.cs`、`GameController.cs`）
   - 新增 `GetUserNextGameLevelAsync` 方法自動計算關卡
   - 查詢用戶最後一場完成的遊戲記錄
   - 勝利提升至下一關，失敗保持當前關卡，最高第 3 關
   - 無需新增資料庫欄位，完全使用現有 `MiniGame` 表

8. ✅ 實現每日狀態全滿獎勵（修改 `PetService.cs`）
   - 使用 `WalletHistory.ItemCode` 追蹤（模式：`PET-FULLSTATS-2025-11-06`）
   - 檢查當日是否已發放獎勵（防重複）
   - 發放 100 經驗值並自動檢查升級
   - 記錄到 WalletHistory 防重複發放
   - 無需新增資料庫欄位

9. ✅ 添加狀態描述邏輯（修改 `Pet/Index.cshtml`）
   - 純前端 JavaScript 實現
   - 在每個屬性進度條下方顯示狀態文字
   - 商業規則：屬性值 < 20 顯示負面狀態，否則顯示正面狀態
   - 動態更新（互動後立即顯示新狀態）

### ⚠️ 待批准（階段 2：需跨邊界）
10. ⚠️ 實現每日衰減背景服務（需創建 `Infrastructure/BackgroundServices/PetDailyDecayService.cs` + 修改 `Program.cs`）
    - SystemSettings 已有配置：Hunger -20, Mood -30, Stamina -10, Cleanliness -20
    - 需要用戶批准跨越 Areas\MiniGame 邊界

### 17. 每日衰減機制 ✅ (已實現 - 2025-11-06 02:30)
**位置**: `Infrastructure/BackgroundServices/PetDailyDecayService.cs` Line 1-114

**實現方式**:
- ✅ 創建背景服務繼承 `BackgroundService`
- ✅ 應用啟動時自動運行
- ✅ 計算下次執行時間（明天 00:00 UTC+8）
- ✅ 使用 `TimeZones.Taipei` 時區轉換
- ✅ 從 `SystemSettings` 表讀取衰減配置（可動態調整）
- ✅ 預設值：飢餓-20、心情-30、體力-10、清潔-20
- ✅ 應用到所有未刪除寵物
- ✅ 使用 `Math.Max(0, value - decay)` 鉗位到 0-100 範圍
- ✅ 完整錯誤處理（錯誤時等待 1 小時後重試）
- ✅ 詳細日誌記錄（啟動、執行計畫、完成統計、錯誤）

**跨邊界批准**:
- ✅ 進入 PAUSE-AND-ASK 模式
- ✅ 提供 3 種方案分析（背景服務、訪問時檢查、外部排程器）
- ✅ 提供 unified diff 顯示所有變更
- ✅ 獲得用戶明確批准（"我同意 方案A。立刻執行"）

**SystemSettings 配置鍵**:
- `Pet.DailyDecay.HungerDecay` (預設: 20)
- `Pet.DailyDecay.MoodDecay` (預設: 30)
- `Pet.DailyDecay.StaminaDecay` (預設: 10)
- `Pet.DailyDecay.CleanlinessDecay` (預設: 20)

**Program.cs 註冊**:
- Line 29: 新增 `using GamiPort.Infrastructure.BackgroundServices;`
- Line 182: 新增 `builder.Services.AddHostedService<PetDailyDecayService>();`

---

## 📊 最終商業規則符合性

| 類別 | 已實現 | 未實現 | 符合率 |
|-----|--------|--------|--------|
| 寵物系統 | 10 | 0 | 100% |
| 小遊戲系統 | 7 | 0 | 100% |
| **總計** | **17** | **0** | **100%** 🎉 |

### 🎉 最終更新完成狀態（2025-11-06 02:30）

**✅ 已完成（全部 17 項規則）**:
1. ✅ 寵物升級公式
2. ✅ 寵物升級點數獎勵
3. ✅ 每日遊戲次數限制
4. ✅ 互動點數扣除
5. ✅ 遊戲結果影響寵物屬性
6. ✅ 原子性與回滾
7. ✅ 遊戲關卡設計數值
8. ✅ 關卡獎勵計算
9. ✅ 健康狀態前置檢查
10. ✅ 互動動作用詞統一
11. ✅ 屬性鉗位邏輯
12. ✅ 全滿回復規則
13. ✅ 會員點數下限保護
14. ✅ 難度進程機制
15. ✅ 每日狀態全滿獎勵
16. ✅ 狀態描述邏輯
17. ✅ 每日衰減機制（背景服務）

**🎉 所有商業規則已完整實現！**

---

*報告生成時間：2025-11-06*
*資料庫調查完成時間：2025-11-06 16:00*
*最後更新時間：2025-11-06 02:30 (100% 完成)*
