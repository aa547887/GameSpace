@using GamiPort.Areas.MiniGame.Helpers
@inject GamiPort.Infrastructure.Time.IAppClock AppClock
@{
    ViewData["Title"] = "遊戲歷史記錄";

    var gameRecords = ViewBag.GameRecords as List<dynamic> ?? new List<dynamic>();
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var pageSize = ViewBag.PageSize as int? ?? 10;
    var totalRecords = ViewBag.TotalRecords as int? ?? 0;
    var totalPages = (totalRecords > 0 && pageSize > 0) ? (int)Math.Ceiling((double)totalRecords / pageSize) : 1;

    var selectedLevel = ViewBag.SelectedLevel as string;
    var selectedResult = ViewBag.SelectedResult as string;
    var selectedDate = ViewBag.SelectedDate as string;
}

@if (User.Identity?.IsAuthenticated == true)
{
    <style>
        :root {
            --teal-primary: #0d9488;
            --teal-secondary: #17a2b8;
            --teal-light: #e0f2f1;
            --teal-lighter: #f0f9f8;
            --orange-accent: #ff9f43;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --danger-red: #e74c3c;
            --bg-light: #f0f4f8;
        }

        .page-background {
            background: linear-gradient(180deg, #f0f4f8 0%, #ffffff 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        /* 頁面標題 */
        .page-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .page-header i {
            color: var(--teal-primary);
            font-size: 2rem;
        }

        .page-header h2 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 0;
        }

        .page-header p {
            color: #7f8c8d;
            margin-bottom: 0;
            font-size: 0.95rem;
        }

        /* 篩選卡片 */
        .filter-card {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .filter-card h4 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-card i {
            color: var(--teal-primary);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            border-radius: 12px;
            border: 2px solid #e8ecf0;
            padding: 0.75rem;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
            color: #2c3e50;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--teal-primary);
            background: #f0f9f8;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-filter {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-search {
            background: linear-gradient(135deg, var(--teal-primary) 0%, var(--teal-secondary) 100%);
            color: white;
        }

        .btn-search:hover {
            background: linear-gradient(135deg, var(--teal-secondary) 0%, #0a7d72 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .btn-reset {
            background: #f0f4f8;
            color: #7f8c8d;
            border: 2px solid #dee2e6;
        }

        .btn-reset:hover {
            background: #e8ecf0;
            color: #5a6c7d;
        }

        /* 記錄容器 */
        .records-container {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        /* 記錄表格 */
        .records-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .records-table thead {
            background: #f0f4f8;
            border-bottom: 2px solid #dee2e6;
        }

        .records-table th {
            color: #2c3e50;
            font-weight: 700;
            padding: 1rem;
            text-align: left;
        }

        .records-table tbody tr {
            border-bottom: 1px solid #f0f4f8;
            transition: all 0.2s ease;
        }

        .records-table tbody tr:hover {
            background: var(--teal-lighter);
        }

        .records-table td {
            padding: 1rem;
            color: #2c3e50;
        }

        /* 難度徽章 */
        .difficulty-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .difficulty-easy {
            background: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }

        .difficulty-normal {
            background: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }

        .difficulty-hard {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        /* 結果徽章 */
        .result-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .result-win {
            background: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }

        .result-lose {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .result-abort {
            background: rgba(149, 165, 166, 0.15);
            color: #95a5a6;
        }

        .result-badge i {
            font-size: 0.9rem;
        }

        /* 空記錄提示 */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 3rem;
            color: #bdc3c7;
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state h5 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* 分頁 */
        .pagination-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-right: 1rem;
        }

        .pagination-btn {
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            border: 2px solid #dee2e6;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--teal-primary);
            background: var(--teal-lighter);
            color: var(--teal-primary);
        }

        .pagination-btn.active {
            background: var(--teal-primary);
            color: white;
            border-color: var(--teal-primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 響應式設計 */
        @@media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }

            .filter-actions {
                justify-content: stretch;
            }

            .btn-filter {
                flex: 1;
                justify-content: center;
            }

            .records-table {
                font-size: 0.85rem;
            }

            .records-table th,
            .records-table td {
                padding: 0.75rem 0.5rem;
            }

            .difficulty-badge,
            .result-badge {
                padding: 0.35rem 0.6rem;
                font-size: 0.75rem;
            }

            .pagination-wrapper {
                gap: 0.25rem;
            }

            .pagination-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
        }

        /* 卡片式佈局（移動裝置） */
        @@media (max-width: 576px) {
            .records-table {
                display: block;
            }

            .records-table thead {
                display: none;
            }

            .records-table tbody {
                display: block;
            }

            .records-table tr {
                display: block;
                border: 1px solid #dee2e6;
                border-radius: 12px;
                margin-bottom: 1rem;
                overflow: hidden;
            }

            .records-table td {
                display: block;
                border: none;
                padding: 0.75rem;
                text-align: right;
                position: relative;
                padding-left: 50%;
            }

            .records-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 50%;
                padding: 0.75rem;
                font-weight: 700;
                text-align: left;
                background: #f0f4f8;
                color: #2c3e50;
            }

            .records-table td:first-child {
                background: var(--teal-lighter);
                border-radius: 12px 12px 0 0;
            }
        }
    </style>

    <div class="page-background">
        <div class="container">
            <!-- 頁面標題 -->
            <div class="page-header">
                <i class="bi bi-clock-history"></i>
                <div>
                    <h2>遊戲歷史記錄</h2>
                    <p>查看您的所有遊戲記錄與成績統計</p>
                </div>
            </div>

            <!-- 篩選區域 -->
            <div class="filter-card">
                <h4>
                    <i class="bi bi-funnel"></i>
                    篩選記錄
                </h4>
                <form method="get" asp-area="MiniGame" asp-controller="Game" asp-action="History">
                    <div class="filter-row" style="margin-bottom: 1rem;">
                        <!-- 日期篩選 -->
                        <div class="filter-group">
                            <label for="filterDate">
                                <i class="bi bi-calendar-event me-1"></i>
                                日期
                            </label>
                            <input type="date" id="filterDate" name="date" value="@selectedDate" />
                        </div>

                        <!-- 難度篩選 -->
                        <div class="filter-group">
                            <label for="filterLevel">
                                <i class="bi bi-bar-chart me-1"></i>
                                難度
                            </label>
                            <select id="filterLevel" name="level">
                                <option value="">全部難度</option>
                                <option value="1" selected="@(selectedLevel == "1")">Level 1 (簡單)</option>
                                <option value="2" selected="@(selectedLevel == "2")">Level 2 (普通)</option>
                                <option value="3" selected="@(selectedLevel == "3")">Level 3 (困難)</option>
                            </select>
                        </div>

                        <!-- 結果篩選 -->
                        <div class="filter-group">
                            <label for="filterResult">
                                <i class="bi bi-check-circle me-1"></i>
                                結果
                            </label>
                            <select id="filterResult" name="result">
                                <option value="">全部結果</option>
                                <option value="win" selected="@(selectedResult == "win")">通關</option>
                                <option value="lose" selected="@(selectedResult == "lose")">未通關</option>
                                <option value="abort" selected="@(selectedResult == "abort")">已放棄</option>
                            </select>
                        </div>
                    </div>

                    <!-- 操作按鈕 -->
                    <div class="filter-actions">
                        <button type="submit" class="btn-filter btn-search">
                            <i class="bi bi-search"></i>
                            搜尋
                        </button>
                        <a href="@Url.Action("History", "Game", new { area = "MiniGame" })" class="btn-filter btn-reset">
                            <i class="bi bi-arrow-clockwise"></i>
                            重設
                        </a>
                    </div>
                </form>
            </div>

            <!-- 記錄表格 -->
            <div class="records-container">
                @if (gameRecords.Any())
                {
                    <div class="table-responsive">
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">遊戲時間</th>
                                    <th style="width: 12%;">難度</th>
                                    <th style="width: 12%;">結果</th>
                                    <th style="width: 15%;">獲得點數</th>
                                    <th style="width: 18%;">獲得經驗值</th>
                                    <th style="width: 28%;">詳細資訊</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in gameRecords)
                                {
                                    var playTime = AppClock.ToAppTime((DateTime)(record?.PlayTime ?? AppClock.UtcNow));
                                    var level = (int?)record?.Level ?? 0;
                                    var result = (string)record?.Result ?? "unknown";
                                    var pointsGained = (int?)record?.PointsGained ?? 0;
                                    var experienceGained = (int?)record?.ExperienceGained ?? 0;
                                    var spendTime = (int?)record?.SpendTimeSeconds ?? 0;

                                    var difficultyText = level switch
                                    {
                                        1 => "簡單",
                                        2 => "普通",
                                        3 => "困難",
                                        _ => "未知"
                                    };

                                    var difficultyClass = level switch
                                    {
                                        1 => "difficulty-easy",
                                        2 => "difficulty-normal",
                                        3 => "difficulty-hard",
                                        _ => ""
                                    };

                                    var resultText = result.ToLower() switch
                                    {
                                        "win" or "success" => "通關",
                                        "lose" or "failure" => "未通關",
                                        "abort" => "已放棄",
                                        _ => "未知"
                                    };

                                    var resultBadgeClass = result.ToLower() switch
                                    {
                                        "win" or "success" => "result-win",
                                        "lose" or "failure" => "result-lose",
                                        "abort" => "result-abort",
                                        _ => ""
                                    };

                                    var resultIcon = result.ToLower() switch
                                    {
                                        "win" or "success" => "bi-check-circle-fill",
                                        "lose" or "failure" => "bi-x-circle-fill",
                                        "abort" => "bi-slash-circle-fill",
                                        _ => "bi-question-circle"
                                    };

                                    <tr>
                                        <td data-label="遊戲時間">
                                            @playTime.ToString("yyyy-MM-dd HH:mm")
                                        </td>
                                        <td data-label="難度">
                                            <span class="difficulty-badge @difficultyClass">
                                                Level @level - @difficultyText
                                            </span>
                                        </td>
                                        <td data-label="結果">
                                            <span class="result-badge @resultBadgeClass">
                                                <i class="bi @resultIcon"></i>
                                                @resultText
                                            </span>
                                        </td>
                                        <td data-label="獲得點數" style="text-align: center;">
                                            @if (pointsGained > 0)
                                            {
                                                <span style="color: var(--orange-accent); font-weight: 700;">
                                                    <i class="bi bi-coin me-1"></i>
                                                    +@pointsGained
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="color: #bdc3c7;">-</span>
                                            }
                                        </td>
                                        <td data-label="獲得經驗值" style="text-align: center;">
                                            @if (experienceGained > 0)
                                            {
                                                <span style="color: var(--teal-primary); font-weight: 700;">
                                                    <i class="bi bi-star-fill me-1"></i>
                                                    +@experienceGained
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="color: #bdc3c7;">-</span>
                                            }
                                        </td>
                                        <td data-label="詳細資訊">
                                            @if (spendTime > 0)
                                            {
                                                var minutes = spendTime / 60;
                                                var seconds = spendTime % 60;
                                                <small style="color: #7f8c8d;">
                                                    <i class="bi bi-hourglass-split me-1"></i>
                                                    耗時 @minutes 分 @seconds 秒
                                                </small>
                                            }
                                            else
                                            {
                                                <small style="color: #bdc3c7;">無額外資訊</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- 分頁 -->
                    @if (totalPages > 1)
                    {
                        <div class="pagination-wrapper">
                            <div class="pagination-info">
                                共 @totalRecords 筆記錄 | 第 @currentPage / @totalPages 頁
                            </div>

                            <!-- 上一頁 -->
                            @if (currentPage > 1)
                            {
                                <a href="@Url.Action("History", "Game", new { area = "MiniGame", page = currentPage - 1, level = selectedLevel, result = selectedResult, date = selectedDate })" class="pagination-btn">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            }
                            else
                            {
                                <button class="pagination-btn" disabled>
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                            }

                            <!-- 頁碼 -->
                            @for (int p = Math.Max(1, currentPage - 2); p <= Math.Min(totalPages, currentPage + 2); p++)
                            {
                                @if (p == currentPage)
                                {
                                    <button class="pagination-btn active">@p</button>
                                }
                                else
                                {
                                    <a href="@Url.Action("History", "Game", new { area = "MiniGame", page = p, level = selectedLevel, result = selectedResult, date = selectedDate })" class="pagination-btn">
                                        @p
                                    </a>
                                }
                            }

                            <!-- 下一頁 -->
                            @if (currentPage < totalPages)
                            {
                                <a href="@Url.Action("History", "Game", new { area = "MiniGame", page = currentPage + 1, level = selectedLevel, result = selectedResult, date = selectedDate })" class="pagination-btn">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            }
                            else
                            {
                                <button class="pagination-btn" disabled>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>暫無遊戲記錄</h5>
                        <p>還沒有遊戲記錄，前往遊戲頁面開始挑戰吧！</p>
                        <a href="@Url.Action("Index", "Game", new { area = "MiniGame" })" style="display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #0d9488 0%, #17a2b8 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600;">
                            <i class="bi bi-play-circle me-1"></i>
                            前往遊戲
                        </a>
                    </div>
                }
            </div>

            <!-- 統計概覽 -->
            @if (gameRecords.Any())
            {
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                    <!-- 統計項 1: 總遊戲次數 -->
                    <div style="background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); text-align: center;">
                        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="bi bi-controller me-1"></i>
                            總遊戲次數
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--teal-primary);">
                            @totalRecords
                        </div>
                    </div>

                    <!-- 統計項 2: 通關率 -->
                    <div style="background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); text-align: center;">
                        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="bi bi-percent me-1"></i>
                            通關率
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: #28a745;">
                            @{
                                var winCount = gameRecords.Count(r => ((string)r?.Result ?? "").ToLower() == "win" || ((string)r?.Result ?? "").ToLower() == "success");
                                var winRate = totalRecords > 0 ? Math.Round((double)winCount / totalRecords * 100, 1) : 0;
                            }
                            @(winRate)%
                        </div>
                    </div>

                    <!-- 統計項 3: 總點數獲得 -->
                    <div style="background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); text-align: center;">
                        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="bi bi-coin me-1"></i>
                            總點數獲得
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--orange-accent);">
                            @{
                                var totalPoints = gameRecords.Sum(r => (int?)r?.PointsGained ?? 0);
                            }
                            +@totalPoints
                        </div>
                    </div>

                    <!-- 統計項 4: 總經驗值獲得 -->
                    <div style="background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); text-align: center;">
                        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="bi bi-star-fill me-1"></i>
                            總經驗值獲得
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0d9488;">
                            @{
                                var totalExp = gameRecords.Sum(r => (int?)r?.ExperienceGained ?? 0);
                            }
                            +@totalExp
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="container py-5">
        <div style="background: white; border-radius: 24px; padding: 3rem; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
            <i class="bi bi-lock fs-1 text-muted mb-3 d-block"></i>
            <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">請先登入</h4>
            <p style="color: #7f8c8d; margin-bottom: 2rem;">登入後即可查看您的遊戲歷史記錄</p>
            <a href="/Login" class="btn" style="background: linear-gradient(135deg, #0d9488 0%, #17a2b8 100%); color: white; border-radius: 16px; padding: 0.75rem 2rem; font-weight: 600; text-decoration: none; display: inline-block;">
                <i class="bi bi-box-arrow-in-right me-2"></i>
                前往登入
            </a>
        </div>
    </div>
}
