@{
	ViewData["Title"] = "å•†åŸå„ªæƒ åˆ¸å…Œæ›";
	var userPoints = (int)((Dictionary<string, object>)Model)["UserPoints"];
	var couponTypes = (IEnumerable<GamiPort.Models.CouponType>)((Dictionary<string, object>)Model)["CouponTypes"];
	var evoucherTypes = (IEnumerable<GamiPort.Models.EvoucherType>)((Dictionary<string, object>)Model)["EVoucherTypes"];
}

<div class="container-fluid px-4">
	<!-- Anti-Forgery Token -->
	<div id="antiForgeryTokenContainer">
		@Html.AntiForgeryToken()
	</div>

	<h1 class="mt-4 text-info">
		<i class="fas fa-exchange-alt me-2"></i>å•†åŸå„ªæƒ åˆ¸å…Œæ›
	</h1>
	<ol class="breadcrumb mb-4">
		<li class="breadcrumb-item"><a asp-action="Index">éŒ¢åŒ…é¦–é </a></li>
		<li class="breadcrumb-item active">å•†åŸå„ªæƒ åˆ¸å…Œæ›</li>
	</ol>

	<!-- ç•¶å‰é»æ•¸é¡¯ç¤º -->
	<div class="row mb-4">
		<div class="col-lg-4 col-md-6">
			<div class="card bg-info text-white shadow">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<div class="text-white-50 small">æˆ‘çš„é»æ•¸</div>
							<div class="h2 mb-0" id="userPointsDisplay">@userPoints.ToString("N0")</div>
						</div>
						<div class="fs-1">
							<i class="fas fa-coins"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- å„ªæƒ åˆ¸å…Œæ›å€ -->
	<div class="card mb-4">
		<div class="card-header bg-info text-white">
			<i class="fas fa-ticket-alt me-2"></i>å„ªæƒ åˆ¸å…Œæ›
		</div>
		<div class="card-body">
			@if (couponTypes != null && couponTypes.Any())
			{
				<div class="row">
					@foreach (var coupon in couponTypes)
					{
						<div class="col-lg-4 col-md-6 mb-3">
							<div class="card h-100 border-info">
								<div class="card-body">
									<h5 class="card-title text-info">@coupon.Name</h5>
									<div class="mb-2">
										<span class="badge bg-secondary">@coupon.DiscountType</span>
									</div>
									<p class="card-text">
										<strong>@(coupon.DiscountType == "Percent" ? "æŠ˜æŠµæ¯”ç‡" : "æŠ˜æ‰£å€¼"):</strong>
										@if (coupon.DiscountType == "Percent")
										{
											var percentage = ((int)(coupon.DiscountValue * 100 ?? 0));
											<text>@percentage%</text>
										}
										else if (coupon.DiscountType == "Fixed")
										{
											var fixedValue = ((int)(coupon.DiscountValue ?? 0));
											<text>$@fixedValue</text>
										}
										else
										{
											var defaultValue = ((int)(coupon.DiscountValue ?? 0));
											<text>@defaultValue</text>
										}
										<br />
										<strong>æ‰€éœ€é»æ•¸:</strong> <span class="text-danger fw-bold">@coupon.PointsCost</span> é»<br />
										<strong>æœ‰æ•ˆæœŸ:</strong> @(((DateTime?)coupon.ValidFrom)?.ToString("yyyy/MM/dd") ?? "-") ~ @(((DateTime?)coupon.ValidTo)?.ToString("yyyy/MM/dd") ?? "-")
									</p>
									@if (!string.IsNullOrEmpty(coupon.Description))
									{
										<p class="card-text small text-muted">@coupon.Description</p>
									}
								</div>
								<div class="card-footer bg-transparent">
									<div class="input-group input-group-sm mb-2">
										<span class="input-group-text">æ•¸é‡</span>
										<input type="number" class="form-control" id="couponQty_@coupon.CouponTypeId"
											   value="1" min="1" max="100" />
									</div>
									<button class="btn btn-info btn-sm w-100 exchange-coupon-btn"
											data-coupon-id="@coupon.CouponTypeId"
											data-coupon-name="@coupon.Name"
											data-points-cost="@coupon.PointsCost">
										<i class="fas fa-shopping-cart me-1"></i>ç«‹å³å…Œæ›
									</button>
								</div>
							</div>
						</div>
					}
				</div>
			}
			else
			{
				<div class="alert alert-warning mb-0">
					<i class="fas fa-exclamation-triangle me-2"></i>ç›®å‰æš«ç„¡å¯å…Œæ›çš„å„ªæƒ åˆ¸
				</div>
			}
		</div>
	</div>

	<!-- é›»å­ç¦®åˆ¸å…Œæ›å€ -->
	<div class="card mb-4">
		<div class="card-header bg-info text-white">
			<i class="fas fa-gift me-2"></i>é›»å­ç¦®åˆ¸å…Œæ›
		</div>
		<div class="card-body">
			@if (evoucherTypes != null && evoucherTypes.Any())
			{
				<div class="row">
					@foreach (var evoucher in evoucherTypes)
					{
						<div class="col-lg-4 col-md-6 mb-3">
							<div class="card h-100 border-info">
								<div class="card-body">
									<h5 class="card-title text-info">@evoucher.Name</h5>
									<p class="card-text">
										<strong>é¢é¡:</strong> <span class="text-success fw-bold">$@evoucher.ValueAmount</span><br />
										<strong>æ‰€éœ€é»æ•¸:</strong> <span class="text-danger fw-bold">@evoucher.PointsCost</span> é»<br />
										<strong>å‰©é¤˜æ•¸é‡:</strong> @evoucher.TotalAvailable å¼µ<br />
										<strong>æœ‰æ•ˆæœŸ:</strong> @(((DateTime?)evoucher.ValidFrom)?.ToString("yyyy/MM/dd") ?? "-") ~ @(((DateTime?)evoucher.ValidTo)?.ToString("yyyy/MM/dd") ?? "-")
									</p>
									@if (!string.IsNullOrEmpty(evoucher.Description))
									{
										<p class="card-text small text-muted">@evoucher.Description</p>
									}
								</div>
								<div class="card-footer bg-transparent">
									<div class="input-group input-group-sm mb-2">
										<span class="input-group-text">æ•¸é‡</span>
										<input type="number" class="form-control" id="evoucherQty_@evoucher.EvoucherTypeId"
											   value="1" min="1" max="@Math.Min(100, evoucher.TotalAvailable)" />
									</div>
									<button class="btn btn-info btn-sm w-100 exchange-evoucher-btn"
											data-evoucher-id="@evoucher.EvoucherTypeId"
											data-evoucher-name="@evoucher.Name"
											data-points-cost="@evoucher.PointsCost"
											@(evoucher.TotalAvailable <= 0 ? "disabled" : "")>
										<i class="fas fa-shopping-cart me-1"></i>
										@(evoucher.TotalAvailable > 0 ? "ç«‹å³å…Œæ›" : "å·²å”®ç½„")
									</button>
								</div>
							</div>
						</div>
					}
				</div>
			}
			else
			{
				<div class="alert alert-warning mb-0">
					<i class="fas fa-exclamation-triangle me-2"></i>ç›®å‰æš«ç„¡å¯å…Œæ›çš„é›»å­ç¦®åˆ¸
				</div>
			}
		</div>
	</div>

	<!-- è¿”å›æŒ‰éˆ• -->
	<div class="mb-4">
		<a asp-action="Index" class="btn btn-secondary">
			<i class="fas fa-arrow-left me-1"></i>è¿”å›éŒ¢åŒ…é¦–é 
		</a>
	</div>
</div>

<!-- å…Œæ›çµæœ Modal -->
<div class="modal fade" id="exchangeResultModal" tabindex="-1" aria-labelledby="exchangeResultModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header" id="modalHeader">
				<h5 class="modal-title" id="exchangeResultModalLabel">å…Œæ›çµæœ</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="modalBody">
				<!-- å‹•æ…‹å…§å®¹ -->
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
				<a href="@Url.Action("Coupons")" class="btn btn-info" id="viewCouponsBtn" style="display:none;">
					æŸ¥çœ‹æˆ‘çš„å„ªæƒ åˆ¸
				</a>
				<a href="@Url.Action("EVouchers")" class="btn btn-info" id="viewEVouchersBtn" style="display:none;">
					æŸ¥çœ‹æˆ‘çš„é›»å­ç¦®åˆ¸
				</a>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		// ç•¶å‰ç”¨æˆ¶é»æ•¸
		let userPoints = @userPoints;

		// å„ªæƒ åˆ¸å…Œæ›
		document.querySelectorAll('.exchange-coupon-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const couponId = this.getAttribute('data-coupon-id');
				const couponName = this.getAttribute('data-coupon-name');
				const pointsCost = parseInt(this.getAttribute('data-points-cost'));
				const quantityInput = document.getElementById('couponQty_' + couponId);
				const quantity = parseInt(quantityInput.value);

				// é©—è­‰æ•¸é‡
				if (quantity < 1 || quantity > 100) {
					showErrorModal('å…Œæ›å¤±æ•—', 'å…Œæ›æ•¸é‡å¿…é ˆåœ¨ 1-100 ä¹‹é–“');
					return;
				}

				// æª¢æŸ¥é»æ•¸æ˜¯å¦è¶³å¤ 
				const totalCost = pointsCost * quantity;
				if (userPoints < totalCost) {
					showErrorModal('é»æ•¸ä¸è¶³', `å…Œæ› ${quantity} å¼µã€Œ${couponName}ã€éœ€è¦ ${totalCost.toLocaleString()} é»ï¼Œæ‚¨ç›®å‰åªæœ‰ ${userPoints.toLocaleString()} é»`);
					return;
				}

				// ç¢ºèªå…Œæ›
				if (!confirm(`ç¢ºå®šè¦ä½¿ç”¨ ${totalCost.toLocaleString()} é»å…Œæ› ${quantity} å¼µã€Œ${couponName}ã€å—ï¼Ÿ`)) {
					return;
				}

				// åŸ·è¡Œå…Œæ›
				this.disabled = true;
				this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>å…Œæ›ä¸­...';

				// ç²å–CSRF Tokenä¸¦é©—è­‰
				const tokenInput = document.querySelector('#antiForgeryTokenContainer input[name="__RequestVerificationToken"]');
				if (!tokenInput || !tokenInput.value) {
					console.error('CSRF Token not found!');
					showErrorModal('ç³»çµ±éŒ¯èª¤', 'å®‰å…¨é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦');
					this.disabled = false;
					this.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>ç«‹å³å…Œæ›';
					return;
				}
				const token = tokenInput.value;
				const requestBody = `couponTypeId=${couponId}&quantity=${quantity}&__RequestVerificationToken=${encodeURIComponent(token)}`;
				console.log('ğŸ“¤ ç™¼é€è«‹æ±‚:', {
					url: '@Url.Action("ExchangeForCoupon", "Wallet")',
					method: 'POST',
					couponId: couponId,
					quantity: quantity,
					bodyLength: requestBody.length
				});

				fetch('@Url.Action("ExchangeForCoupon", "Wallet")', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: requestBody
				})
				.then(response => {
					console.log('ğŸ“¥ æ”¶åˆ°éŸ¿æ‡‰:', {
						status: response.status,
						statusText: response.statusText,
						ok: response.ok
					});
					return response.json();
				})
				.then(data => {
					console.log('ğŸ“‹ éŸ¿æ‡‰æ•¸æ“š:', data);
					if (data.success) {
						// æ›´æ–°é»æ•¸é¡¯ç¤º
						userPoints -= totalCost;
						document.getElementById('userPointsDisplay').textContent = userPoints.toLocaleString();

						// é¡¯ç¤ºæˆåŠŸè¨Šæ¯
						showSuccessModal('å…Œæ›æˆåŠŸ', data.message, data.couponCodes, 'coupon');
					} else {
						console.error('âŒ å…Œæ›å¤±æ•—:', data.message);
						showErrorModal('å…Œæ›å¤±æ•—', data.message);
					}
				})
				.catch(error => {
					console.error('âŒ è«‹æ±‚éŒ¯èª¤:', error);
					showErrorModal('ç³»çµ±éŒ¯èª¤', 'å…Œæ›éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
				})
				.finally(() => {
					this.disabled = false;
					this.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>ç«‹å³å…Œæ›';
				});
			});
		});

		// é›»å­ç¦®åˆ¸å…Œæ›
		document.querySelectorAll('.exchange-evoucher-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const evoucherId = this.getAttribute('data-evoucher-id');
				const evoucherName = this.getAttribute('data-evoucher-name');
				const pointsCost = parseInt(this.getAttribute('data-points-cost'));
				const quantityInput = document.getElementById('evoucherQty_' + evoucherId);
				const quantity = parseInt(quantityInput.value);

				// é©—è­‰æ•¸é‡
				if (quantity < 1 || quantity > 100) {
					showErrorModal('å…Œæ›å¤±æ•—', 'å…Œæ›æ•¸é‡å¿…é ˆåœ¨ 1-100 ä¹‹é–“');
					return;
				}

				// æª¢æŸ¥é»æ•¸æ˜¯å¦è¶³å¤ 
				const totalCost = pointsCost * quantity;
				if (userPoints < totalCost) {
					showErrorModal('é»æ•¸ä¸è¶³', `å…Œæ› ${quantity} å¼µã€Œ${evoucherName}ã€éœ€è¦ ${totalCost.toLocaleString()} é»ï¼Œæ‚¨ç›®å‰åªæœ‰ ${userPoints.toLocaleString()} é»`);
					return;
				}

				// ç¢ºèªå…Œæ›
				if (!confirm(`ç¢ºå®šè¦ä½¿ç”¨ ${totalCost.toLocaleString()} é»å…Œæ› ${quantity} å¼µã€Œ${evoucherName}ã€å—ï¼Ÿ`)) {
					return;
				}

				// åŸ·è¡Œå…Œæ›
				this.disabled = true;
				this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>å…Œæ›ä¸­...';

				// ç²å–CSRF Tokenä¸¦é©—è­‰
				const tokenInput = document.querySelector('#antiForgeryTokenContainer input[name="__RequestVerificationToken"]');
				if (!tokenInput || !tokenInput.value) {
					console.error('CSRF Token not found!');
					showErrorModal('ç³»çµ±éŒ¯èª¤', 'å®‰å…¨é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦');
					this.disabled = false;
					this.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>ç«‹å³å…Œæ›';
					return;
				}
				const token = tokenInput.value;
				fetch('@Url.Action("ExchangeForEVoucher", "Wallet")', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: `evoucherTypeId=${evoucherId}&quantity=${quantity}&__RequestVerificationToken=${encodeURIComponent(token)}`
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						// æ›´æ–°é»æ•¸é¡¯ç¤º
						userPoints -= totalCost;
						document.getElementById('userPointsDisplay').textContent = userPoints.toLocaleString();

						// é¡¯ç¤ºæˆåŠŸè¨Šæ¯
						showSuccessModal('å…Œæ›æˆåŠŸ', data.message, data.evoucherCodes, 'evoucher');
					} else {
						showErrorModal('å…Œæ›å¤±æ•—', data.message);
					}
				})
				.catch(error => {
					console.error('Error:', error);
					showErrorModal('ç³»çµ±éŒ¯èª¤', 'å…Œæ›éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
				})
				.finally(() => {
					this.disabled = false;
					this.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>ç«‹å³å…Œæ›';
				});
			});
		});

		// é¡¯ç¤ºæˆåŠŸ Modal
		function showSuccessModal(title, message, codes, type) {
			const modal = new bootstrap.Modal(document.getElementById('exchangeResultModal'));
			const modalHeader = document.getElementById('modalHeader');
			const modalBody = document.getElementById('modalBody');

			modalHeader.className = 'modal-header bg-success text-white';
			document.getElementById('exchangeResultModalLabel').textContent = title;

			let codesHtml = '';
			if (codes && codes.length > 0) {
				codesHtml = '<div class="mt-3"><strong>å…Œæ›ä»£ç¢¼ï¼š</strong><ul class="mb-0">';
				codes.forEach(code => {
					codesHtml += `<li><code class="text-dark">${code}</code></li>`;
				});
				codesHtml += '</ul></div>';
			}

			modalBody.innerHTML = `
				<div class="alert alert-success mb-0">
					<i class="fas fa-check-circle me-2"></i>${message}
				</div>
				${codesHtml}
			`;

			// é¡¯ç¤ºå°æ‡‰çš„æŸ¥çœ‹æŒ‰éˆ•
			if (type === 'coupon') {
				document.getElementById('viewCouponsBtn').style.display = 'inline-block';
				document.getElementById('viewEVouchersBtn').style.display = 'none';
			} else {
				document.getElementById('viewCouponsBtn').style.display = 'none';
				document.getElementById('viewEVouchersBtn').style.display = 'inline-block';
			}

			modal.show();
		}

		// é¡¯ç¤ºéŒ¯èª¤ Modal
		function showErrorModal(title, message) {
			const modal = new bootstrap.Modal(document.getElementById('exchangeResultModal'));
			const modalHeader = document.getElementById('modalHeader');
			const modalBody = document.getElementById('modalBody');

			modalHeader.className = 'modal-header bg-danger text-white';
			document.getElementById('exchangeResultModalLabel').textContent = title;

			modalBody.innerHTML = `
				<div class="alert alert-danger mb-0">
					<i class="fas fa-exclamation-circle me-2"></i>${message}
				</div>
			`;

			// éš±è—æŸ¥çœ‹æŒ‰éˆ•
			document.getElementById('viewCouponsBtn').style.display = 'none';
			document.getElementById('viewEVouchersBtn').style.display = 'none';

			modal.show();
		}
	</script>
}
