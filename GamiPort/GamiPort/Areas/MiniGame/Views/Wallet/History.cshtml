@using GamiPort.Models
@using GamiPort.Areas.MiniGame.Helpers
@{
	ViewData["Title"] = "éŒ¢åŒ…äº¤æ˜“æ­·å²";
	dynamic viewData = (dynamic)Model;
	var items = viewData.Items as List<WalletHistory> ?? new List<WalletHistory>();
	var currentPoints = (int)viewData.CurrentPoints;
	var pagination = viewData.Pagination;
	var filters = viewData.Filters;

	var pageNumber = (int)pagination.PageNumber;
	var pageSize = (int)pagination.PageSize;
	var totalCount = (int)pagination.TotalCount;
	var totalPages = (int)pagination.TotalPages;
	var hasPreviousPage = (bool)pagination.HasPreviousPage;
	var hasNextPage = (bool)pagination.HasNextPage;

	var changeType = filters.ChangeType as string;
	var startDate = filters.StartDate as DateTime?;
	var endDate = filters.EndDate as DateTime?;
	var searchTerm = filters.SearchTerm as string;
}

<div class="container-fluid px-4">
	<h1 class="mt-4 text-info">
		<i class="fas fa-history me-2"></i>éŒ¢åŒ…äº¤æ˜“æ­·å²
	</h1>
	<ol class="breadcrumb mb-4">
		<li class="breadcrumb-item"><a asp-action="Index">éŒ¢åŒ…é¦–é </a></li>
		<li class="breadcrumb-item active">äº¤æ˜“æ­·å²</li>
	</ol>

	<!-- ç•¶å‰é»æ•¸å¡ç‰‡ -->
	<div class="row mb-4">
		<div class="col-lg-4 col-md-6">
			<div class="card bg-info text-white shadow">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<div class="text-white-50 small">ç•¶å‰é»æ•¸</div>
							<div class="h2 mb-0">@currentPoints.ToString("N0")</div>
						</div>
						<div class="fs-1">
							<i class="fas fa-coins"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- ç¯©é¸å™¨å€åŸŸ -->
	<div class="card mb-4">
		<div class="card-header bg-info text-white">
			<i class="fas fa-filter me-2"></i>ç¯©é¸èˆ‡æœå°‹
		</div>
		<div class="card-body">
			<form method="get" asp-action="History" id="filterForm">
				<div class="row g-3">
					<!-- äº¤æ˜“é¡å‹ç¯©é¸ -->
					<div class="col-md-3">
						<label for="changeType" class="form-label">äº¤æ˜“é¡å‹</label>
						<select class="form-select" id="changeType" name="changeType">
							<option value="">å…¨éƒ¨é¡å‹</option>
							<option value="Point" selected="@(changeType == "Point")">ğŸ’° é»æ•¸äº¤æ˜“</option>
							<option value="Coupon" selected="@(changeType == "Coupon")">ğŸ« å„ªæƒ åˆ¸</option>
							<option value="EVoucher" selected="@(changeType == "EVoucher")">ğŸ é›»å­ç¦®åˆ¸</option>
							<option value="Pet" selected="@(changeType == "Pet")">ğŸ¾ å¯µç‰©</option>
							<option value="SignIn" selected="@(changeType == "SignIn")">âœ… ç°½åˆ°</option>
						</select>
					</div>

					<!-- é–‹å§‹æ—¥æœŸ -->
					<div class="col-md-3">
						<label for="startDate" class="form-label">é–‹å§‹æ—¥æœŸ</label>
						<input type="date" class="form-control" id="startDate" name="startDate"
							   value="@(startDate?.ToString("yyyy-MM-dd"))" />
					</div>

					<!-- çµæŸæ—¥æœŸ -->
					<div class="col-md-3">
						<label for="endDate" class="form-label">çµæŸæ—¥æœŸ</label>
						<input type="date" class="form-control" id="endDate" name="endDate"
							   value="@(endDate?.ToString("yyyy-MM-dd"))" />
					</div>

					<!-- æ¯é ç­†æ•¸ -->
					<div class="col-md-3">
						<label for="pageSize" class="form-label">æ¯é ç­†æ•¸</label>
						<select class="form-select" id="pageSize" name="pageSize">
							<option value="10" selected="@(pageSize == 10)">10</option>
							<option value="20" selected="@(pageSize == 20)">20</option>
							<option value="50" selected="@(pageSize == 50)">50</option>
							<option value="100" selected="@(pageSize == 100)">100</option>
						</select>
					</div>

					<!-- æœå°‹é—œéµå­— -->
					<div class="col-12">
						<label for="searchTerm" class="form-label">æœå°‹é—œéµå­—ï¼ˆæè¿°æˆ–ä»£ç¢¼ï¼‰</label>
						<div class="input-group">
							<span class="input-group-text bg-info text-white">
								<i class="fas fa-search"></i>
							</span>
							<input type="text" class="form-control" id="searchTerm" name="searchTerm"
								   value="@searchTerm" placeholder="æ”¯æ´æ¨¡ç³Šæœå°‹..." />
							<button class="btn btn-info" type="submit">
								<i class="fas fa-filter me-1"></i>å¥—ç”¨ç¯©é¸
							</button>
							<a href="@Url.Action("History")" class="btn btn-outline-secondary">
								<i class="fas fa-redo me-1"></i>é‡ç½®
							</a>
						</div>
						<div class="form-text">
							<i class="fas fa-lightbulb text-warning"></i>
							æ”¯æ´ 5 ç´šæ¨¡ç³Šæœå°‹ï¼šç²¾ç¢ºåŒ¹é… > é–‹é ­åŒ¹é… > åŒ…å«åŒ¹é… > ç·¨è¼¯è·é›¢ â‰¤ 2 > éƒ¨åˆ†è©çµ„åŒ¹é…
						</div>
					</div>
				</div>

				<!-- éš±è—çš„ pageNumber æ¬„ä½ -->
				<input type="hidden" name="pageNumber" value="1" />
			</form>
		</div>
	</div>

	<!-- çµæœæ‘˜è¦ -->
	<div class="alert alert-info">
		<i class="fas fa-info-circle me-2"></i>
		å…±æ‰¾åˆ° <strong>@totalCount</strong> ç­†äº¤æ˜“è¨˜éŒ„
		@if (!string.IsNullOrEmpty(searchTerm))
		{
			<span>ï¼ˆæœå°‹é—œéµå­—ï¼šã€Œ<strong>@searchTerm</strong>ã€ï¼‰</span>
		}
	</div>

	<!-- äº¤æ˜“è¨˜éŒ„è¡¨æ ¼ -->
	@if (items.Any())
	{
		<div class="card mb-4">
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-hover mb-0">
						<thead class="table-info">
							<tr>
								<th>æ™‚é–“</th>
								<th>é¡å‹</th>
								<th class="text-end">é»æ•¸è®Šå‹•</th>
								<th>é …ç›®ä»£ç¢¼</th>
								<th>æè¿°</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var item in items)
							{
								var isPositive = item.PointsChanged > 0;
								var changeClass = isPositive ? "text-success" : "text-danger";
								var changeIcon = isPositive ? "fa-arrow-up" : "fa-arrow-down";

								<tr>
									<td class="text-nowrap">
										<small>@(((DateTime?)item.ChangeTime)?.ToString("yyyy-MM-dd") ?? "-")</small><br />
										<small class="text-muted">@(((DateTime?)item.ChangeTime)?.ToString("HH:mm:ss") ?? "-")</small>
									</td>
									<td>
										@{
											var description = item.Description ?? "";
											var itemCode = item.ItemCode ?? "";
											var isExchangeCoupon = description.Contains("å…Œæ›å„ªæƒ åˆ¸") || description.Contains("å…Œæ›å•†åŸå„ªæƒ åˆ¸");
											var isExchangeEVoucher = description.Contains("å…Œæ›é›»å­ç¦®åˆ¸") || description.Contains("å…Œæ›ç¦®åˆ¸");
											var isSignIn = description.Contains("ç°½åˆ°");
											// å¯µç‰©åˆ¤æ–·ï¼šChangeType æˆ– ItemCode ä»¥ PET- é–‹é ­ æˆ– Description åŒ…å«ã€Œå¯µç‰©ã€
											var isPet = item.ChangeType == "Pet"
												|| item.ChangeType == "PetSkinColor"
												|| item.ChangeType == "PetBackground"
												|| itemCode.StartsWith("PET-")
												|| itemCode.StartsWith("PET_")
												|| description.Contains("å¯µç‰©");
										}
										@if (isSignIn && item.ChangeType == "Point")
										{
											@* ç°½åˆ°çå‹µï¼ˆé»æ•¸ï¼‰ï¼šé¡¯ç¤ºç°½åˆ° + é»æ•¸ *@
											<span class="badge bg-success me-1">
												<i class="fas fa-check-circle"></i> ç°½åˆ°
											</span>
											<span class="badge bg-primary">
												<i class="fas fa-coins"></i> é»æ•¸
											</span>
										}
										else if (isSignIn && item.ChangeType == "Coupon")
										{
											@* ç°½åˆ°çå‹µï¼ˆå„ªæƒ åˆ¸ï¼‰ï¼šé¡¯ç¤ºç°½åˆ° + å„ªæƒ åˆ¸ *@
											<span class="badge bg-success me-1">
												<i class="fas fa-check-circle"></i> ç°½åˆ°
											</span>
											<span class="badge bg-warning text-dark">
												<i class="fas fa-ticket-alt"></i> å„ªæƒ åˆ¸
											</span>
										}
										else if (isPet)
										{
											@* å¯µç‰©ç›¸é—œï¼šé¡¯ç¤ºå¯µç‰© badge *@
											<span class="badge bg-info me-1">
												<i class="fas fa-paw"></i> å¯µç‰©
											</span>
											@if (item.PointsChanged != 0)
											{
												<span class="badge bg-primary">
													<i class="fas fa-coins"></i> é»æ•¸
												</span>
											}
										}
										else if (isExchangeCoupon)
										{
											@* å…Œæ›å„ªæƒ åˆ¸ï¼šåŒæ™‚é¡¯ç¤ºé»æ•¸ + å„ªæƒ åˆ¸ *@
											<span class="badge bg-primary me-1">
												<i class="fas fa-coins"></i> é»æ•¸
											</span>
											<span class="badge bg-warning text-dark">
												<i class="fas fa-ticket-alt"></i> å„ªæƒ åˆ¸
											</span>
										}
										else if (isExchangeEVoucher)
										{
											@* å…Œæ›é›»å­ç¦®åˆ¸ï¼šåŒæ™‚é¡¯ç¤ºé»æ•¸ + é›»å­ç¦®åˆ¸ *@
											<span class="badge bg-primary me-1">
												<i class="fas fa-coins"></i> é»æ•¸
											</span>
											<span class="badge bg-danger">
												<i class="fas fa-gift"></i> é›»å­ç¦®åˆ¸
											</span>
										}
										else if (item.ChangeType == "Point")
										{
											<span class="badge bg-primary">
												<i class="fas fa-coins"></i> é»æ•¸
											</span>
										}
										else if (item.ChangeType == "Coupon")
										{
											<span class="badge bg-warning text-dark">
												<i class="fas fa-ticket-alt"></i> å„ªæƒ åˆ¸
											</span>
										}
										else if (item.ChangeType == "EVoucher")
										{
											<span class="badge bg-danger">
												<i class="fas fa-gift"></i> é›»å­ç¦®åˆ¸
											</span>
										}
										else
										{
											<span class="badge bg-secondary">@item.ChangeType</span>
										}
									</td>
									<td class="text-end fw-bold @changeClass">
										<i class="fas @changeIcon me-1"></i>
										@(isPositive ? "+" : "")@(((int?)item.PointsChanged)?.ToString("N0") ?? "0")
									</td>
									<td>
										@if (!string.IsNullOrEmpty(item.ItemCode))
										{
											<code class="small">@item.ItemCode</code>
										}
										else
										{
											<span class="text-muted">-</span>
										}
									</td>
									<td>@item.Description</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- åˆ†é æ§åˆ¶ -->
		@if (totalPages > 1)
		{
			<nav aria-label="é ç¢¼å°èˆª">
				<ul class="pagination justify-content-center">
					<!-- ç¬¬ä¸€é  -->
					<li class="page-item @(!hasPreviousPage ? "disabled" : "")">
						<a class="page-link" href="@BuildPageUrl(1, pageSize, changeType, startDate, endDate, searchTerm)" aria-label="ç¬¬ä¸€é ">
							<i class="fas fa-angle-double-left"></i>
						</a>
					</li>

					<!-- ä¸Šä¸€é  -->
					<li class="page-item @(!hasPreviousPage ? "disabled" : "")">
						<a class="page-link" href="@BuildPageUrl(pageNumber - 1, pageSize, changeType, startDate, endDate, searchTerm)" aria-label="ä¸Šä¸€é ">
							<i class="fas fa-angle-left"></i>
						</a>
					</li>

					<!-- é ç¢¼ -->
					@{
						var startPage = Math.Max(1, pageNumber - 2);
						var endPage = Math.Min(totalPages, pageNumber + 2);

						for (int i = startPage; i <= endPage; i++)
						{
							<li class="page-item @(i == pageNumber ? "active" : "")">
								<a class="page-link" href="@BuildPageUrl(i, pageSize, changeType, startDate, endDate, searchTerm)">@i</a>
							</li>
						}
					}

					<!-- ä¸‹ä¸€é  -->
					<li class="page-item @(!hasNextPage ? "disabled" : "")">
						<a class="page-link" href="@BuildPageUrl(pageNumber + 1, pageSize, changeType, startDate, endDate, searchTerm)" aria-label="ä¸‹ä¸€é ">
							<i class="fas fa-angle-right"></i>
						</a>
					</li>

					<!-- æœ€å¾Œä¸€é  -->
					<li class="page-item @(!hasNextPage ? "disabled" : "")">
						<a class="page-link" href="@BuildPageUrl(totalPages, pageSize, changeType, startDate, endDate, searchTerm)" aria-label="æœ€å¾Œä¸€é ">
							<i class="fas fa-angle-double-right"></i>
						</a>
					</li>
				</ul>
			</nav>

			<div class="text-center text-muted mb-3">
				ç¬¬ @pageNumber é ï¼Œå…± @totalPages é ï¼ˆå…± @totalCount ç­†ï¼‰
			</div>
		}
	}
	else
	{
		<div class="alert alert-warning">
			<i class="fas fa-exclamation-triangle me-2"></i>
			@if (!string.IsNullOrEmpty(searchTerm) || changeType != null || startDate.HasValue || endDate.HasValue)
			{
				<span>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„äº¤æ˜“è¨˜éŒ„ï¼Œè«‹èª¿æ•´ç¯©é¸æ¢ä»¶å¾Œé‡è©¦ã€‚</span>
			}
			else
			{
				<span>æ‚¨ç›®å‰é‚„æ²’æœ‰ä»»ä½•äº¤æ˜“è¨˜éŒ„ã€‚</span>
			}
		</div>
	}

	<!-- è¿”å›æŒ‰éˆ• -->
	<div class="mb-4">
		<a asp-action="Index" class="btn btn-secondary">
			<i class="fas fa-arrow-left me-1"></i>è¿”å›éŒ¢åŒ…é¦–é 
		</a>
	</div>
</div>

@functions {
	string BuildPageUrl(int page, int pageSize, string changeType, DateTime? startDate, DateTime? endDate, string searchTerm)
	{
		var urlParams = new Dictionary<string, string>
		{
			{ "pageNumber", page.ToString() },
			{ "pageSize", pageSize.ToString() }
		};

		if (!string.IsNullOrEmpty(changeType))
			urlParams["changeType"] = changeType;

		if (startDate.HasValue)
			urlParams["startDate"] = startDate.Value.ToString("yyyy-MM-dd");

		if (endDate.HasValue)
			urlParams["endDate"] = endDate.Value.ToString("yyyy-MM-dd");

		if (!string.IsNullOrEmpty(searchTerm))
			urlParams["searchTerm"] = searchTerm;

		var queryString = string.Join("&", urlParams.Select(kvp => $"{kvp.Key}={Uri.EscapeDataString(kvp.Value)}"));
		return $"{Url.Action("History")}?{queryString}";
	}
}

@section Scripts {
	<script>
		// ç•¶ç¯©é¸å™¨è®Šæ›´æ™‚ï¼Œè‡ªå‹•å°‡é ç¢¼é‡ç½®ç‚º 1
		document.getElementById('changeType').addEventListener('change', function() {
			document.querySelector('input[name="pageNumber"]').value = '1';
		});

		document.getElementById('pageSize').addEventListener('change', function() {
			document.querySelector('input[name="pageNumber"]').value = '1';
			document.getElementById('filterForm').submit();
		});
	</script>
}
