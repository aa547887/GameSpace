@{
    ViewData["Title"] = "ç€è¦½å•†å“ - GamiStore";
    Layout = "~/Areas/OnlineStore/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" >
        /* ç‰ˆé ­æœå°‹ï¼‹å·¥å…·åˆ— */
        .tools-sticky {
            position: sticky;
            top: 64px;
            z-index: 1;
            background: var(--bs-body-bg);
        }

        /* å¡ç‰‡ç‰†ï¼ˆå·´å“ˆé¢¨æ ¼èåˆï¼‰ */
        #product-list .card {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
            background: rgba(255,255,255,.92);
            box-shadow: 0 6px 16px rgba(0,0,0,.07);
            transition: transform .18s ease, box-shadow .18s ease;
        }

            #product-list .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 14px 28px rgba(0,0,0,.14);
            }

        .card-img-hold {
            position: relative;
            padding-top: 80%;
            background: #f6f6f8;
        }

            .card-img-hold img {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform .25s ease;
            }

        .card:hover .card-img-hold img {
            transform: scale(1.06);
        }

        /* å‘¼å¸å…‰æšˆ */
        .card:hover::after {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 1rem;
            box-shadow: 0 0 0 0 rgba(0,153,255,.25);
            animation: pulse 1s ease-out;
            z-index: -1;
        }

        @@keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0,153,255,.25);
            }

            100% {
                box-shadow: 0 0 0 18px rgba(0,153,255,0);
            }
        }

        /* æ‡¸æµ®é¡¯ç¤ºå¿«é€Ÿæ“ä½œ */
        .quick-ops {
            position: absolute;
            left: .5rem;
            right: .5rem;
            bottom: .5rem;
            display: flex;
            gap: .5rem;
            opacity: 0;
            transform: translateY(8px);
            transition: all .18s ease;
            pointer-events: none;
        }

        .quick-ops .btn:hover {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        .card:hover .quick-ops {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .badge-type {
            position: absolute;
            top: .5rem;
            left: .5rem;
            backdrop-filter: blur(4px);
        }

        .badge-fav {
            position: absolute;
            top: .5rem;
            right: .5rem;
            background: rgba(255,255,255,.9);
            border-radius: 999px;
            width: 36px;
            height: 36px;
            display: grid;
            place-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,.15);
        }

        /* é ç•™åº•éƒ¨ç©ºé–“ï¼Œé¿å…æµ®ç¾æŒ‰éˆ•é®ä½è³‡è¨Š */
        #product-list .card .card-body {
            padding-bottom: 4rem; /* Reverted padding */
        }

        .badge-fav.is-favorited .bi-heart-fill {
            color: #e83e8c; /* Pink color for favorited heart */
        }

        .sticky-side {
            position: sticky;
            top: 64px;
        }

        /* åˆ†é  */
        .pagination .page-link {
            border-radius: .5rem;
        }

        /* æ–°å¢çš„åœ–ç‰‡æ¨å»£å€å¡Šæ¨£å¼ */
        .image-promo-block {
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem; /* å€å¡Šé–“è· */
            border-radius: 0.5rem; /* åœ“è§’ */
            box-shadow: 0 2px 8px rgba(0,0,0,.1); /* é™°å½± */
            cursor: pointer; /* é¡¯ç¤ºå¯é»æ“Šæ¸¸æ¨™ */
        }

        .image-promo-block img {
            width: 100%;
            height: auto;
            display: block;
            transition: filter 0.3s ease-in-out; /* é£½å’Œåº¦éæ¸¡ */
        }

        .image-promo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é®ç½© */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; /* é è¨­éš±è— */
            transition: opacity 0.3s ease-in-out; /* é®ç½©éæ¸¡ */
        }

        .image-promo-block:hover .image-promo-overlay {
            opacity: 1; /* æ‡¸åœæ™‚é¡¯ç¤º */
        }

        .image-promo-block:hover img {
            filter: grayscale(80%); /* æ‡¸åœæ™‚é™ä½é£½å’Œåº¦ */
        }

        .overlay-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 0.5rem;
        }
        .py-1-5mm {
            padding-top: 1.5mm !important;
            padding-bottom: 1.5mm !important;
        }
        /* Pills (æœå‡æ„Ÿæ¨™ç±¤) */
        .tag-pill {
            display: inline-block;
            padding: .15rem .5rem;
            border-radius: 999px;
            background: rgba(255,255,255,.65);
            backdrop-filter: blur(6px) saturate(120%);
            border: 1px solid rgba(0,0,0,.06);
            box-shadow: 0 2px 6px rgba(0,0,0,.06) inset, 0 1px 3px rgba(0,0,0,.05);
            font-size: .75rem;
            line-height: 1;
        }
        .tag-pill + .tag-pill { margin-left: .25rem; }
        .tag-pill--platform { color: #0b5ed7; border-color: rgba(13,110,253,.25); background: rgba(13,110,253,.08); }
        .tag-pill--genre { color: #0a7d2b; border-color: rgba(25,135,84,.25); background: rgba(25,135,84,.08); }
        .tag-pill--merch { color: #b23a48; border-color: rgba(214,51,132,.25); background: rgba(214,51,132,.08); }

        @@keyframes cute-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .cute-bounce-animation {
            animation: cute-bounce 0.3s ease-in-out;
        }



        /* Swal å°å‹•ç•«ï¼šè³¼ç‰©è»Š wiggle */
        @@keyframes cart-wiggle {
            0%, 100%

        {
            transform: rotate(0);
        }

        25% {
            transform: rotate(-12deg);
        }

        75% {
            transform: rotate(12deg);
        }

        }

        .swal-cart {
            display: inline-block;
            font-size: 42px;
            animation: cart-wiggle .6s ease-in-out infinite;
        }
    </style>
}

<div class="container-xxl py-3">
    <!--container-xxl- ->é€™æ˜¯æœƒå½±éŸ¿å¤§å°åˆ‡æ›æ™‚æœ‰æ²’æœ‰å…¨æ»¿é¢-->
    <div class="row g-3">
        <!-- å´é‚Šåˆ†é¡ï¼ˆä¿ç•™ä½ï¼‰ -->
        <aside class="col-lg-2 d-none d-lg-block ">
            <div class="sticky-side ">
                
                <div class="image-promo-block">
                    <a href="#link1">
                        <img src="/images/onlinestoreleftad/æ–°å“ä¸Šæ¶.png" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">æ–°å“ä¸Šæ¶</span>
                        </div>
                    </a>
                </div>
                <div class="image-promo-block ">
                    <a href="https://store.steampowered.com/">
                        <img src="/images/onlinestoreleftad/é€£çµSteam.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">Steam å®˜ç¶²</span>
                        </div>
                    </a>
                </div>
                <div class="image-promo-block ">
                    <a href="https://www.playstation.com/zh-hant-tw/">
                        <img src="/images/onlinestoreleftad/é€£çµPlaystation.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">PlayStation å®˜ç¶²</span>
                        </div>
                    </a>
                </div>
                <div class="image-promo-block ">
                    <a href="https://www.nintendo.com/tw/">
                        <img src="/images/onlinestoreleftad/é€£çµä»»å¤©å ‚.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">ä»»å¤©å ‚ å®˜ç¶²</span>
                        </div>
                    </a>
                </div>
            </div>
        </aside>

        <!-- ä¸»å…§å®¹ -->
        <div class="col-12 col-lg-8">
            <div class="tools-sticky py-1-5mm mb-2 d-flex flex-wrap gap-2 align-items-center justify-content-center">
                <div class="input-group shadow rounded-pill" style="max-width:560px">
                    <input id="q" class="form-control rounded-start-pill px-4" placeholder="æœå°‹å•†å“/é—œéµå­—">
                    <button id="btnSearch" class="btn btn-light rounded-end-pill px-4"><i class="bi bi-search"></i></button>
                </div>
                <select id="sort" class="form-select form-select-sm" style="width:auto">
                    <option value="newest">æœ€æ–°</option>
                    <option value="price_asc">åƒ¹æ ¼ â†‘</option>
                    <option value="price_desc">åƒ¹æ ¼ â†“</option>
                </select>
                <select id="pageSize" class="form-select form-select-sm" style="width:auto">
                    <option value="20" selected>20</option>
                    <option value="40">40</option>
                    <option value="60">60</option>
                    <option value="80">80</option>
                </select>
            </div>

            <div id="product-list" class="row g-3"></div>
            <nav class="mt-3"><ul class="pagination pagination-sm justify-content-center" id="pager"></ul></nav>
        </div>

        <!-- å³å´å»£å‘Šæ¬„ -->
        <div class="col-lg-2 d-none d-lg-block">
            <div class="sticky-side">
                @* è‹¥ä½ æœ‰å…±ç”¨ Partialï¼Œæ”¹æˆ Partialï¼š *@
                @* @await Html.PartialAsync("_RightRailAds") *@
                @await Html.PartialAsync("/Areas/OnlineStore/Views/Shared/_RightRailAds.v2.cshtml")
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const api = "/OnlineStore/api/StoreApi/products";
        const API_BASE = "/OnlineStore/api/StoreApi";
        const favSet = new Set();

        async function syncFavHighlight(){
          try{
            const r = await fetch(`${API_BASE}/favorites/ids`);
            if(!r.ok) return;
            const ids = await r.json();
            favSet.clear(); ids.forEach(id=>favSet.add(id));
            document.querySelectorAll('#product-list [data-action="fav"][data-id]').forEach(a=>{
              const id = parseInt(a.dataset.id,10);
              const icon = a.querySelector('i');
              if(favSet.has(id)){
                a.classList.add('is-favorited');
                icon?.classList.add('bi-heart-fill');
                icon?.classList.remove('bi-heart');
              }else{
                a.classList.remove('is-favorited');
                icon?.classList.remove('bi-heart-fill');
                icon?.classList.add('bi-heart');
              }
            });
          }catch{}
        }

        function ensureLoginPrompt(){
          if(document.getElementById('loginPromptModal')) return;
          const el = document.createElement('div');
          el.innerHTML = `
            <div class="modal fade" id="loginPromptModal" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">è«‹å…ˆç™»å…¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p class="mb-0">æ‚¨éœ€è¦ç™»å…¥å¾Œæ‰èƒ½ä½¿ç”¨æ”¶è—åŠŸèƒ½ã€‚</p>
                  </div>
                  <div class="modal-footer">
                    <a class="btn btn-dark" href="/Login/Login/Login">ç¾åœ¨å»ç™»å…¥</a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ç¨å¾Œå†çœ‹çœ‹</button>
                  </div>
                </div>
              </div>
            </div>`;
          document.body.appendChild(el.firstElementChild);
        }

        const PLACEHOLDER = "/images/onlinestoreNOPic/nophoto.jpg";
        const params = new URLSearchParams(location.search);
        let state = {
          q: params.get("q") || "",
          type: params.get("type") || "",
          platformId: parseInt(params.get("platformId") || "", 10) || "",
          genreId: parseInt(params.get("genreId") || "", 10) || "",
          merchTypeId: parseInt(params.get("merchTypeId") || "", 10) || "",
          supplierId: parseInt(params.get("supplierId") || "", 10) || "",
          platform: params.get("platform") || "",
          genre: params.get("genre") || "",
          sort: "newest", page: 1, pageSize: 20
        };
        // Map tab to query: points -> notgame + merchTypeId=1
        const tab = params.get("tab") || "";
        if(tab === "points"){
          state.type = "notgame";
          state.merchTypeId = 1;
        }
        if(state.q) document.getElementById("q").value = state.q;
                // === äº‹ä»¶ç›£è½ ===
        document.getElementById("btnSearch").addEventListener("click", () => {
          state.q = document.getElementById("q").value.trim();
          state.page = 1;
          load();
        });

        document.getElementById("sort").addEventListener("change", (e) => {
          state.sort = e.target.value;
          state.page = 1;
          load();
        });

        document.getElementById("pageSize").addEventListener("change", (e) => {
          state.pageSize = parseInt(e.target.value, 10) || 40;
          state.page = 1;
          load();
        });

        // === é‡‘é¡æ ¼å¼åŒ– ===
        function money(v, c = "TWD") {
          const code = (c ?? "TWD").toString().trim().toUpperCase();
          const currency = /^[A-Z]{3}$/.test(code) ? code : "TWD";
          const value = Number.isFinite(v) ? v : parseFloat(v) || 0;

          if (value === 0) return "å…è²»ä¸‹è¼‰";

          try {
            return new Intl.NumberFormat("zh-TW", {
              style: "currency",
              currency,
              minimumFractionDigits: 0,
            }).format(value);
          } catch {
            return new Intl.NumberFormat("zh-TW", {
              style: "currency",
              currency: "TWD",
              minimumFractionDigits: 0,
            }).format(value);
          }
        }

        // === å¡ç‰‡å‰¯æ¨™ï¼ˆå¹³å° / é¡å‹ / å‘¨é‚Šåˆ†é¡ï¼‰===
        function tagLine(x) {
          // éŠæˆ²å„ªå…ˆé¡¯ç¤º å¹³å° / é¡å‹ï¼›å‘¨é‚Šé¡¯ç¤º å‘¨é‚Šåˆ†é¡
          if (x.productType === "game") {
            const a = x.platformName
              ? `<span class="tag-pill tag-pill--platform">${x.platformName}</span>`
              : "";
            const g =
              Array.isArray(x.genreNames) && x.genreNames.length
                ? x.genreNames
                    .filter(Boolean)
                    .map(
                      (n) =>
                        `<span class="tag-pill tag-pill--genre">${n}</span>`
                    )
                    .join("")
                : "";
            return a + (g ? ` ${g}` : "");
          } else {
            const nm = x.peripheralTypeName || x.merchTypeName;
            return nm
              ? `<span class="tag-pill tag-pill--merch">${nm}</span>`
              : "";
          }
        }

        // === å•†å“å¡ç‰‡æ¨¡æ¿ ===
        function cardCol(x) {
          const detailUrl = `/OnlineStore/Product/Detail/${x.productCode}`;
          const img = x.coverUrl || PLACEHOLDER;

          return `
          <div class="col-6 col-md-4 col-lg-3 col-xxl-3">
            <div class="card h-100 position-relative">

              <!-- æ”¶è—æ„›å¿ƒ -->
              <a class="badge-fav"
                 href="javascript:void(0)"
                 title="åŠ å…¥æ”¶è—"
                 data-action="fav"
                 data-id="${x.productId}">
                <i class="bi bi-heart"></i>
              </a>

              <!-- åœ–ç‰‡ -->
              <a class="card-img-hold d-block"
                 href="${detailUrl}"
                 title="${x.productName}">
                <img src="${img}"
                     alt="${x.productName}"
                     onerror="this.src='${PLACEHOLDER}'">
                ${
                  x.productType
                    ? `<span class="badge rounded-pill text-bg-dark badge-type">${x.productType}</span>`
                    : ""
                }
              </a>

              <!-- å¡ç‰‡å…§å®¹ -->
              <div class="card-body d-flex flex-column p-3">
                <div class="mb-2">
                  ${tagLine(x)}
                  ${
                    x.isPreorder
                      ? '<span class="badge text-bg-danger ms-1">é è³¼</span>'
                      : ""
                  }
                </div>

                <h6 class="card-title text-truncate mb-1"
                    title="${x.productName?.trim?.() || ""}">
                  ${x.productName?.trim?.() || ""}
                </h6>

                <div class="fw-bold mb-3">
                  ${
                    x.price === 0
                      ? "å…è²»ä¸‹è¼‰"
                      : money(x.price, x.currencyCode || "TWD")
                  }
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="quick-ops">
                  <button class="btn btn-sm btn-outline-dark flex-fill"
                          data-action="buy-now"
                          data-id="${x.productId}">
                    ç«‹å³è³¼è²·
                  </button>

                  <button class="btn btn-sm btn-outline-dark flex-fill"
                          data-action="add-cart"
                          data-id="${x.productId}">
                    åŠ å…¥è³¼ç‰©è»Š
                  </button>
                </div>
              </div>
            </div>
          </div>`;
        }

        // === åˆ†é  ===
        function pager(total, page, size) {
          const host = document.getElementById("pager");
          const pages = Math.max(1, Math.ceil(total / size));

          const mk = (p, t, disabled = false, active = false) =>
            `<li class="page-item ${disabled ? "disabled" : ""} ${active ? "active" : ""}">
               <a class="page-link" href="#" data-page="${p}">${t}</a>
             </li>`;

          const items = [mk(page - 1, "&laquo;", page <= 1)];
          const start = Math.max(1, page - 3);
          const end = Math.min(pages, page + 3);

          for (let i = start; i <= end; i++) items.push(mk(i, i, false, i === page));
          items.push(mk(page + 1, "&raquo;", page >= pages));

          host.innerHTML = items.join("");

          host.querySelectorAll("a.page-link").forEach((a) =>
            a.addEventListener("click", (e) => {
              e.preventDefault();
              const p = parseInt(a.dataset.page, 10);
              if (!isNaN(p)) {
                state.page = p;
                load();
              }
            })
          );
        }

        // === è¼‰å…¥è³‡æ–™ ===
        async function load() {
          const qs = new URLSearchParams({
            q:           state.q || "",
            type:        state.type || "",
            platformId:  state.platformId || "",
            genreId:     state.genreId || "",
            merchTypeId: state.merchTypeId || "",
            supplierId:  state.supplierId || "",
            platform:    state.platform || "",
            genre:       state.genre || "",
            sort:        state.sort || "newest",
            page:        state.page,
            pageSize:    state.pageSize,
          });

          const res  = await fetch(`${api}?${qs.toString()}`);
          const data = await res.json();

           document.getElementById("product-list").innerHTML =
            (data.items || []).map(cardCol).join("");

            await syncFavHighlight();
            pager(data.totalCount || 0, state.page, state.pageSize);
            }


        // å¿«é€Ÿæ“ä½œï¼ˆè³¼ç‰©è»Š/æ”¶è—/ç«‹å³è³¼è²·ï¼‰
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-action]');
          
          // If the click was not on a button with data-action, do nothing.
          if (!btn) {
              return;
          }

          // If it's a link, prevent default navigation.
          if (btn.tagName === 'A') {
              e.preventDefault();
          }

          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-action');
          if(act==='add-cart'){
            if (window.Swal) {
                Swal.fire({
                    title: 'å·²åŠ å…¥è³¼ç‰©è»Š',
                    html: `
                        <style>
                            .swal-cart-anim {
                                font-size: 5rem;
                                animation: cart-bounce 0.8s ease-in-out;
                            }
                            @@keyframes cart-bounce {
                                0%, 100% { transform: translateY(0) rotate(0); }
                                25% { transform: translateY(-10px) rotate(-5deg); }
                                50% { transform: translateY(0) rotate(0); }
                                75% { transform: translateY(-5px) rotate(5deg); }
                            }
                        </style>
                        <div class="swal-cart-anim">ğŸ›’</div>
                        <div class="mt-1 text-muted">å•†å“å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Š</div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'çœ‹è³¼ç‰©è»Š',
                    cancelButtonText: 'å†é€›é€›',
                    heightAuto: false
                }).then(r => {
                    if (r.isConfirmed) location.href = '/OnlineStore/Cart';
                });
            } else {
                alert('å·²åŠ å…¥è³¼ç‰©è»Š'); // Fallback for browsers where Swal is not available
            }
                         } else if(act==='buy-now'){
                             if (window.Swal) {
                                 Swal.fire({
                                     title: 'å“å‘€ï¼Œè«‹å…ˆå®Œæˆç™»å…¥å”·ï¼',
                                     html: '<div style="font-size: 5rem;">ğŸ™…â€â™€ï¸</div><p>æ‚¨éœ€è¦ç™»å…¥æ‰èƒ½è³¼è²·å•†å“å–”</p>',
                                     icon: 'warning', // Using 'warning' icon for a softer rejection
                                     confirmButtonText: 'å¥½çš„',
                                     heightAuto: false
                                 });
                             } else {
                                 // Fallback if Swal is not available
                                 alert('è«‹å…ˆå®Œæˆç™»å…¥å”·ï¼');
                             }
                         } else if(act==='fav'){
            const pid = parseInt(id,10);
            if(!pid || isNaN(pid)) return;
            btn.classList.add('disabled');
            const userId = window.USER_ID ?? 1; // TODO: ä½¿ç”¨å¯¦éš›ç™»å…¥ä½¿ç”¨è€… Id
            fetch(`${API_BASE}/products/${pid}/favorite`, { method: 'POST' })
            .then(r=>{ if(!r.ok){ const e = new Error(r.statusText); e.status=r.status; throw e; } return r.json(); })
            .then(({isFavorited})=>{
              const icon = btn.querySelector('i');
              if(isFavorited){
                btn.classList.add('is-favorited');
                icon?.classList.add('bi-heart-fill');
                icon?.classList.remove('bi-heart');
                favSet.add(pid);
              }else{
                btn.classList.remove('is-favorited');
                icon?.classList.remove('bi-heart-fill');
                icon?.classList.add('bi-heart');
                favSet.delete(pid);
              }
            })
            .catch(err=>{
              console.error(err);
              if(err?.status===401){
                ensureLoginPrompt();
                const modal = new bootstrap.Modal(document.getElementById('loginPromptModal'));
                modal.show();
              }else{
                alert('æ”¶è—å‹•ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
              }
            })
            .finally(()=> btn.classList.remove('disabled'));
          }
        });

        load();
    </script>
}
