@{
    ViewData["Title"] = "瀏覽商品 - GamiStore";
    Layout = "~/Areas/OnlineStore/Views/Shared/_Layout.cshtml";
}

<div class="container py-3">

    <!-- 工具列：搜尋 + 排序 + 每頁 -->
    <div class="tools-sticky d-flex flex-wrap gap-2 align-items-center mb-3">
        <input id="q" class="form-control" placeholder="搜尋商品名稱 / 代碼…" style="width:260px" />
        <select id="sort" class="form-select" style="width:160px">
            <option value="newest">最新上架</option>
            <option value="price_asc">價格低到高</option>
            <option value="price_desc">價格高到低</option>
            <option value="random">隨機探索</option>
        </select>
        <select id="pageSize" class="form-select" style="width:120px">
            <option value="40">每頁 40</option>
            <option value="60">每頁 60</option>
            <option value="80">每頁 80</option>
        </select>
        <button id="btnSearch" class="btn btn-dark"><i class="bi bi-search"></i></button>
    </div>

    <!-- 快速篩選（可依實際資料調整平台與周邊類別ID） -->
    <div class="d-flex flex-wrap gap-2 mb-3" id="quick">
        <button class="btn btn-outline-secondary btn-sm" data-key="type" data-val="game">🎮 電玩</button>
        <button class="btn btn-outline-secondary btn-sm" data-key="type" data-val="notgame">🧸 周邊</button>
        <button class="btn btn-outline-secondary btn-sm" data-key="platformId" data-val="1">PS</button>
        <button class="btn btn-outline-secondary btn-sm" data-key="platformId" data-val="2">Switch</button>
        <button class="btn btn-outline-secondary btn-sm" data-key="platformId" data-val="3">PC</button>
        <button class="btn btn-outline-secondary btn-sm" data-key="merchTypeId" data-val="1">公仔</button>
        <button class="btn btn-outline-secondary btn-sm" data-key="merchTypeId" data-val="2">衣飾</button>
        <button class="btn btn-outline-dark btn-sm" data-key="sort" data-val="newest">最新</button>
        <button class="btn btn-outline-dark btn-sm" data-key="sort" data-val="random">隨機</button>
        <button class="btn btn-link btn-sm text-decoration-none" id="btnClear">清除篩選</button>
    </div>

    <!-- 訊息 -->
    <div id="msg" class="text-danger small mb-2" style="display:none;"></div>

    <!-- 商品格狀 -->
    <div class="row g-3" id="product-grid"></div>

    <!-- 分頁 -->
    <nav class="d-flex justify-content-center mt-3" aria-label="Paging">
        <ul class="pagination pagination-sm mb-0" id="pager"></ul>
    </nav>
</div>

@section Styles {
    <style>
        .tools-sticky {
            position: sticky;
            top: 64px;
            z-index: 1;
            background: var(--bs-body-bg);
        }

        #product-grid .card {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
            background: rgba(255,255,255,.92);
            box-shadow: 0 6px 16px rgba(0,0,0,.07);
            transition: transform .18s ease, box-shadow .18s ease;
        }

            #product-grid .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 14px 28px rgba(0,0,0,.14);
            }

        .square-img {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: #f6f6f6;
        }

            .square-img img {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .text-1line {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
}

@section Scripts {
    <script>
        // ====== 切換呼叫哪一支 API ======
        // true = 呼叫 /products/all（全量，不分頁）
        // false = 呼叫 /products（分頁）
        const USE_ALL = true;

        // ====== 固定路徑（屬性路由）======
        const API_PRODUCTS_PAGED = "@Url.Content("~/OnlineStore/api/StoreApi/products")";
        const API_PRODUCTS_ALL   = "@Url.Content("~/OnlineStore/api/StoreApi/products/all")";

        const $  = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        const NOPIC = "/images/onlinestoreNOPic/nophoto.jpg";

        // 金額格式
        function currency(n, code='TWD'){
          try{ return new Intl.NumberFormat('zh-TW',{style:'currency',currency:code,minimumFractionDigits:0}).format(n??0); }
          catch{ return (n ?? 0).toString(); }
        }
        function onImgErr(e){ e.target.src = NOPIC; e.target.onerror = null; }

        // 參數讀/寫（保留分享性）
        function getParams(){
          const p = new URLSearchParams(location.search);
          return {
            q: p.get('q') || '',
            sort: p.get('sort') || 'newest',
            pageSize: +(p.get('pageSize') || 40),
            page: +(p.get('page') || 1),
            type: p.get('type') || '',
            platformId: p.get('platformId') || '',
            merchTypeId: p.get('merchTypeId') || '',
            priceMin: p.get('priceMin') || '',
            priceMax: p.get('priceMax') || ''
          };
        }
        function setParams(o){
          const u = new URL(location.href);
          Object.entries(o).forEach(([k,v])=>{
            if(v===undefined||v===null||v==='') u.searchParams.delete(k);
            else u.searchParams.set(k,v);
          });
          history.replaceState(null, '', u.toString());
        }

        // 組 API URL
        function apiUrl(p){
          const base = USE_ALL ? API_PRODUCTS_ALL : API_PRODUCTS_PAGED;
          const u = new URL(base, location.origin);

          if (USE_ALL) {
            // 全量：用到 sort 與 max；其餘（q、filters）如果你想套也可保留
            if (p.sort) u.searchParams.set('sort', p.sort);
            // 想限制最大筆數可改這裡（對應後端 max 上限 5000）
            u.searchParams.set('max', String(p.pageSize || 1000));
            // 也可以把 q / type / platformId / merchTypeId 丟進去，後端若之後支援就能用
            if (p.q) u.searchParams.set('q', p.q);
            if (p.type) u.searchParams.set('type', p.type);
            if (p.platformId) u.searchParams.set('platformId', p.platformId);
            if (p.merchTypeId) u.searchParams.set('merchTypeId', p.merchTypeId);
          } else {
            // 分頁版：把所有條件都帶上
            Object.entries(p).forEach(([k,v])=>{
              if(v!=='' && v!==null && v!==undefined) u.searchParams.set(k, v);
            });
          }
          return u.toString();
        }

        // 欄位大小寫兼容 picker
        const pick = (obj, ...cands) => cands.find(k => obj && obj[k] !== undefined) && obj[cands.find(k => obj[k] !== undefined)];

        // 單張商品卡片（PascalCase / camelCase 皆可）
        function card(x){
          const img        = pick(x, 'coverUrl','CoverUrl') || NOPIC;
          const name       = pick(x, 'productName','ProductName') || '';
          const code       = pick(x, 'productCode','ProductCode') || '';
          const type       = (pick(x, 'productType','ProductType') || '').toLowerCase();
          const priceVal   = pick(x, 'price','Price') ?? 0;
          const curr       = pick(x, 'currencyCode','CurrencyCode') || 'TWD';
          const platform   = pick(x, 'platformName','PlatformName');
          const merchName  = pick(x, 'peripheralTypeName','PeripheralTypeName') || pick(x, 'merchTypeName','MerchTypeName');
          const id         = pick(x, 'productId','ProductId');

          const priceText = currency(priceVal, curr);
          const sub = (type === 'game')
            ? [platform, merchName].filter(Boolean).join(' · ')
            : (merchName || platform || '');

          const detailUrl = code ? `/OnlineStore/Store/Product/${encodeURIComponent(code)}`
                                 : `/OnlineStore/Store/ProductId/${id}`;

          return `
          <div class="col-6 col-md-4 col-lg-3">
            <a class="text-decoration-none text-reset" href="${detailUrl}">
              <div class="card h-100">
                <div class="square-img"><img src="${img}" alt="${name}" onerror="onImgErr(event)"></div>
                <div class="card-body">
                  <div class="small text-muted text-1line">${sub || '&nbsp;'}</div>
                  <h6 class="card-title text-1line" title="${name}">${name}</h6>
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-bold">${priceText}</div>
                    <div class="text-muted small">${code}</div>
                  </div>
                </div>
              </div>
            </a>
          </div>`;
        }

        // 分頁 UI（全量模式也保留 UI，但以目前資料長度計算）
        function renderPager(page, totalPages){
          const ul = $('#pager');
          if(!ul) return;
          if(totalPages <= 1){ ul.innerHTML=''; return; }

          const mk = (p, txt, disabled=false, active=false)=>`
            <li class="page-item ${disabled?'disabled':''} ${active?'active':''}">
              <a class="page-link" href="#" data-page="${p}">${txt}</a>
            </li>`;

          let html = '';
          const prev = Math.max(1, page-1), next = Math.min(totalPages, page+1);
          html += mk(prev, '«', page===1);

          const win = 2;
          const start = Math.max(1, page - win);
          const end   = Math.min(totalPages, page + win);

          if(start > 1){
            html += mk(1, '1', false, page===1);
            if(start>2) html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
          }
          for(let p=start; p<=end; p++) html += mk(p, String(p), false, p===page);
          if(end < totalPages){
            if(end<totalPages-1) html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
            html += mk(totalPages, String(totalPages), false, p===totalPages);
          }

          html += mk(next, '»', page===totalPages);
          ul.innerHTML = html;

          ul.querySelectorAll('a.page-link').forEach(a=>{
            a.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const target = +(a.dataset.page);
              const p = getParams(); p.page = target; setParams(p); load();
            });
          });
        }

        // 正規化 API 回傳 → { items, page, pageSize, totalCount }
        function normalize(raw, fallback){
          // 1) 純陣列
          if (Array.isArray(raw)) {
            const pageSize = +(fallback.pageSize || 40);
            const page = +(fallback.page || 1);
            return {
              items: raw,
              page,
              pageSize,
              totalCount: raw.length
            };
          }
          // 2) 分頁包裝（大小寫都吃）
          const items = raw?.items ?? raw?.Items ?? raw?.data ?? raw?.Data ?? raw?.records ?? raw?.Records ?? [];
          const page  = +(raw?.page ?? raw?.Page ?? fallback.page ?? 1);
          const pageSize = +(raw?.pageSize ?? raw?.PageSize ?? fallback.pageSize ?? 40);
          const totalCount = +(raw?.totalCount ?? raw?.TotalCount ?? items.length ?? 0);
          return { items, page, pageSize, totalCount };
        }

        // ===== 載入資料 =====
        let aborter = null;
        async function load(){
          const grid = $('#product-grid');
          const msg  = $('#msg');
          msg.style.display='none'; msg.textContent='';
          grid.innerHTML = '<div class="text-muted py-4">載入中…</div>';

          const p = getParams();
          $('#q').value = p.q; $('#sort').value = p.sort; $('#pageSize').value = String(p.pageSize);

          if(aborter) aborter.abort();
          aborter = new AbortController();

          try{
            const url = apiUrl(p);
            const r = await fetch(url, { signal: aborter.signal, headers: { 'Accept':'application/json' } });
            if(!r.ok){
              const t = await r.text();
              msg.textContent = `載入失敗：${r.status} ${r.statusText} ${t||''}`;
              msg.style.display='block';
              grid.innerHTML = '<div class="text-danger py-4">載入失敗</div>';
              return;
            }

            const data = await r.json();
            const { items, page, pageSize, totalCount } = normalize(data, p);

            grid.innerHTML = items.length ? items.map(card).join('') : '<div class="text-muted py-4">目前沒有商品</div>';

            // 全量模式：用 items.length 當 totalCount（除非你另有總筆數）
            const total = USE_ALL ? items.length : totalCount;
            renderPager(page, Math.max(1, Math.ceil(total / pageSize)));
          }catch(err){
            if(err.name === 'AbortError') return;
            msg.textContent = `發生錯誤：${err.message || err}`;
            msg.style.display='block';
            grid.innerHTML = '<div class="text-danger py-4">載入失敗</div>';
          }
        }

        // 事件：搜尋 / 排序 / 每頁 / 快篩 / 清除
        $('#btnSearch').addEventListener('click', ()=>{
          const p = getParams(); p.q = $('#q').value.trim(); p.page = 1; setParams(p); load();
        });
        let typingTimer = 0;
        $('#q').addEventListener('keyup', (e)=>{
          if(e.key === 'Enter'){
            const p = getParams(); p.q = $('#q').value.trim(); p.page = 1; setParams(p); load();
          } else {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(()=>{
              const p = getParams(); p.q = $('#q').value.trim(); p.page = 1; setParams(p); load();
            }, 500);
          }
        });
        $('#sort').addEventListener('change', ()=>{
          const p=getParams(); p.sort=$('#sort').value; p.page=1; setParams(p); load();
        });
        $('#pageSize').addEventListener('change', ()=>{
          const p=getParams(); p.pageSize=+$('#pageSize').value; p.page=1; setParams(p); load();
        });
        $('#quick').addEventListener('click', (e)=>{
          const btn = e.target.closest('button'); if(!btn) return;
          const k = btn.dataset.key, v = btn.dataset.val;
          const p = getParams(); p[k] = v; p.page = 1; setParams(p); load();
        });
        $('#btnClear').addEventListener('click', (e)=>{
          e.preventDefault();
          setParams({ q:'', sort:'newest', pageSize:40, page:1, type:'', platformId:'', merchTypeId:'', priceMin:'', priceMax:'' });
          load();
        });

        document.addEventListener('DOMContentLoaded', load);
    </script>


}
