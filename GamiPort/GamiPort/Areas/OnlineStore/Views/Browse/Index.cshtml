@{
    ViewData["Title"] = "瀏覽商品 - GamiStore";
    Layout = "~/Areas/OnlineStore/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        /* 版頭搜尋＋工具列 */
        .tools-sticky {
            position: sticky;
            top: 64px;
            z-index: 1;
            background: var(--bs-body-bg);
        }

        /* 卡片牆（巴哈風格融合） */
        #product-list .card {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
            background: rgba(255,255,255,.92);
            box-shadow: 0 6px 16px rgba(0,0,0,.07);
            transition: transform .18s ease, box-shadow .18s ease;
        }

            #product-list .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 14px 28px rgba(0,0,0,.14);
            }

        .card-img-hold {
            position: relative;
            padding-top: 100%;
            background: #f6f6f8;
        }

            .card-img-hold img {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform .25s ease;
            }

        .card:hover .card-img-hold img {
            transform: scale(1.06);
        }

        /* 呼吸光暈 */
        .card:hover::after {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 1rem;
            box-shadow: 0 0 0 0 rgba(0,153,255,.25);
            animation: pulse 1s ease-out;
        }

        @@keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0,153,255,.25);
            }

            100% {
                box-shadow: 0 0 0 18px rgba(0,153,255,0);
            }
        }

        /* 懸浮顯示快速操作 */
        .quick-ops {
            position: absolute;
            left: .5rem;
            right: .5rem;
            bottom: .5rem;
            display: flex;
            gap: .5rem;
            opacity: 0;
            transform: translateY(8px);
            transition: all .18s ease;
            pointer-events: none;
        }

        .card:hover .quick-ops {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .badge-type {
            position: absolute;
            top: .5rem;
            left: .5rem;
            backdrop-filter: blur(4px);
        }

        .badge-fav {
            position: absolute;
            top: .5rem;
            right: .5rem;
            background: rgba(255,255,255,.9);
            border-radius: 999px;
            width: 36px;
            height: 36px;
            display: grid;
            place-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,.15);
        }

        /* 預留底部空間，避免浮現按鈕遮住資訊 */
        #product-list .card .card-body {
            padding-bottom: 3.25rem;
        }

        .sticky-side {
            position: sticky;
            top: 72px;
        }

        /* 分頁 */
        .pagination .page-link {
            border-radius: .5rem;
        }

        /* 新增的圖片推廣區塊樣式 */
        .image-promo-block {
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem; /* 區塊間距 */
            border-radius: 0.5rem; /* 圓角 */
            box-shadow: 0 2px 8px rgba(0,0,0,.1); /* 陰影 */
            cursor: pointer; /* 顯示可點擊游標 */
        }

        .image-promo-block img {
            width: 100%;
            height: auto;
            display: block;
            transition: filter 0.3s ease-in-out; /* 飽和度過渡 */
        }

        .image-promo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* 半透明遮罩 */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; /* 預設隱藏 */
            transition: opacity 0.3s ease-in-out; /* 遮罩過渡 */
        }

        .image-promo-block:hover .image-promo-overlay {
            opacity: 1; /* 懸停時顯示 */
        }

        .image-promo-block:hover img {
            filter: grayscale(80%); /* 懸停時降低飽和度 */
        }

        .overlay-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 0.5rem;
        }
    </style>
}

<div class="container-xxl py-3">
    <div class="row g-3">
        <!-- 側邊分類（保留位） -->
        <aside class="col-lg-2 d-none d-lg-block ">
            <div class="sticky-side ">
                
                <div class="image-promo-block">
                    <a href="#link1">
                        <img src="/images/onlinestoreleftad/連接新品.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">新品上架</span>
                        </div>
                    </a>
                </div>
                <div class="image-promo-block ">
                    <a href="#https://store.steampowered.com/">
                        <img src="/images/onlinestoreleftad/連結Steam.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">Steam 官網</span>
                        </div>
                    </a>
                </div>
                <div class="image-promo-block ">
                    <a href="#https://www.playstation.com/zh-hant-tw/">
                        <img src="/images/onlinestoreleftad/連結Playstation.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">PlayStation 官網</span>
                        </div>
                    </a>
                </div>
                <div class="image-promo-block ">
                    <a href="#https://www.nintendo.com/tw/">
                        <img src="/images/onlinestoreleftad/連結任天堂.jpg" alt="">
                        <div class="image-promo-overlay">
                            <span class="overlay-text">任天堂 官網</span>
                        </div>
                    </a>
                </div>
            </div>
        </aside>

        <!-- 主內容 -->
        <div class="col-12 col-lg-8">
            <div class="tools-sticky pt-1 pb-3 mb-2">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-center">
                    <div class="input-group shadow rounded-pill" style="max-width:560px">
                        <input id="q" class="form-control rounded-start-pill px-4" placeholder="搜尋商品/關鍵字">
                        <button id="btnSearch" class="btn btn-light rounded-end-pill px-4"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 ms-auto mt-2">
                    <select id="sort" class="form-select form-select-sm" style="width:auto">
                        <option value="newest">最新</option>
                        <option value="price_asc">價格 ↑</option>
                        <option value="price_desc">價格 ↓</option>
                    </select>
                    <select id="pageSize" class="form-select form-select-sm" style="width:auto">
                        <option value="40">40</option>
                        <option value="60">60</option>
                        <option value="80">80</option>
                    </select>
                </div>
            </div>

            <div id="product-list" class="row g-3"></div>
            <nav class="mt-3"><ul class="pagination pagination-sm justify-content-center" id="pager"></ul></nav>
        </div>

        <!-- 右側廣告欄 -->
        <div class="col-lg-2 d-none d-lg-block">
            <div class="sticky-side">
                @* 若你有共用 Partial，改成 Partial： *@
                @* @await Html.PartialAsync("_RightRailAds") *@
                @await Html.PartialAsync("/Areas/OnlineStore/Views/Shared/_RightRailAds.v2.cshtml")
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const api = "/OnlineStore/api/StoreApi/products";
        const API_BASE = "/OnlineStore/api/StoreApi";
        const favSet = new Set();

        async function syncFavHighlight(){
          try{
            const r = await fetch(`${API_BASE}/favorites/ids`);
            if(!r.ok) return;
            const ids = await r.json();
            favSet.clear(); ids.forEach(id=>favSet.add(id));
            document.querySelectorAll('#product-list [data-action="fav"][data-id]').forEach(a=>{
              const id = parseInt(a.dataset.id,10);
              const icon = a.querySelector('i');
              if(favSet.has(id)){
                a.classList.add('text-danger');
                icon?.classList.add('bi-heart-fill');
                icon?.classList.remove('bi-heart');
              }else{
                a.classList.remove('text-danger');
                icon?.classList.remove('bi-heart-fill');
                icon?.classList.add('bi-heart');
              }
            });
          }catch{}
        }

        function ensureLoginPrompt(){
          if(document.getElementById('loginPromptModal')) return;
          const el = document.createElement('div');
          el.innerHTML = `
            <div class="modal fade" id="loginPromptModal" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">請先登入</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p class="mb-0">您需要登入後才能使用收藏功能。</p>
                  </div>
                  <div class="modal-footer">
                    <a class="btn btn-dark" href="/Login/Login/Login">現在去登入</a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">稍後再看看</button>
                  </div>
                </div>
              </div>
            </div>`;
          document.body.appendChild(el.firstElementChild);
        }

        const PLACEHOLDER = "/images/onlinestoreNOPic/nophoto.jpg";
        const params = new URLSearchParams(location.search);
        let state = {
          q: params.get("q") || "",
          type: params.get("type") || "",
          platformId: parseInt(params.get("platformId") || "", 10) || "",
          genreId: parseInt(params.get("genreId") || "", 10) || "",
          merchTypeId: parseInt(params.get("merchTypeId") || "", 10) || "",
          supplierId: parseInt(params.get("supplierId") || "", 10) || "",
          platform: params.get("platform") || "",
          genre: params.get("genre") || "",
          sort: "newest", page: 1, pageSize: 40
        };
        // Map tab to query: points -> notgame + merchTypeId=1
        const tab = params.get("tab") || "";
        if(tab === "points"){
          state.type = "notgame";
          state.merchTypeId = 1;
        }
        if(state.q) document.getElementById("q").value = state.q;

                        document.getElementById("btnSearch").addEventListener("click", ()=>{ state.q=document.getElementById("q").value.trim(); state.page=1; load(); });

                        document.getElementById("sort").addEventListener("change", e=>{ state.sort=e.target.value; state.page=1; load(); });

                        document.getElementById("pageSize").addEventListener("change", e=>{ state.pageSize=parseInt(e.target.value,10)||40; state.page=1; load(); });



                        function money(v, c = "TWD"){
                          const code = (c ?? "TWD").toString().trim().toUpperCase();
                          const currency = /^[A-Z]{3}$/.test(code) ? code : "TWD";
                          const value = Number.isFinite(v) ? v : (parseFloat(v) || 0);
                          try {
                            return new Intl.NumberFormat('zh-TW', { style:'currency', currency, minimumFractionDigits:0 }).format(value);
                          } catch {
                            return new Intl.NumberFormat('zh-TW', { style:'currency', currency:'TWD', minimumFractionDigits:0 }).format(value);
                          }
                        }



                        function tagLine(x){

                          // 遊戲優先顯示 平台 / 類型；周邊顯示 周邊分類

                          if(x.productType === "game"){

                            const a = x.platformName ? `<span class="badge text-bg-secondary me-1">${x.platformName}</span>` : "";

                            const g = Array.isArray(x.genreNames) && x.genreNames.length
                              ? x.genreNames.filter(Boolean).map(n => `<span class="badge text-bg-info-subtle border me-1">${n}</span>`).join("")
                              : "";

                            return a + g;

                          }else{

                            return x.peripheralTypeName ? `<span class="badge text-bg-secondary">${x.peripheralTypeName}</span>` : "";

                          }

                        }



                        function cardCol(x){

                          const detailUrl = `/OnlineStore/Product/Detail/${x.productId}`;

                          const img = x.coverUrl || PLACEHOLDER;

                          return `<div class="col-6 col-md-4 col-lg-4 col-xxl-3">

                            <div class="card h-100 position-relative">

                              <a class="badge-fav" href="javascript:void(0)" title="加入收藏" data-action="fav" data-id="${x.productId}">

                                <i class="bi bi-heart"></i>

                              </a>

                              <a class="card-img-hold d-block" href="${detailUrl}" title="${x.productName}">

                                <img src="${img}" alt="${x.productName}" onerror="this.src='${PLACEHOLDER}'">

                                ${x.productType ? `<span class="badge rounded-pill text-bg-dark badge-type">${x.productType}</span>` : ""}

                              </a>

                              <div class="card-body d-flex flex-column p-3">

                                <div class="mb-2">${tagLine(x)} ${x.isPreorder?'<span class="badge text-bg-danger ms-1">預購</span>':''}</div>

                                <h6 class="card-title text-truncate mb-1" title="${x.productName?.trim?.()||''}">${x.productName?.trim?.()||''}</h6>

                                <div class="fw-bold mb-3">${money(x.price, x.currencyCode||'TWD')}</div>



                                <div class="quick-ops">

                                  <button class="btn btn-sm btn-dark flex-fill" data-action="buy-now" data-id="${x.productId}">

                                    <i class="bi bi-bag-check"></i> 立即購買

                                  </button>

                                  <button class="btn btn-sm btn-outline-dark flex-fill" data-action="add-cart" data-id="${x.productId}">

                                    <i class="bi bi-cart-plus"></i> 加入購物車

                                  </button>

                                </div>

                              </div>

                            </div>

                          </div>`;

                        }



                        function pager(total,page,size){

                          const host = document.getElementById("pager");

                          const pages = Math.max(1, Math.ceil(total/size));

                          const mk=(p,t,d=false,a=false)=>`<li class="page-item ${d?'disabled':''} ${a?'active':''}">

                            <a class="page-link" href="#" data-page="${p}">${t}</a></li>`;

                          const items=[mk(page-1,"&laquo;",page<=1)];

                          let start = Math.max(1, page-3), end = Math.min(pages, page+3);

                          for(let i=start;i<=end;i++) items.push(mk(i,i,false,i===page));

                          items.push(mk(page+1,"&raquo;",page>=pages));

                          host.innerHTML = items.join("");

                          host.querySelectorAll("a.page-link").forEach(a=>a.addEventListener("click",e=>{

                            e.preventDefault(); const p=parseInt(a.dataset.page,10); if(!isNaN(p)){ state.page=p; load(); }

                          }));

                        }



                                async function load(){



                                  const qs = new URLSearchParams({



                                    q: state.q||"", type: state.type||"", platformId: state.platformId||"",



                                    genreId: state.genreId||"",
                                    merchTypeId: state.merchTypeId||"",
                                    supplierId: state.supplierId||"",

                                    platform: state.platform||"",

                                    genre: state.genre||"",



                                    sort: state.sort||"newest", page: state.page, pageSize: state.pageSize



                                  });



                                  const res = await fetch(`${api}?${qs.toString()}`);



                                  const data = await res.json();



                                            document.getElementById("product-list").innerHTML = (data.items||[]).map(cardCol).join("");

                                            await syncFavHighlight();



                                  pager(data.totalCount||0, state.page, state.pageSize);



                                }

        // 快速操作（購物車/收藏/立即購買）
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-action]');
          if(!btn) return;
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-action');
          if(act==='add-cart'){
            alert(`已加入購物車（商品ID: ${id}）`);
          }else if(act==='buy-now'){
            location.href = `/OnlineStore/Checkout/CreateOrder?productId=${id}`;
          }else if(act==='fav'){
            const pid = parseInt(id,10);
            if(!pid || isNaN(pid)) return;
            btn.classList.add('disabled');
            const userId = window.USER_ID ?? 1; // TODO: 使用實際登入使用者 Id
            fetch(`${API_BASE}/products/${pid}/favorite`, { method: 'POST' })
            .then(r=>{ if(!r.ok){ const e = new Error(r.statusText); e.status=r.status; throw e; } return r.json(); })
            .then(({isFavorited})=>{
              const icon = btn.querySelector('i');
              if(isFavorited){
                btn.classList.add('text-danger');
                icon?.classList.add('bi-heart-fill');
                icon?.classList.remove('bi-heart');
                favSet.add(pid);
              }else{
                btn.classList.remove('text-danger');
                icon?.classList.remove('bi-heart-fill');
                icon?.classList.add('bi-heart');
                favSet.delete(pid);
              }
            })
            .catch(err=>{
              console.error(err);
              if(err?.status===401){
                ensureLoginPrompt();
                const modal = new bootstrap.Modal(document.getElementById('loginPromptModal'));
                modal.show();
              }else{
                alert('收藏動作失敗，請稍後再試');
              }
            })
            .finally(()=> btn.classList.remove('disabled'));
          }
        });

        load();
    </script>
}
