@{
    ViewData["Title"] = "瀏覽商品 - GamiStore";
    Layout = "~/Areas/OnlineStore/Views/Shared/_Layout.cshtml";
}


@* ======= 工具列（搜尋 + 排序 + 每頁筆數） ======= *@
<div class="container-xxl py-3">
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
            <input id="q" class="form-control" placeholder="搜尋商品名稱 / 代碼…" style="width:260px" />
            <button id="btnSearch" class="btn btn-dark"><i class="bi bi-search"></i></button>
        </div>
        <div class="d-flex align-items-center gap-2">
            <select id="sort" class="form-select">
                <option value="newest">最新上架</option>
                <option value="price_asc">價格低到高</option>
                <option value="price_desc">價格高到低</option>
                <option value="random">隨機探索</option>
            </select>
            <select id="pageSize" class="form-select">
                <option value="40">每頁 40</option>
                <option value="60">每頁 60</option>
                <option value="80">每頁 80</option> @* 後端已放寬至 80 *@
            </select>
        </div>
    </div>

    @* ======= 快速分類（兩行平均對齊 + 周期浮動/閃爍） ======= *@
    <div class="quickbar-grid mb-3">
        <a class="quick-chip" data-kind="platform" data-code="NS"><i class="bi bi-nintendo-switch"></i> NS</a>
        <a class="quick-chip" data-kind="platform" data-code="PS5"><i class="bi bi-playstation"></i> PS5</a>
        <a class="quick-chip" data-kind="platform" data-code="Steam"><i class="bi bi-pc"></i> Steam</a>
        <a class="quick-chip" data-kind="platform" data-code="Mobile"><i class="bi bi-phone"></i> Mobile</a>

        <a class="quick-chip pulse" data-kind="tag" data-tag="sale"><i class="bi bi-percent"></i> 折扣</a>
        <a class="quick-chip floaty" data-kind="sort" data-sort="newest"><i class="bi bi-stars"></i> 新品</a>
        <a class="quick-chip" data-kind="merch" data-code="apparel"><i class="bi bi-bag"></i> 服飾</a>
        <a class="quick-chip" data-kind="merch" data-code="card"><i class="bi bi-credit-card-2-front"></i> 點數卡</a>
        <a class="quick-chip" data-kind="merch" data-code="doll"><i class="bi bi-emoji-smile"></i> 娃娃</a>
        <a class="quick-chip" data-kind="merch" data-code="art"><i class="bi bi-book"></i> 畫冊</a>
    </div>

    @* ======= 內容區：左側 5 欄商品卡，右側廣告 ======= *@
    <div class="row">
        <div class="col-lg-9">
            <div id="product-grid" class="g-grid"></div>

            <div class="d-flex justify-content-center my-3">
                <button id="btnPrev" class="btn btn-outline-secondary me-2"><i class="bi bi-chevron-left"></i> 上一頁</button>
                <div id="pageInfo" class="px-2 small text-muted">第 1 / 1 頁</div>
                <button id="btnNext" class="btn btn-outline-secondary ms-2">下一頁 <i class="bi bi-chevron-right"></i></button>
            </div>
        </div>





        <div class="col-lg-3">
            @* 右側廣告：可換成 Partial 或輪播 *@
            <div class="ad-box mb-3">
                <img class="w-100 rounded-3" src="/images/ads/ad1.jpg" alt="Ad">
            </div>
            <div class="ad-box mb-3">
                <img class="w-100 rounded-3" src="/images/ads/ad2.jpg" alt="Ad">
            </div>
            <div class="ad-box">
                <img class="w-100 rounded-3" src="/images/ads/ad3.jpg" alt="Ad">
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* ===== 快速分類兩行平均 ===== */
        .quickbar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: .5rem;
        }

        @@media (max-width: 992px) {
            .quickbar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .quick-chip {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .4rem;
            padding: .5rem .75rem;
            border-radius: 999px;
            background: #fff;
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 2px 10px rgba(0,0,0,.06);
            text-decoration: none;
            color: #111;
            transition: transform .12s, box-shadow .12s, background .12s;
        }

            .quick-chip:hover {
                transform: translateY(-1px);
                box-shadow: 0 8px 18px rgba(0,0,0,.12);
            }
        /* 浮動/脈動 */
        @@keyframes floaty {
            0%, 100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-2px)
            }
        }

        .floaty {
            animation: floaty 2.4s ease-in-out infinite;
        }

        @@keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0,0,0,.08)
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0,0,0,0)
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0,0,0,0)
            }
        }

        .pulse {
            animation: pulse 2.2s infinite;
        }

        /* ===== 5 欄商品卡（大螢幕），自適應 ===== */
        .g-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: .75rem;
        }

        @@media (max-width: 1200px) {
            .g-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @@media (max-width: 992px) {
            .g-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @@media (max-width: 576px) {
            .g-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== 卡片互動：呼吸 + 圖片縮放不溢出、滑入工具列 ===== */
        .p-card {
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
        }

        .p-imgwrap {
            position: relative;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
        }

        .p-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transform: scale(1);
            transition: transform .28s ease;
        }

        .p-card:hover .p-img {
            transform: scale(1.06);
        }

        .p-body {
            padding: .75rem .75rem 1rem;
        }

        .p-sub {
            font-size: .8rem;
            color: #6c757d;
            height: 1.2rem;
            transition: transform .18s ease, opacity .18s ease;
        }

        .p-actions {
            position: absolute;
            left: .5rem;
            right: .5rem;
            bottom: .5rem;
            display: flex;
            gap: .5rem;
            justify-content: center;
            transform: translateY(120%);
            opacity: 0;
            transition: transform .2s ease, opacity .2s ease;
        }

        .p-card:hover .p-sub {
            transform: translateY(6px);
            opacity: 0;
        }

        .p-card:hover .p-actions {
            transform: translateY(0);
            opacity: 1;
        }

        .p-fav {
            position: absolute;
            top: .5rem;
            right: .5rem;
            z-index: 2;
            background: rgba(255,255,255,.8);
            border-radius: 999px;
            padding: .35rem .5rem;
            box-shadow: 0 4px 14px rgba(0,0,0,.12);
        }

            .p-fav i {
                font-size: 1rem;
            }

        .p-title {
            font-size: .95rem;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .p-price {
            font-weight: 700;
        }

        /* 骨架 */
        .skeleton {
            position: relative;
            overflow: hidden;
            background: #f3f4f6;
            border-radius: 12px;
        }

            .skeleton::after {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
                transform: translateX(-100%);
                animation: shimmer 1.2s infinite;
            }

        @@keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* 廣告 */
        .ad-box img {
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
        }
    </style>
}



@section Scripts {
    <script>
        const api = "/OnlineStore/api/StoreApi/products";
        const PRODUCTS_API = "/OnlineStore/api/StoreApi/products";
        const FAV_API      = "/OnlineStore/api/StoreApi/favorites";
            
            // 平台與周邊代碼 → Id（依你提供的 INSERT ）
        const PLATFORM_MAP  = { Steam:1, Mobile:2, NS:3, PS5:4 };
        const MERCHTYPE_MAP = { card:1, doll:2, art:3, charm:4, apparel:5, pad:6, mug:7 };

        // 允許的查詢參數（對齊後端）
        const ALLOW_PARAMS = ['q','type','platformId','merchTypeId','priceMin','priceMax','sort','tag','page','pageSize'];

            // 呼叫 API：新增到收藏（已存在就回 duplicated = true）
            async function addFavorite(productId, userId = DEMO_USER_ID) {
              const res = await fetch(`${FAV_API}/${productId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userId)
              });
              if (!res.ok) {
                const msg = await res.text();
                throw new Error(msg || '加入收藏失敗');
              }
              return res.json(); // { success: true, duplicated?: true }
            }


            //
            const PLACEHOLDER = "/images/onlinestoreNOPic/nophoto.jpg";
            let state = {
              q: new URLSearchParams(location.search).get("q") || "",
              type: new URLSearchParams(location.search).get("type") || "",
              platform: new URLSearchParams(location.search).get("platform") || "",
              genre: new URLSearchParams(location.search).get("genre") || "",
              peripheral: new URLSearchParams(location.search).get("peripheral") || "",
              sort: "newest", page: 1, pageSize: 40
            };
            if(state.q) document.getElementById("q").value = state.q;

            document.getElementById("btnSearch").addEventListener("click", ()=>{ state.q=document.getElementById("q").value.trim(); state.page=1; load(); });
            document.getElementById("sort").addEventListener("change", e=>{ state.sort=e.target.value; state.page=1; load(); });
            document.getElementById("pageSize").addEventListener("change", e=>{ state.pageSize=parseInt(e.target.value,10)||40; state.page=1; load(); });

            function money(v,c="TWD"){ return new Intl.NumberFormat('zh-TW',{ style:'currency', currency:c }).format(v||0); }

            function tagLine(x){
              // 遊戲優先顯示 平台 / 類型；周邊顯示 周邊分類
              if(x.productType === "game"){
                const a = x.platformName ? `<span class="badge text-bg-secondary me-1">${x.platformName}</span>` : "";
                const b = x.genreName ? `<span class="badge text-bg-info-subtle border">${x.genreName}</span>` : "";
                return a + b;
              }else{
                return x.peripheralTypeName ? `<span class="badge text-bg-secondary">${x.peripheralTypeName}</span>` : "";
              }
            }
            
         /* ===============================
           工具：參數存取 / 格式化
           =============================== */
        function getParams(){
          const u = new URL(location.href), p={};
          ALLOW_PARAMS.forEach(k=>{ const v=u.searchParams.get(k); if(v!==null && v!=='') p[k]=v; });
          if(!p.page) p.page=1;
          if(!p.pageSize) p.pageSize=40;
          if(!p.sort) p.sort='newest';
          return p;
        }
        function setParams(params, replace=true){
          const url = new URL(location.href);
          Object.entries(params).forEach(([k,v])=>{
            if(v===undefined || v===null || v==='') url.searchParams.delete(k);
            else url.searchParams.set(k, v);
          });
          if(replace) history.replaceState(null,"",url.toString()); else location.href = url.toString();
        }
        function buildUrl(p){
          const u = new URL(PRODUCTS_API, location.origin);
          Object.entries(p).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') u.searchParams.set(k, v); });
          return u.toString();
        }
        function currency(n, code='TWD'){
          return new Intl.NumberFormat('zh-TW',{style:'currency',currency:code,minimumFractionDigits:0}).format(n ?? 0);
        }

        /* ===============================
           渲染：骨架 / 商品卡 / 頁碼
           =============================== */
        function renderSkeletonGrid(count=10){
          const grid = document.getElementById('product-grid');
          const cell = `
          <div class="p-card">
            <div class="p-imgwrap skeleton" style="height:200px;"></div>
            <div class="p-body">
              <div class="skeleton" style="height:14px;width:40%;margin:6px 0;"></div>
              <div class="skeleton" style="height:16px;width:90%;margin:6px 0;"></div>
              <div class="skeleton" style="height:16px;width:50%;margin:6px 0;"></div>
            </div>
          </div>`;
          grid.innerHTML = new Array(count).fill(`<div>${cell}</div>`).join('');
        }

        function card(x){
          const sub = x.productType?.toLowerCase()==='game'
            ? [x.platformName, x.peripheralTypeName].filter(Boolean).join(' · ')
            : (x.peripheralTypeName || '');

          const img = x.coverUrl || '/images/onlinestoreNOPic/nophoto.jpg';

          return `
          <div class="p-card">
            <a class="p-fav ${x._fav?'text-danger':''}" href="javascript:void(0)" title="加入收藏" data-action="fav" data-id="${x.productId}">
              <i class="bi ${x._fav?'bi-heart-fill':'bi-heart'}"></i>
            </a>
            <div class="p-imgwrap">
              <img class="p-img" src="${img}" alt="${x.productName}">
            </div>
            <div class="p-body">
              <div class="p-sub">${sub}</div>
              <div class="p-title" title="${x.productName}">${x.productName}</div>
              <div class="p-price">${currency(x.price, x.currencyCode)}</div>
            </div>
            <div class="p-actions">
              <a class="btn btn-sm btn-dark" href="/OnlineStore/Browse/Detail/${x.productId}">
                <i class="bi bi-box-arrow-up-right me-1"></i> 查看
              </a>
              <button class="btn btn-sm btn-outline-dark" data-action="add-cart" data-id="${x.productId}">
                <i class="bi bi-cart-plus"></i>
              </button>
              <button class="btn btn-sm btn-outline-dark" data-action="buy-now" data-id="${x.productId}">
                <i class="bi bi-bag-check"></i>
              </button>
            </div>
          </div>`;
        }

        function updatePager(page, totalPages){
          document.getElementById('pageInfo').textContent = `第 ${page} / ${totalPages} 頁`;
          document.getElementById('btnPrev').disabled = page<=1;
          document.getElementById('btnNext').disabled = page>=totalPages;
        }

        /* ===============================
           資料：載入 / 收藏 / 事件
           =============================== */
        async function addFavorite(productId, userId=DEMO_USER_ID){
          const res = await fetch(`${FAV_API}/${productId}`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(userId)
          });
          if(!res.ok){ throw new Error(await res.text() || '加入收藏失敗'); }
          return res.json(); // {success, duplicated?}
        }

        async function loadProducts(){
          const grid = document.getElementById('product-grid');
          const p = getParams();

          // 將工具列 UI 與參數對齊
          document.getElementById('q').value = p.q || '';
          document.getElementById('sort').value = p.sort || 'newest';
          document.getElementById('pageSize').value = String(p.pageSize||40);

          renderSkeletonGrid(10);

          const res = await fetch(buildUrl(p));
          if(!res.ok){ grid.innerHTML = `<div class="text-muted py-4">載入失敗</div>`; return; }
          const data = await res.json(); // {page, pageSize, totalCount, items}
          const items = data.items||[];
          if(items.length===0){ grid.innerHTML = `<div class="text-muted py-4">目前沒有符合條件的商品。</div>`; updatePager(p.page, 1); return; }

          grid.innerHTML = items.map(card).join('');

          const totalPages = Math.max(1, Math.ceil((data.totalCount||items.length)/(data.pageSize||p.pageSize||40)));
          updatePager(Number(p.page), totalPages);
        }

        /* ===== 事件：工具列 ===== */
        document.getElementById('btnSearch').addEventListener('click', ()=>{
          const p = getParams();
          p.q = document.getElementById('q').value.trim();
          p.page=1;
          setParams(p); loadProducts();
        });
        document.getElementById('sort').addEventListener('change', ()=>{
          const p = getParams(); p.sort = document.getElementById('sort').value; p.page=1; setParams(p); loadProducts();
        });
        document.getElementById('pageSize').addEventListener('change', ()=>{
          const p = getParams(); p.pageSize = document.getElementById('pageSize').value; p.page=1; setParams(p); loadProducts();
        });
        document.getElementById('btnPrev').addEventListener('click', ()=>{
          const p = getParams(); p.page = Math.max(1, Number(p.page)-1); setParams(p); loadProducts();
        });
        document.getElementById('btnNext').addEventListener('click', ()=>{
          const p = getParams(); p.page = Number(p.page)+1; setParams(p); loadProducts();
        });

        /* ===== 事件：快速分類（移除「只看遊戲/全部周邊」；兩行平均） ===== */
        document.addEventListener('click', (e)=>{
          const a = e.target.closest('.quick-chip'); if(!a) return;
          const kind = a.getAttribute('data-kind');
          const p = getParams();

          if(kind==='platform'){
            const code = a.getAttribute('data-code');
            const id = PLATFORM_MAP[code];
            if(!id) { alert('平台代碼未對應 ID：'+code); return; }
            p.type='game'; p.platformId=id; p.merchTypeId=''; p.page=1;
          }
          else if(kind==='merch'){
            const code = a.getAttribute('data-code');
            const id = MERCHTYPE_MAP[code];
            if(!id) { alert('周邊代碼未對應 ID：'+code); return; }
            p.type='notgame'; p.merchTypeId=id; p.platformId=''; p.page=1;
          }
          else if(kind==='tag'){ // 折扣
            p.tag = a.getAttribute('data-tag') || 'sale'; p.page=1;
          }
          else if(kind==='sort'){ // 新品
            p.sort = a.getAttribute('data-sort') || 'newest'; p.page=1;
          }

          setParams(p); loadProducts();
        });

        /* ===== 事件：卡片互動（收藏/購物） ===== */
        document.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-action]');
          if(!btn) return;
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-action');

          if(act==='fav'){
            try{
              btn.classList.add('disabled');
              const r = await addFavorite(id);
              btn.classList.add('text-danger');
              const icon = btn.querySelector('i'); if(icon){ icon.classList.remove('bi-heart'); icon.classList.add('bi-heart-fill'); }
            }catch(err){ alert(err.message || '加入收藏失敗'); }
            finally{ btn.classList.remove('disabled'); }
          }
          else if(act==='add-cart'){
            // TODO: 串你的購物車 API；先提示成功
            alert(`已加入購物車（商品ID:${id}）`);
          }
          else if(act==='buy-now'){
            // TODO: 導向下單流程（如果你有建立）
            location.href = `/OnlineStore/Checkout/CreateOrder?productId=${id}`;
          }
        });

        /* ===== 啟動 ===== */
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
}
