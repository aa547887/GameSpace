@{
    ViewData["Title"] = "GamiStore 首頁";
}

<!-- ========= 版面骨架（左內容 + 右廣告） ========= -->
<div class="container-fluid py-3">
    <div class="row g-4">

        <!-- 左：你的首頁內容（輪播、排行榜、分類檢視…） -->
        <div class="col-12 col-xxl-9">

            <!-- ====== Hero 輪播（5 張指定圖片 + 果凍搜尋條） ====== -->
            <div id="storeHero" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="5000">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="~/image/01廣告，GamiStoreBirth.png" alt="GamiStore 開站">
                        <div class="hero-search">
                            <i class="bi bi-search"></i>
                            <input placeholder="搜尋想要的商品或遊戲…">
                            <button class="btn btn-primary btn-sm">搜尋</button>
                        </div>
                    </div>
                    <div class="carousel-item"><img src="~/image/02廣告，卡比.jpg" alt="卡比"></div>
                    <div class="carousel-item"><img src="~/image/03廣告，NINJA.jpg" alt="NINJA"></div>
                    <div class="carousel-item"><img src="~/image/04廣告，絕對摩拳.jpg" alt="絕對摩拳"></div>
                    <div class="carousel-item"><img src="~/image/05廣告，無雙戰技.jpg" alt="無雙戰技"></div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#storeHero" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Prev</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#storeHero" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- ====== 每日熱銷 ====== -->
            <section class="block" id="rank-sales">
                <div class="block-head">
                    <h5>商城排行榜 · 每日熱銷</h5>
                    <div class="block-desc" id="upd-sales">更新於：--</div>
                </div>
                <div class="grid">
                    <div>
                        <div class="top3" id="top3-sales"></div>
                        <div class="side-list" id="side-sales"></div>
                        <div class="empty d-none" id="empty-sales">尚無資料</div>
                    </div>
                    <aside class="mini-ads">
                        <a class="mini-ad ad-hover-sheen ad-breathe" href="#"><img src="~/image/02廣告，卡比.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/03廣告，NINJA.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/04廣告，絕對摩拳.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/05廣告，無雙戰技.jpg" alt=""></a>
                    </aside>
                </div>
            </section>

            <!-- ====== 熱門點擊 ====== -->
            <section class="block" id="rank-views">
                <div class="block-head">
                    <h5>商城排行榜 · 熱門點擊</h5>
                    <div class="block-desc" id="upd-views">更新於：--</div>
                </div>
                <div class="grid">
                    <div>
                        <div class="top3" id="top3-views"></div>
                        <div class="side-list" id="side-views"></div>
                        <div class="empty d-none" id="empty-views">尚無資料</div>
                    </div>
                    <aside class="mini-ads">
                        <a class="mini-ad ad-hover-sheen ad-breathe" href="#"><img src="~/image/01廣告，GamiStoreBirth.png" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/02廣告，卡比.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/03廣告，NINJA.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/04廣告，絕對摩拳.jpg" alt=""></a>
                    </aside>
                </div>
            </section>

            <!-- ====== 收藏飆升 ====== -->
            <section class="block" id="rank-fav">
                <div class="block-head">
                    <h5>商城排行榜 · 收藏飆升</h5>
                    <div class="block-desc" id="upd-fav">更新於：--</div>
                </div>
                <div class="grid">
                    <div>
                        <div class="top3" id="top3-fav"></div>
                        <div class="side-list" id="side-fav"></div>
                        <div class="empty d-none" id="empty-fav">尚無資料</div>
                    </div>
                    <aside class="mini-ads">
                        <a class="mini-ad ad-hover-sheen ad-breathe" href="#"><img src="~/image/05廣告，無雙戰技.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/01廣告，GamiStoreBirth.png" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/02廣告，卡比.jpg" alt=""></a>
                        <a class="mini-ad ad-hover-sheen" href="#"><img src="~/image/03廣告，NINJA.jpg" alt=""></a>
                    </aside>
                </div>
            </section>

        </div>

        <!-- 右：共用右欄廣告（桌機顯示；直接叫用 Views/Shared/_RightRailAds.cshtml） -->
        <aside class="col-xl-3 d-none d-xl-block">
            <div class="right-rail">
                @await Html.PartialAsync("/Views/Shared/_RightRailAds.cshtml")
            </div>
        </aside>
    </div>
</div>

@section Styles {
    <style>
        /* 右欄 sticky 跟頂部對齊（若有 --dock-top 會用；沒有就 68px） */
        .right-rail {
            position: sticky;
            top: var(--dock-top, 68px);
        }

        /* === Hero 輪播 + 果凍搜尋條 === */
        #storeHero .carousel-inner {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 14px 36px rgba(0,0,0,.15);
        }

        #storeHero .carousel-item {
            position: relative;
        }

        #storeHero img {
            width: 100%;
            height: auto;
            display: block;
        }

        .hero-search {
            position: absolute;
            left: 8%;
            right: 8%;
            bottom: 10%;
            background: rgba(255,255,255,.62);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 16px;
            display: flex;
            gap: 10px;
            padding: 10px 12px;
            align-items: center;
        }

            .hero-search input {
                border: 0;
                background: transparent;
                outline: none;
                width: 100%;
            }

        /* === 共用視覺（Bahamut 風） === */
        .block {
            background: #fff;
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
        }

            .block + .block {
                margin-top: 24px;
            }

        .block-head {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

            .block-head h5 {
                margin: 0;
                font-weight: 800;
            }

        .block-desc {
            color: #7c8591;
            font-size: .92rem;
            margin-left: auto;
        }

        /* 兩欄：左內容 + 右小廣告 */
        .grid {
            display: grid;
            grid-template-columns: minmax(520px,1fr) 360px;
            gap: 16px;
        }
        @@media (max-width:1200px) {
            .grid

        {
            grid-template-columns: 1fr;
        }

        }

        /* Top1~3 卡片 + 右側4~10列表 */
        .top3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0,1fr));
            gap: 12px;
        }

        .top-card {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            background: #f7f7f9;
            box-shadow: 0 6px 18px rgba(0,0,0,.08);
            transition: transform .15s ease, box-shadow .15s ease;
            display: flex;
            flex-direction: column;
        }

            .top-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 28px rgba(0,0,0,.12);
            }

            .top-card .cover {
                aspect-ratio: 16/10;
                background: #ddd;
                background-position: center;
                background-size: cover;
            }

            .top-card .body {
                padding: 10px 12px;
            }

            .top-card .title {
                font-weight: 700;
                line-height: 1.2;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .top-card .price {
                color: #2563eb;
                font-weight: 800;
            }

        .badge-rank {
            position: absolute;
            left: 8px;
            top: 8px;
            z-index: 2;
            background: linear-gradient(135deg,#ffd54f,#ffb300);
            color: #5b4100;
            font-weight: 800;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: .85rem;
        }

        .side-list {
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,.06);
        }

        .side-item {
            display: grid;
            grid-template-columns: 36px 1fr auto;
            gap: 10px;
            padding: 10px 12px;
            align-items: center;
            border-bottom: 1px dashed rgba(0,0,0,.06);
        }

            .side-item:last-child {
                border-bottom: 0;
            }

        .side-rank {
            width: 36px;
            height: 28px;
            border-radius: 8px;
            background: #eef3ff;
            color: #1f3b8f;
            font-weight: 800;
            display: grid;
            place-items: center;
        }

        .side-title {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .side-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            color: #8893a1;
            font-size: .9rem;
        }

            .side-meta .tag {
                border: 1px solid rgba(0,0,0,.12);
                border-radius: 999px;
                padding: 2px 8px;
                font-weight: 700;
            }

        /* 右側小廣告 */
        .mini-ads {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .mini-ad {
            position: relative;
            display: block;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 22px rgba(0,0,0,.12);
        }

            .mini-ad img {
                width: 100%;
                height: auto;
                display: block;
                transition: transform .25s ease;
            }

            .mini-ad:hover img {
                transform: scale(1.03);
            }

        .ad-hover-sheen::after {
            content: "";
            position: absolute;
            top: 0;
            left: -150%;
            width: 50%;
            height: 100%;
            background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.35) 50%, transparent 100%);
            transform: skewX(-20deg);
            transition: left .55s ease;
            pointer-events: none;
        }

        .ad-hover-sheen:hover::after {
            left: 130%;
        }

        .ad-breathe {
            animation: breathe 2.8s ease-in-out infinite;
        }
        @@keyframes breathe {
            0%,100%

        {
            transform: scale(1);
        }

        50% {
            transform: scale(1.015);
        }

        }
    </style>
}

@section Scripts {
    <script>
        /* ====== 三區排行榜：固定在頁面，不用點才展開 ====== */
        const API = {
          sales: '/api/store/rankings?type=sales',
          views: '/api/store/rankings?type=views',
          fav:   '/api/store/rankings?type=fav'
        };

        loadBlock('sales'); loadBlock('views'); loadBlock('fav');

        async function loadBlock(kind){
          const top3 = document.getElementById(`top3-${kind}`);
          const side = document.getElementById(`side-${kind}`);
          const empty= document.getElementById(`empty-${kind}`);
          const upd  = document.getElementById(`upd-${kind}`);

          top3.innerHTML=''; side.innerHTML=''; empty.classList.add('d-none');

          try{
            const res = await fetch(API[kind], {headers:{'Accept':'application/json'}});
            if(!res.ok) throw new Error(res.statusText);
            const data = await res.json();
            const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);

            if(!items || items.length===0){
              empty.classList.remove('d-none'); upd.textContent=markUpd(); return;
            }

            top3.innerHTML = items.slice(0,3).map((p,i)=>topCard(p,i+1)).join('');
            side.innerHTML = items.slice(3,10).map((p,idx)=>sideItem(p,idx+4)).join('');
            upd.textContent = markUpd();
          }catch{
            empty.classList.remove('d-none'); upd.textContent=markUpd();
          }
        }

        function markUpd(){ return `更新於：${new Date().toLocaleString()}`; }

        function topCard(p, rank){
          const cover = p.coverUrl || 'https://placehold.co/640x360?text=No+Image';
          const price = priceText(p.price, p.currencyCode);
          const plat  = p.platformName ? `<span class="badge text-bg-primary fw-bold">${escapeHtml(p.platformName)}</span>` : '';
          return `
            <a class="top-card text-decoration-none text-dark" href="/OnlineStore/store/details/${p.productId}" title="${escapeHtml(p.productName)}">
              <span class="badge-rank">第 ${rank} 名</span>
              <div class="cover" style="background-image:url('${cover.replace(/'/g,"%27")}')"></div>
              <div class="body">
                <div class="d-flex align-items-center justify-content-between mb-1">
                  ${plat}
                  <div class="price">${price}</div>
                </div>
                <div class="title">${escapeHtml(p.productName)}</div>
              </div>
            </a>`;
        }
        function sideItem(p, rank){
          const plat = p.platformName ? `<span class="tag">${escapeHtml(p.platformName)}</span>` : '';
          const price = priceText(p.price, p.currencyCode);
          return `
            <a class="side-item text-decoration-none text-dark" href="/OnlineStore/store/details/${p.productId}" title="${escapeHtml(p.productName)}">
              <div class="side-rank">${rank}</div>
              <div class="side-title">${escapeHtml(p.productName)}</div>
              <div class="side-meta">${plat}<span>${price}</span></div>
            </a>`;
        }
        function priceText(n, cur){
          if(n==null) return '';
          const v = Number(n).toLocaleString('zh-TW',{minimumFractionDigits:0, maximumFractionDigits:0});
          return (cur||'TWD')==='TWD' ? `NT$ ${v}` : `${cur||''} ${v}`;
        }
        function escapeHtml(str){
          return (str??'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
        }
    </script>
}
