@model GamiPort.Areas.OnlineStore.ViewModels.ProductDetailVM
@using System.Text.Json
@using System.Text.Json.Serialization
@{
    ViewData["Title"] = Model.ProductName;
    Layout = "~/Areas/OnlineStore/Views/Shared/_Layout.cshtml";
}

@section Styles {
<style>
    /* æ–°çš„ç¸®åœ–æ¨£å¼ */
    .thumb-item {
        border: 1px solid #ddd;
        border-radius: .25rem;
        background-color: #f8f9fa;
        cursor: pointer;
        overflow: hidden;
    }
    .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform .2s ease;
    }
    .thumb-item:hover img {
        transform: scale(1.1);
    }
    .thumb-item.empty {
        cursor: default;
    }
    #cover {
        cursor: pointer;
    }

    /* ç‡ˆç®±æ¨£å¼ */
    .basicLightbox {
        background-color: rgba(0, 0, 0, 0.5) !important; /* ä½¿èƒŒæ™¯æ›´æ·¡ */
    }
    .basicLightbox__placeholder {
        color: #fff;
    }
    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0,0,0,0.4);
        color: #fff;
        border: none;
        font-size: 2rem;
        padding: 0 1rem;
        cursor: pointer;
        height: 100%;
        display: flex;
        align-items: center;
    }
    .lightbox-nav.prev { left: 0; border-radius: 0 5px 5px 0; }
    .lightbox-nav.next { right: 0; border-radius: 5px 0 0 5px; }
    .lightbox-nav:hover { background: rgba(0,0,0,0.6); }
</style>
}

<section class="container py-4" id="app" data-pid="@Model.ProductId">
    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="ratio ratio-1x1 rounded overflow-hidden shadow-sm bg-light">
                <img id="cover" src="/images/placeholder-cover.png" class="w-100 h-100" style="object-fit:cover;">
            </div>
            <!-- ä¿®æ”¹å¾Œçš„å››æ ¼ç¸®åœ– -->
            <div id="thumbs" class="row g-2 mt-2">
                <div class="col-3"><div class="thumb-item ratio ratio-1x1"></div></div>
                <div class="col-3"><div class="thumb-item ratio ratio-1x1"></div></div>
                <div class="col-3"><div class="thumb-item ratio ratio-1x1"></div></div>
                <div class="col-3"><div class="thumb-item ratio ratio-1x1"></div></div>
            </div>
            <div id="video" class="mt-3"></div>
        </div>

        <div class="col-12 col-lg-6">
            <h2 id="name" class="fw-bold mb-2">...</h2>
            <div class="mb-2">
                <span class="badge text-bg-dark" id="ptype"></span>
            </div>
            <div class="h4 fw-bold mb-3">
                <span id="price-product-name" class="d-block fs-6 fw-normal text-secondary"></span> <!-- New element -->
                <span id="price"></span>
                <span class="text-muted fs-6" id="cc">TWD</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-3">
                <i class="bi bi-star-fill"></i>
                <span id="rating">0.0</span>
                <small class="text-muted" id="ratingcnt">(0)</small>
            </div>

            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-lg btn-dark flex-fill" data-action="buy-now"><i class="bi bi-bag-check me-1"></i> ç«‹å³è³¼è²·</button>
                <button class="btn btn-lg btn-outline-dark flex-fill" data-action="add-cart"><i class="bi bi-cart-plus me-1"></i> åŠ å…¥è³¼ç‰©è»Š</button>
                <button class="btn btn-lg btn-outline-secondary" data-action="fav" title="åŠ å…¥æˆ‘çš„å•†å“è’è—" aria-pressed="false"><i class="bi bi-heart"></i></button>
            </div>

            <div class="mb-3">
                <h5 class="fw-bold">å•†å“ä»‹ç´¹</h5>
                <p id="desc" class="text-secondary"></p>
            </div>

            <div class="mb-3">
                <h5 class="fw-bold">å•†å“è¦æ ¼</h5>
                <div id="specs" class="small text-secondary"></div>
            </div>

            <div class="mb-4">
                <h5 class="fw-bold mb-2">è©•åˆ† / è©•è«–</h5>
                <div class="d-flex align-items-center gap-2 mb-2" id="rate-stars" aria-label="çµ¦äºˆè©•åˆ†" role="group">
                    <i class="bi bi-star fs-4" data-star="1" style="cursor:pointer"></i>
                    <i class="bi bi-star fs-4" data-star="2" style="cursor:pointer"></i>
                    <i class="bi bi-star fs-4" data-star="3" style="cursor:pointer"></i>
                    <i class="bi bi-star fs-4" data-star="4" style="cursor:pointer"></i>
                    <i class="bi bi-star fs-4" data-star="5" style="cursor:pointer"></i>
                </div>
                <div class="mb-2 small text-muted">é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†ï¼Œæˆ–æ’°å¯«è©•è«–å¾Œé€å‡º</div>
                <textarea id="reviewText" class="form-control mb-2" rows="3" placeholder="åˆ†äº«ä½ çš„å¿ƒå¾—ï¼ˆé¸å¡«ï¼‰"></textarea>
                <button id="btnSubmitReview" class="btn btn-sm btn-dark">é€å‡ºè©•åƒ¹</button>
            </div>
        </div>
    </div>
</section>

<section class="container py-3">
    <!-- å°èª¿å¾Œçš„æ–°ç‰ˆé¢é…ç½® -->
    <div class="row g-3">
        <div class="col-12 col-lg-8">
            <h5 class="fw-bold mb-2">ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡</h5>
            <div id="related" class="row g-2"></div>
        </div>
        <div class="col-12 col-lg-4">
            <h5 class="fw-bold mb-2">ä½¿ç”¨è€…è©•è«–</h5>
            <div id="reviews" class="vstack gap-3"></div>
            <button id="btnMoreReviews" class="btn btn-outline-secondary btn-sm mt-2 d-none">è¼‰å…¥æ›´å¤š</button>
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
                const initialData = @Html.Raw(JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = null }));
                const API_BASE = "/OnlineStore/api/StoreApi";
                let currentRating = 0;
                let authChecked = false, isAuthenticated = false;

                async function ensureAuthenticated(){
                  if(authChecked) return isAuthenticated;
                  try{
                    const r = await fetch(`${API_BASE}/favorites/ids`);
                    isAuthenticated = r.ok;
                  }catch{ isAuthenticated = false; }
                  authChecked = true;
                  return isAuthenticated;
                }

                function ensureLoginPrompt() {
                  if (document.getElementById('loginPromptModal')) return;
                  const el = document.createElement('div');
                  el.innerHTML = `
                    <div class="modal fade" id="loginPromptModal" tabindex="-1">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">è«‹å…ˆç™»å…¥</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <p class="mb-0">æ‚¨éœ€è¦ç™»å…¥å¾Œæ‰èƒ½ä½¿ç”¨æ”¶è—åŠŸèƒ½ã€‚</p>
                          </div>
                          <div class="modal-footer">
                            <a class="btn btn-dark" href="/Login/Login/Login">ç¾åœ¨å»ç™»å…¥</a>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ç¨å¾Œå†çœ‹çœ‹</button>
                          </div>
                        </div>
                      </div>
                    </div>`;
                  document.body.appendChild(el.firstElementChild);
                }

                async function toggleFavorite(productId){
                  const userId = window.USER_ID ?? 1; // TODO: æ›¿æ›ç‚ºå¯¦éš›ç™»å…¥ä½¿ç”¨è€… Id
                  const resp = await fetch(`${API_BASE}/products/${productId}/favorite`, { method: 'POST' });
                  if(!resp.ok){ throw new Error(`æ”¶è—å¤±æ•— (${resp.status})`); }
                  const data = await resp.json();
                  return !!data?.isFavorited;
                }

                function money(v){
                  return new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(v ?? 0);
                }

                function renderSpecs(x){
                  const host = document.getElementById('specs');
                  if (!host) {
                      return;
                  }
                  const isGame = (x.ProductType || '').toLowerCase() === 'game';
                  let htmlContent = '';
                  if(isGame){
                    htmlContent = `
                      <ul class="list-unstyled mb-0">
                        ${x.PlatformName ? `<li>å¹³å°ï¼š${x.PlatformName}</li>` : ''}
                        ${x.GenreName ? `<li>é¡å‹ï¼š${x.GenreName}</li>` : ''}
                        ${x.PublishAt ? `<li>ç™¼å”®æ—¥ï¼š${new Date(x.PublishAt).toLocaleDateString('zh-TW')}</li>` : ''}
                        ${x.SupplierName ? `<li>ä¾›æ‡‰å•†ï¼š${x.SupplierName}</li>` : ''}
                        ${x.DownloadLink ? `<li>ä¸‹è¼‰é€£çµï¼š<a href="${x.DownloadLink}" target="_blank" rel="noopener">é»æ­¤ä¸‹è¼‰</a></li>` : ''}
                      </ul>`;
                  } else {
                    htmlContent = `
                      <ul class="list-unstyled mb-0">
                        ${x.PeripheralTypeName ? `<li>å‘¨é‚Šåˆ†é¡ï¼š${x.PeripheralTypeName}</li>` : ''}
                        ${x.SupplierName ? `<li>ä¾›æ‡‰å•†ï¼š${x.SupplierName}</li>` : ''}
                        ${x.Size ? `<li>å°ºå¯¸ï¼š${x.Size}</li>` : ''}
                        ${x.Color ? `<li>é¡è‰²ï¼š${x.Color}</li>` : ''}
                        ${x.Weight ? `<li>é‡é‡ï¼š${x.Weight}</li>` : ''}
                        ${x.Dimensions ? `<li>å¤–è§€å°ºå¯¸ï¼š${x.Dimensions}</li>` : ''}
                        ${x.Material ? `<li>æè³ªï¼š${x.Material}</li>` : ''}
                        ${x.DigitalCode ? `<li>å‹è™Ÿ/åºè™Ÿï¼š${x.DigitalCode}</li>` : ''}
                      </ul>`;
                  }
                  host.innerHTML = htmlContent;
                }

                function tryRenderYoutube(url){
                  if(!url) return;
                  try{
                    const m = String(url).match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
                    const vid = m?.[1];
                    if(!vid) return;
                    document.getElementById('video').innerHTML = `
                      <div class="ratio ratio-16x9">
                        <iframe src="https://www.youtube.com/embed/${vid}" title="YouTube video" allowfullscreen class="rounded shadow-sm"></iframe>
                      </div>`;
                  }catch{}
                }

                function renderProduct(x) {
                    if (!x) {
                        document.getElementById('name').textContent = 'æŸ¥ç„¡æ­¤å•†å“';
                        return;
                    }
                    document.getElementById('name').textContent = x.ProductName;
                    document.getElementById('price-product-name').textContent = x.ProductName;
                    document.getElementById('ptype').textContent = x.ProductType || '';
                    document.getElementById('price').textContent = `NT ${money(x.Price)}`;
                    document.getElementById('cc').textContent = x.CurrencyCode || 'TWD';
                    document.getElementById('desc').textContent = x.ProductDescription || '';
                    document.getElementById('rating').textContent = (x.RatingAvg ?? 0).toFixed(1);
                    document.getElementById('ratingcnt').textContent = `(${x.RatingCount ?? 0})`;

                    const gallery = Array.isArray(x.Gallery) && x.Gallery.length > 0 ? x.Gallery : ["/images/placeholder-cover.png"];
                    const coverEl = document.getElementById('cover');
                    coverEl.src = gallery[0];
                    coverEl.dataset.index = 0; // ç”¨æ–¼ç‡ˆç®±

                    const thumbSlots = document.querySelectorAll('#thumbs .thumb-item');
                    thumbSlots.forEach((slot, i) => {
                        const thumbIndex = i + 1;
                        if (gallery[thumbIndex]) {
                            slot.classList.remove('empty');
                            slot.innerHTML = `<img src="${gallery[thumbIndex]}" data-index="${thumbIndex}">`;
                            slot.firstElementChild.addEventListener('click', (e) => {
                                coverEl.src = e.target.src;
                                coverEl.dataset.index = e.target.dataset.index;
                            });
                        } else {
                            slot.classList.add('empty');
                            slot.innerHTML = '';
                        }
                    });

                    renderSpecs(x);
                    tryRenderYoutube(x.YoutubeUrl);
                }

                function paintStars(n){
                    document.querySelectorAll('#rate-stars i[data-star]')
                        .forEach(i=>{
                            const k = parseInt(i.getAttribute('data-star'),10);
                            i.classList.toggle('bi-star-fill', k <= n);
                            i.classList.toggle('bi-star', k > n);
                        });
                }

                async function submitReview(){
                    if(!(await ensureAuthenticated())){
                        ensureLoginPrompt();
                        new bootstrap.Modal(document.getElementById('loginPromptModal')).show();
                        return;
                    }
                    // VALIDATION LOGIC
                    if(currentRating < 1 || currentRating > 5){
                        Swal.fire({
                            title: 'è«‹å…ˆé¸æ“‡æ˜Ÿç­‰è©•åƒ¹å”·ï¼',
                            html: `
                                <style>
                                    .twinkling-stars {
                                        font-size: 3rem;
                                        animation: twinkle-stars 1.5s ease-in-out infinite alternate;
                                        margin: 1rem auto;
                                    }
                                    @@keyframes twinkle-stars {
                                        0% { opacity: 0.5; transform: scale(1); }
                                        100% { opacity: 1; transform: scale(1.1); }
                                    }
                                </style>
                                <div class="twinkling-stars">â­â­â­â­â­</div>
                            `,
                            showConfirmButton: false,
                            timer: 5000,
                            heightAuto: false
                        });
                        return;
                    }
                    const body = { rating: currentRating, review: document.getElementById('reviewText').value?.trim() || null };
                    const pid = initialData.ProductId;
                    const res = await fetch(`${API_BASE}/products/${pid}/rate`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
                    if(res.status===401){ ensureLoginPrompt(); new bootstrap.Modal(document.getElementById('loginPromptModal')).show(); return; }
                    if(!res.ok){
                        Swal.fire({
                            icon: 'error',
                            title: 'é€å‡ºè©•åƒ¹å¤±æ•—',
                            text: 'è«‹ç¨å¾Œå†è©¦',
                            timer: 5000,
                            showConfirmButton: false,
                            heightAuto: false
                        });
                        return;
                    }
                    try{
                        const detail = await (await fetch(`${API_BASE}/${pid}`)).json();
                        document.getElementById('rating').textContent = (detail.ratingAvg ?? 0).toFixed(1);
                        document.getElementById('ratingcnt').textContent = `(${detail.ratingCount ?? 0})`;
                    }catch{}
                    document.getElementById('reviewText').value = '';
                    loadReviews(true);
                    
                    // SUCCESS LOGIC
                    Swal.fire({
                        title: 'æ„Ÿè¬ä½ çš„è©•åƒ¹ï¼',
                        html: '<div style="font-size: 5rem;">ğŸ˜‰</div>',
                        showConfirmButton: false,
                        timer: 5000,
                        heightAuto: false
                    });
                }

                async function loadReviews(reset=false){
                    const pid = initialData.ProductId;
                    const host = document.getElementById('reviews');
                    const more = document.getElementById('btnMoreReviews');
                    const pageSize = 10;
                    let page = parseInt(host.getAttribute('data-page')||'0',10) || 0;
                    page = reset ? 1 : (page+1);
                    const res = await fetch(`${API_BASE}/products/${pid}/reviews?page=${page}&pageSize=${pageSize}`);
                    const data = await res.json();
                    const items = Array.isArray(data.items)? data.items : [];
                    const html = items.map(r=>{
                        const starFilled = '<i class="bi bi-star-fill text-warning"></i>'.repeat(r.Rating||0);
                        const starEmpty = '<i class="bi bi-star"></i>'.repeat(5-(r.Rating||0));
                        return `<div class="p-3 border rounded">\
                            <div class=\"d-flex justify-content-between align-items-center mb-1\">\
                                <div class=\"text-warning\">${starFilled}${starEmpty}</div>\
                                <small class=\"text-muted\">#${r.UserId} Â· ${new Date(r.CreatedAt).toLocaleString('zh-TW')}</small>\
                            </div>\
                            ${r.ReviewText ? `<div class=\"text-secondary\">${r.ReviewText}</div>` : ''}\
                        </div>`;
                    }).join('');
                    if(reset) host.innerHTML = '';
                    host.insertAdjacentHTML('beforeend', html);
                    host.setAttribute('data-page', String(page));
                    const total = parseInt(data.totalCount||0,10);
                    more.classList.toggle('d-none', page*pageSize >= total);
                }

                async function loadRelated(){
                    const host = document.getElementById('related');
                    try {
                        const pid = initialData.ProductId;
                        let url = `${API_BASE}/products?sort=random&page=1&pageSize=4`;
                        const isGame = (initialData.ProductType||'').toLowerCase()==='game';
                        if(isGame && initialData.GenreName){
                            url = `${API_BASE}/products?genre=${encodeURIComponent(initialData.GenreName)}&sort=random&page=1&pageSize=4`;
                        } else if(!isGame && initialData.MerchTypeId){
                            url = `${API_BASE}/products?merchTypeId=${encodeURIComponent(initialData.MerchTypeId)}&sort=random&page=1&pageSize=4`;
                        }
                        console.log('loadRelated URL:', url); // Log the URL

                        const res = await fetch(url);
                        console.log('loadRelated response status:', res.status); // Log status

                        if (!res.ok) {
                            console.error('loadRelated response not OK', await res.text()); // Log body text on error
                            throw new Error(`API request failed with status ${res.status}`);
                        }

                        const data = await res.json();
                        console.log('loadRelated data:', data); // Log the parsed data

                        const items = (data.items||data||[]).filter(x=>x.ProductId!==pid).slice(0,4);
                        console.log('loadRelated items:', items); // Log the final items array

                        host.innerHTML = items.map(x=>{
                            const detailUrl = `/OnlineStore/Product/Detail/${x.productCode}`;
                            const img = x.coverUrl || '/images/onlinestoreNOPic/nophoto.jpg';
                            return `<div class=\"col-6 col-md-4 col-lg-3\">\
                                <div class=\"card h-100 position-relative\">\
                                    <a class=\"card-img-top d-block\" href=\"${detailUrl}\"><img src=\"${img}\" class=\"w-100\" style=\"aspect-ratio:1/1;object-fit:cover\" onerror=\"this.src='/images/onlinestoreNOPic/nophoto.jpg'\"></a>\
                                    <div class=\"card-body p-2\">\
                                        <div class=\"small text-truncate\" title=\"${(x.productName || '').trim()}\">${(x.productName || '').trim()}</div>\
                                    </div>\
                                </div>\
                            </div>`;
                        }).join('');
                    } catch (error) {
                        console.error('Error in loadRelated:', error);
                        host.innerHTML = '<div class="text-danger">ç„¡æ³•è¼‰å…¥æ¨è–¦å•†å“ã€‚</div>'; // Show an error message
                    }
                }

                // æ–°å¢ï¼šç‡ˆç®±åŠŸèƒ½
                function initLightbox() {
                    if (typeof basicLightbox === 'undefined') {
                        console.error('basicLightbox is not loaded.');
                        return;
                    }

                    const gallery = initialData.Gallery;
                    if (!Array.isArray(gallery) || gallery.length === 0) return;

                    let currentInstance = null;

                    const showImage = (index) => {
                        const content = `
                            <img src="${gallery[index]}" style="max-height: 70vh; max-width: 70vw;">
                            ${gallery.length > 1 ? '<button class="lightbox-nav prev">&lt;</button><button class="lightbox-nav next">&gt;</button>' : ''}
                        `;
                        
                        if (currentInstance) {
                            currentInstance.element().innerHTML = content;
                        } else {
                            currentInstance = basicLightbox.create(content, {
                                onClose: () => { currentInstance = null; }
                            });
                            currentInstance.show();
                        }

                        const prevBtn = currentInstance.element().querySelector('.prev');
                        const nextBtn = currentInstance.element().querySelector('.next');

                        if (prevBtn) {
                            prevBtn.onclick = () => showImage((index - 1 + gallery.length) % gallery.length);
                        }
                        if (nextBtn) {
                            nextBtn.onclick = () => showImage((index + 1) % gallery.length);
                        }
                    };

                    document.getElementById('app').addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.matches('#cover') || target.matches('.thumb-item img')) {
                            const index = parseInt(target.dataset.index, 10);
                            if (!isNaN(index)) {
                                showImage(index);
                            }
                        }
                    });
                }


                (function(){
                  renderProduct(initialData);

                  // åˆå§‹äº®èµ·æ”¶è—ç‹€æ…‹ï¼ˆè‹¥å·²ç™»å…¥ï¼‰
                  fetch(`${API_BASE}/favorites/ids`).then(r=>r.ok?r.json():[]).then(ids=>{
                    try{
                      const pid = initialData?.ProductId;
                      if(!pid) return;
                      const btn = document.querySelector('button[data-action="fav"]');
                      const icon = btn?.querySelector('i');
                      if(Array.isArray(ids) && ids.includes(pid)){
                        btn?.classList.add('text-danger');
                        btn?.setAttribute('aria-pressed','true');
                        icon?.classList.add('bi-heart-fill');
                        icon?.classList.remove('bi-heart');
                      }
                    }catch{}
                  }).catch(()=>{});

                  document.addEventListener('click', (e)=>{
                    const btn = e.target.closest('button[data-action]');
                    if(!btn) return;
                    const act = btn.getAttribute('data-action');
                    if(act==='add-cart'){
                        if (window.Swal) {
                            Swal.fire({
                                title: 'å·²åŠ å…¥è³¼ç‰©è»Š',
                                html: `
                                    <style>
                                        .swal-cart-anim {
                                            font-size: 5rem;
                                            animation: cart-bounce 0.8s ease-in-out;
                                        }
                                        @@keyframes cart-bounce {
                                            0%, 100% { transform: translateY(0) rotate(0); }
                                            25% { transform: translateY(-10px) rotate(-5deg); }
                                            50% { transform: translateY(0) rotate(0); }
                                            75% { transform: translateY(-5px) rotate(5deg); }
                                        }
                                    </style>
                                    <div class="swal-cart-anim">ğŸ›’</div>
                                    <div class="mt-1 text-muted">å•†å“å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Š</div>
                                `,
                                showCancelButton: true,
                                confirmButtonText: 'çœ‹è³¼ç‰©è»Š',
                                cancelButtonText: 'å†é€›é€›',
                                heightAuto: false
                            }).then(r => {
                                if (r.isConfirmed) location.href = '/OnlineStore/Cart';
                            });
                        } else {
                            alert('å·²åŠ å…¥è³¼ç‰©è»Š'); // Fallback for browsers where Swal is not available
                        }
                    }else if(act==='buy-now'){
                      (async () => {
                        // First, check if the user is authenticated.
                        if (!(await ensureAuthenticated())) {
                            // SCENARIO 1: USER NOT LOGGED IN
                            Swal.fire({
                                title: 'å“å‘€ï¼Œè«‹å…ˆå®Œæˆç™»å…¥å”·ï¼',
                                html: '<div style="font-size: 5rem;">ğŸ™…â€â™€ï¸</div><p>æ‚¨éœ€è¦ç™»å…¥æ‰èƒ½è³¼è²·å•†å“å–”</p>',
                                icon: 'warning',
                                confirmButtonText: 'å¥½çš„',
                                heightAuto: false
                            });
                            return;
                        }

                        // SCENARIO 2: USER IS LOGGED IN
                        // Stage 1: "Good Taste" popup
                        Swal.fire({
                            title: 'ä½ çœŸæœ‰çœ¼å…‰ï¼',
                            html: `
                                <style>
                                    .swal-star-container {
                                        position: relative;
                                        height: 120px;
                                        display: grid;
                                        place-items: center;
                                    }
                                    .swal-star {
                                        position: absolute;
                                        opacity: 0;
                                        animation: twinkle 1.8s ease-in-out infinite;
                                    }
                                    .swal-star.thumb {
                                        font-size: 4rem;
                                        animation-delay: 0s;
                                    }
                                    .swal-star.s1 { font-size: 1.5rem; top: 20%; left: 20%; animation-delay: 0.2s; }
                                    .swal-star.s2 { font-size: 1.2rem; top: 30%; left: 80%; animation-delay: 0.5s; }
                                    .swal-star.s3 { font-size: 1.8rem; top: 70%; left: 30%; animation-delay: 0.8s; }
                                    .swal-star.s4 { font-size: 1.4rem; top: 80%; left: 70%; animation-delay: 1.1s; }

                                    @@keyframes twinkle {
                                        0%, 100% { opacity: 0; transform: scale(0.5) rotate(-30deg); }
                                        50% { opacity: 1; transform: scale(1.2) rotate(10deg); }
                                    }
                                </style>
                                <div class="swal-star-container">
                                    <div class="swal-star thumb">ğŸ‘</div>
                                    <div class="swal-star s1">âœ¨</div>
                                    <div class="swal-star s2">âœ¨</div>
                                    <div class="swal-star s3">âœ¨</div>
                                    <div class="swal-star s4">âœ¨</div>
                                </div>
                            `,
                            showConfirmButton: true,
                            confirmButtonText: 'ç«‹å³å‰å¾€çµå¸³',
                            showDenyButton: true,
                            denyButtonText: 'æˆ‘å¥½åƒçŒ¶è±«äº†',
                            heightAuto: false
                        }).then((result) => {
                            // Stage 2: Handle the button click from Stage 1
                            if (result.isDenied) {
                                // User clicked "I'm hesitating"
                                Swal.fire({
                                    title: 'å†è€ƒæ…®ä¸€ä¸‹å—ï¼Ÿ',
                                    html: '<div style="font-size: 5rem;">ğŸ¤”</div>',
                                    showConfirmButton: false,
                                    timer: 2000, // Auto-close after 2 seconds
                                    heightAuto: false
                                });
                            }
                            // If result.isConfirmed (user clicked "Go to checkout"), do nothing as it's a fake button.
                        });
                      })();
                    }else if(act==='fav'){
                      if(!initialData?.ProductId){ return; }
                      btn.disabled = true;
                      toggleFavorite(initialData.ProductId)
                        .then(isFav => {
                          const icon = btn.querySelector('i');
                          if(isFav){
                            btn.classList.add('text-danger');
                            btn.setAttribute('aria-pressed','true');
                            icon?.classList.remove('bi-heart');
                            icon?.classList.add('bi-heart-fill');

                            // Show "Thank you" popup
                            Swal.fire({
                                title: 'æ„Ÿè¬ä½ æ”¶è—ï¼',
                                html: `
                                    <style>
                                        .pulse-heart {
                                            font-size: 4rem;
                                            animation: pulse-heart-anim 1.2s ease-in-out infinite;
                                        }
                                        @@keyframes pulse-heart-anim {
                                            0% { transform: scale(1); }
                                            50% { transform: scale(1.3); }
                                            100% { transform: scale(1); }
                                        }
                                    </style>
                                    <div class="pulse-heart">â¤ï¸</div>
                                `,
                                showConfirmButton: false,
                                timer: 1500, // Auto-close after 1.5 seconds
                                heightAuto: false
                            });

                          }else{
                            btn.classList.remove('text-danger');
                            btn.setAttribute('aria-pressed','false');
                            icon?.classList.add('bi-heart');
                            icon?.classList.remove('bi-heart-fill');
                          }
                        })
                        .catch(err => {
                          console.error(err);
                          if(String(err.message||"").includes("401") || String(err).includes("Unauthorized")){
                            ensureLoginPrompt();
                            const modal = new bootstrap.Modal(document.getElementById('loginPromptModal'));
                            modal.show();
                          }else{
                            alert('åŠ å…¥æ”¶è—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                          }
                        })
                        .finally(()=>{ btn.disabled = false; });
                    }
                  });

                  // è©•æ˜Ÿäº’å‹•
                  document.getElementById('rate-stars')?.addEventListener('click', async (e)=>{
                    const i = e.target.closest('i[data-star]');
                    if(!i) return;
                    if(!(await ensureAuthenticated())){ ensureLoginPrompt(); new bootstrap.Modal(document.getElementById('loginPromptModal')).show(); return; }
                    currentRating = parseInt(i.getAttribute('data-star'),10) || 0;
                    paintStars(currentRating);
                  });
                  document.getElementById('btnSubmitReview')?.addEventListener('click', submitReview);

                  // åˆå§‹è©•è«–èˆ‡æ¨è–¦
                  loadReviews(true);
                  loadRelated();
                  initLightbox(); // åˆå§‹åŒ–ç‡ˆç®±
                })();
    </script>
}

