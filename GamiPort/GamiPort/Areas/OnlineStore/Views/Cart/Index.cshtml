@{
    ViewData["Title"] = "我的購物車";
    var initShipMethodId = (int)(ViewData["shipMethodId"] ?? 1);
    var initDestZip = (string)(ViewData["destZip"] ?? "320");
    var initCoupon = (string)(ViewData["couponCode"] ?? "");
}

@* 反 CSRF：給 AJAX 用 *@
<form id="af-token-form">@Html.AntiForgeryToken()</form>


<div class="container py-4">

    <h2 class="mb-3">@ViewData["Title"]</h2>
    @* <environment include="Development">
        <div class="mb-3">
            <button id="devSeed" class="btn btn-outline-secondary btn-sm">插入測試品項</button>
        </div>
    </environment> *@
    <environment include="Development">
        <div class="mb-3">
            <button id="devSeed" type="button" class="btn btn-outline-secondary btn-sm">
                插入測試品項
            </button>
        </div>
    </environment>

    <!-- 上方：配送/郵遞區號/優惠碼 -->
    <div class="row g-3 align-items-end mb-3">
        <div class="col-12 col-md-3">
            <label class="form-label">配送方式</label>
            <select id="shipMethodSelect" class="form-select">
                <option value="1">宅配</option>
                <option value="2">超商取貨</option>
                <option value="3">黑貓冷凍</option>
            </select>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label">郵遞區號</label>
            <input id="destZipInput" class="form-control" maxlength="10" />
        </div>
        <div class="col-12 col-md-4">
            <label class="form-label">優惠碼</label>
            <div class="input-group">
                <input id="couponInput" class="form-control" placeholder="輸入優惠碼" />
                <button id="applyCoupon" class="btn btn-primary" type="button">套用</button>
                <button id="clearCoupon" class="btn btn-outline-secondary" type="button">清除</button>
            </div>
            <div id="couponMsg" class="small mt-1"></div>
        </div>
    </div>

    <!-- 明細表格 -->
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th style="width:72px;">圖</th>
                    <th>商品</th>
                    <th class="text-end" style="width:120px;">單價</th>
                    <th class="text-center" style="width:160px;">數量</th>
                    <th class="text-end" style="width:140px;">小計</th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody id="cartTableBody"></tbody>
        </table>
    </div>

    <!-- 空車版面（預設隱藏） -->
    <div id="emptyView" class="text-center py-5 d-none">
        <p class="fs-5 mb-3">你的購物車是空的</p>
        <a href="/OnlineStore/Products" class="btn btn-primary">去逛逛</a>
    </div>

    <!-- 總計區 -->
    <div id="summaryPanel" class="card ms-auto" style="max-width:480px;">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <span>小計</span><strong id="subtotal">—</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>折扣</span><strong id="discount">—</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>運費</span><strong id="shipping">—</strong>
            </div>
            <hr />
            <div class="d-flex justify-content-between fs-5">
                <span>應付金額</span><strong id="grandTotal">—</strong>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between">
            @if (TempData["Toast"] is string tip)
            {
                <div class="alert alert-warning">@tip</div>
            }
            <form asp-area="OnlineStore" asp-controller="Cart" asp-action="GoCheckout" method="post">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary">前往結帳</button>
            </form>
        </div>
    </div>

</div>
<!-- Toast 容器（右上角） -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="appToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="appToastBody">發生錯誤</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // =================== 可調參數 ===================
        const SHOW_ZERO_BADGE = false;    // true: 0 也顯示徽章；false: 0 隱藏
        const INPUT_DEBOUNCE  = 500;      // 直接輸入的防抖毫秒
        const QTY_MIN = 1, QTY_MAX = 99;  // 數量邊界
        // ===============================================

        // Anti-Forgery
        function getAfToken() {
          return document.querySelector('#af-token-form input[name="__RequestVerificationToken"]').value;
        }

        // 全域狀態
        const state = {
          shipMethodId: @initShipMethodId,
          destZip: '@initDestZip',
          couponCode: '@initCoupon',
          busy: false,
          debounceTimer: null
        };

        // Bootstrap Toast
        let toastRef = null;
        function showToast(msg, variant = 'danger') {
          const el = document.getElementById('appToast');
          const body = document.getElementById('appToastBody');
          body.textContent = msg || '發生錯誤';
          el.classList.remove('text-bg-danger','text-bg-success','text-bg-warning','text-bg-info');
          el.classList.add('text-bg-' + (variant || 'danger'));
          if (!toastRef) toastRef = new bootstrap.Toast(el, { delay: 2500 });
          toastRef.show();
        }
        function showError(msg){ showToast(msg || '操作失敗', 'danger'); }
        function showInfo(msg){ showToast(msg || '已更新', 'success'); }

        // Busy 狀態：統一 disable/enable 按鈕與輸入
        function setBusy(on) {
          state.busy = !!on;
          const root = document;
          // 主要互動元件
          root.querySelectorAll('button, input, select, a.btn').forEach(el => {
            if (el.id === 'devSeed') return; // DEV 按鈕不一定要鎖
            el.disabled = on || el.dataset.lock === '1';
            el.classList.toggle('disabled', !!(on || el.disabled));
          });
        }

        // 數字 → $1,234
        function money(n) {
          if (n === null || n === undefined) return '—';
          return n.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        // ====== 載入整車（Full） ======
        async function loadFull() {
          const url = new URL(location.origin + '/OnlineStore/Cart/Full');
          url.searchParams.set('shipMethodId', state.shipMethodId);
          url.searchParams.set('destZip', state.destZip || '');
          if (state.couponCode) url.searchParams.set('couponCode', state.couponCode);

          try {
            const res = await fetch(url, { method: 'GET', credentials: 'same-origin' });
            const data = await res.json();
            if (!data.ok) return showError(data.message || '載入失敗');
            renderAll(data);
          } catch {
            showError('網路或伺服器錯誤，請稍後再試');
          }
        }

        // ====== 更新數量 / 刪除 / 清空（POST）FormData 版 ======
        async function postAndRefresh(path, body) {
          if (state.busy) return;
          setBusy(true);
          try {
            const form = new FormData();
            form.append('__RequestVerificationToken', getAfToken());
            form.append('shipMethodId', state.shipMethodId);
            form.append('destZip', state.destZip || '');
            if (state.couponCode) form.append('couponCode', state.couponCode);
            Object.entries(body || {}).forEach(([k, v]) => form.append(k, v));

            const res = await fetch('/OnlineStore/Cart/' + path, {
              method: 'POST',
              body: form,
              credentials: 'same-origin'
            });
            const data = await res.json();
            if (!data.ok) return showError(data.message || '操作失敗');
            renderAll(data);
          } catch {
            showError('網路或伺服器錯誤，請稍後再試');
          } finally {
            setBusy(false);
          }
        }

        // ====== 渲染 ======
        function renderAll(data) {
          renderTable(data.items || []);
          renderSummary(data.summary || {});

          // Navbar 徽章
          const qty = (data.summary?.totalQty ?? data.summary?.itemCountTotal ?? data.summary?.Item_Count_Total ?? 0);
          syncNavBadge(qty);

          // 優惠碼提示
          const msg = document.getElementById('couponMsg');
          msg.className = 'small mt-1';
          if (data.summary?.couponMessage) {
            msg.textContent = data.summary.couponMessage;
            msg.classList.add('text-success');
          } else {
            msg.textContent = '';
          }
        }

        function renderTable(items) {
          const tbody = document.getElementById('cartTableBody');
          tbody.innerHTML = '';
          if (!items.length) {
            document.getElementById('emptyView').classList.remove('d-none');
            document.getElementById('summaryPanel').classList.add('d-none');
            return;
          }
          document.getElementById('emptyView').classList.add('d-none');
          document.getElementById('summaryPanel').classList.remove('d-none');

          for (const it of items) {
            const tr = document.createElement('tr');
            tr.dataset.productId = it.productId;
            tr.innerHTML = `
              <td>${it.imageThumb ? `<img src="${it.imageThumb}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;">` : ''}</td>
              <td class="fw-semibold">${escapeHtml(it.productName || '')}</td>
              <td class="text-end">$${money(it.unitPrice)}</td>
              <td class="text-center">
                <div class="input-group input-group-sm justify-content-center" style="max-width:160px;margin:auto;">
                  <button class="btn btn-outline-secondary btn-minus" type="button" aria-label="decrease">−</button>
                  <input class="form-control text-center qty-input" value="${it.quantity}" inputmode="numeric" pattern="[0-9]*">
                  <button class="btn btn-outline-secondary btn-plus" type="button" aria-label="increase">+</button>
                </div>
                <div class="text-danger small d-none qty-error">數量需為 ${QTY_MIN}–${QTY_MAX} 的整數</div>
              </td>
              <td class="text-end">$${money(it.lineSubtotal)}</td>
              <td><button class="btn btn-outline-danger btn-sm btn-remove" type="button">刪除</button></td>
            `;
            tbody.appendChild(tr);
          }

          // 綁事件
          tbody.querySelectorAll('.btn-minus').forEach(btn => btn.addEventListener('click', onMinus));
          tbody.querySelectorAll('.btn-plus').forEach(btn => btn.addEventListener('click', onPlus));
          tbody.querySelectorAll('.qty-input').forEach(inp => {
            inp.dataset.prev = clampQty(inp.value) ?? QTY_MIN;     // 記住上次合法值
            inp.addEventListener('input', onQtyTyping);
            inp.addEventListener('blur', onQtyCommit);
            inp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.target.blur(); } });
          });
          tbody.querySelectorAll('.btn-remove').forEach(btn => btn.addEventListener('click', onRemove));
        }

        function renderSummary(s) {
          document.getElementById('subtotal').textContent   = '$' + money(s.subtotal ?? 0);
          const d = s.discount ?? 0;
          document.getElementById('discount').textContent   = d ? ('-$' + money(Math.abs(d))) : '$0';
          const ship = s.shipping ?? s.shippingFee ?? 0;
          document.getElementById('shipping').textContent   = ship > 0 ? ('$' + money(ship)) : '免運';
          document.getElementById('grandTotal').textContent = '$' + money(s.grandTotal ?? 0);
        }

        function syncNavBadge(totalQty) {
          const badge = document.getElementById('navCartBadge');
          if (!badge) return;
          const textEl = badge.querySelector('.badge-count') ?? badge;
          const n = Math.max(0, parseInt(totalQty ?? 0, 10) || 0);
          textEl.textContent = n > 99 ? '99+' : String(n);
          badge.classList.toggle('d-none', !SHOW_ZERO_BADGE && n <= 0);
        }

        // ====== 事件邏輯 ======
        function getRowInfo(el) {
          const tr = el.closest('tr');
          const productId = parseInt(tr.dataset.productId, 10);
          const qtyInput = tr.querySelector('.qty-input');
          const err = tr.querySelector('.qty-error');
          return { tr, productId, qtyInput, err };
        }
        function clampQty(v) {
          const n = parseInt(v, 10);
          if (Number.isNaN(n)) return null;
          if (n < QTY_MIN || n > QTY_MAX) return null;
          return n;
        }

        // 列鎖（避免同列連點）
        function acquireRowLock(tr){ if(tr.dataset.lock==='1') return false; tr.dataset.lock='1'; return true; }
        function releaseRowLock(tr){ tr.dataset.lock='0'; }

        // −：1→刪除；其餘減 1
        async function onMinus(e) {
          const { tr, productId, qtyInput } = getRowInfo(e.currentTarget);
          if (!acquireRowLock(tr) || state.busy) return;
          try {
            const cur = clampQty(qtyInput.value) ?? QTY_MIN;
            if (cur <= QTY_MIN) return await postAndRefresh('Remove', { productId });
            await postAndRefresh('UpdateQty', { productId, qty: cur - 1 });
          } finally { releaseRowLock(tr); }
        }

        // ＋：加 1，上限 QTY_MAX
        async function onPlus(e) {
          const { tr, productId, qtyInput } = getRowInfo(e.currentTarget);
          if (!acquireRowLock(tr) || state.busy) return;
          try {
            const cur = clampQty(qtyInput.value) ?? QTY_MIN;
            await postAndRefresh('UpdateQty', { productId, qty: Math.min(QTY_MAX, cur + 1) });
          } finally { releaseRowLock(tr); }
        }

        // 防抖：停手 INPUT_DEBOUNCE ms 後送；非法值只顯示錯誤不送
        function onQtyTyping(e) {
          const { productId, qtyInput, err } = getRowInfo(e.currentTarget);
          clearTimeout(state.debounceTimer);
          state.debounceTimer = setTimeout(() => {
            const q = clampQty(qtyInput.value);
            if (q === null) {
              err.classList.remove('d-none');
              return;
            }
            err.classList.add('d-none');
            qtyInput.dataset.prev = q;
            postAndRefresh('UpdateQty', { productId, qty: q });
          }, INPUT_DEBOUNCE);
        }

        // 失焦保底送；若仍非法就還原到上一個合法值
        function onQtyCommit(e) {
          const { productId, qtyInput, err } = getRowInfo(e.currentTarget);
          const q = clampQty(qtyInput.value);
          if (q === null) {
            err.classList.remove('d-none');
            qtyInput.value = qtyInput.dataset.prev ?? QTY_MIN; // ← 還原
            return;
          }
          err.classList.add('d-none');
          qtyInput.dataset.prev = q;
          postAndRefresh('UpdateQty', { productId, qty: q });
        }

        async function onRemove(e) {
          const { productId } = getRowInfo(e.currentTarget);
          await postAndRefresh('Remove', { productId });
        }

        // 清空
                {
          const btnClear = document.getElementById('btnClear');
          if (btnClear) {
            btnClear.addEventListener('click', () => {
              if (confirm('確定要清空購物車嗎？')) postAndRefresh('Clear', {});
            });
          }
        }

        // 配送 / 郵遞區號 / 優惠碼
        document.getElementById('shipMethodSelect').addEventListener('change', (e) => {
          state.shipMethodId = parseInt(e.target.value, 10) || 1;
          loadFull();
        });
        document.getElementById('destZipInput').addEventListener('blur', (e) => {
          state.destZip = (e.target.value || '').trim();
          loadFull();
        });
        document.getElementById('applyCoupon').addEventListener('click', () => {
          state.couponCode = (document.getElementById('couponInput').value || '').trim();
          loadFull();
        });
        document.getElementById('clearCoupon').addEventListener('click', () => {
          state.couponCode = '';
          document.getElementById('couponInput').value = '';
          loadFull();
        });

        // 安全轉義
        function escapeHtml(str) {
          return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
        }

        // 初始化
        (function init() {
          document.getElementById('shipMethodSelect').value = String(state.shipMethodId);
          document.getElementById('destZipInput').value = state.destZip || '';
          document.getElementById('couponInput').value = state.couponCode || '';
          loadFull();
        })();

              



        (function() {
          const btn = document.getElementById('devSeed');
          if (!btn) return;

          btn.addEventListener('click', async function (e) {
            e.preventDefault();
            console.log('[dev] click devSeed');

            // 直接打 DevSeed10（一次加入 121–130 各 1 件）
            const url = new URL(location.origin + '/OnlineStore/Cart/DevSeed10');
            // 如果你的頁面有 state，可以照舊帶：這裡先保留最少參數
            url.searchParams.set('shipMethodId', 1);
            url.searchParams.set('destZip', '320');

            try {
              const res = await fetch(url, { method: 'GET' });
              if (!res.ok) {
                const text = await res.text();
                console.error('DevSeed10 error:', res.status, text);
                window.alert('插入失敗：' + res.status + '\n' + text.substring(0, 200));
                return;
              }
              const data = await res.json();   // 你的 Full() 原本回傳 JSON
              console.log('[dev] DevSeed10 ok', data);

              // 這裡呼叫你既有的重繪方法（如果有）
              if (window.renderCartFromJson) {
                window.renderCartFromJson(data);
              } else {
                // 臨時 fallback：直接重新整理（保證你看得到結果）
                location.reload();
              }
            } catch (err) {
              console.error(err);
              window.alert('插入異常：' + (err?.message || err));
            }
          });
        })();

    </script>
}

