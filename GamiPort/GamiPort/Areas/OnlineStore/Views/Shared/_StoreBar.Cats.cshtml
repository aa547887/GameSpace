@using GamiPort.Models
@using Microsoft.EntityFrameworkCore;
@inject GameSpacedatabaseContext db


<nav id="storeCats" class="store-cats sticky-top bg-white border-top border-bottom">
    <div class="container-xxl position-relative">
        <ul class="store-cats-list d-flex align-items-center gap-2 flex-wrap py-2 mb-0">

            <!-- Direct Links -->
            <li>
                <a class="cats-pill no-dd" href="/OnlineStore/Browse/Index?type=game" title="遊戲商品">遊戲商品</a>
            </li>
            <li>
                <a class="cats-pill no-dd" href="/OnlineStore/Browse/Index?type=notgame" title="周邊商品">周邊商品</a>
            </li>

            <!-- Quick Filters (你給的固定項目) -->
            @* <li class="ms-2 me-1 text-muted small d-none d-lg-inline">快速：</li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=game&platform=NS">NS</a></li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=game&platform=PS5">PS5</a></li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=game&platform=PC">PC</a></li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=game&genre=RPG">RPG</a></li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=game&genre=ACT">ACT</a></li>
            <li class="vr d-none d-lg-inline mx-1"></li> *@
            @* <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=notgame">全部周邊</a></li> *@
            @* <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=notgame&peripheral=figure">公仔</a></li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=notgame&peripheral=apparel">服飾</a></li>
            <li><a class="cats-pill quick" href="/OnlineStore/Browse/Index?type=notgame&peripheral=card">點數卡</a></li> *@

            <li class="ms-auto"></li>

            <!-- Platforms Dropdown -->
            <li class="dropdown hover-dd">
                <a class="cats-pill dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">平台分類</a>
                <ul class="dropdown-menu show-on-hover shadow-lg">
                    <li class="dropdown-header small text-secondary px-3">平台分類</li>
                    <li><a class="dropdown-item" href="/OnlineStore/Browse/Index?type=game">全部平台</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    @foreach (var platform in db.SPlatforms.AsNoTracking().OrderBy(x => x.PlatformName).ThenBy(x => x.PlatformName).ToList())
                    {
                        <li>
                            @* 你的 API 若吃 platformId，這裡用 platformId；若改成吃平台代碼名稱，可以把參數改為 &platform=@platform.PlatformCode *@
                            <a class="dropdown-item" href="/OnlineStore/Browse/Index?type=game&platformId=@platform.PlatformId">@platform.PlatformName</a>
                        </li>
                    }
                </ul>
            </li>

            <!-- Genres Dropdown -->
            <li class="dropdown hover-dd">
                <a class="cats-pill dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">遊戲類型</a>
                <ul class="dropdown-menu show-on-hover shadow-lg">
                    <li class="dropdown-header small text-secondary px-3">遊戲類型</li>
                    <li><a class="dropdown-item" href="/OnlineStore/Browse/Index?type=game">全部類型</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    @foreach (var genre in db.SGameGenres.AsNoTracking().OrderBy(x => x.GenreName).ToList())
                    {
                        <li>
                            @* 若前端改吃文字參數，可改為 &genre=@genre.GenreCode *@
                            <a class="dropdown-item" href="/OnlineStore/Browse/Index?type=game&genreId=@genre.GenreId">@genre.GenreName</a>
                        </li>
                    }
                </ul>
            </li>

            <!-- Merchandise Types Dropdown -->
            <li class="dropdown hover-dd">
                <a class="cats-pill dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">周邊分類</a>
                <ul class="dropdown-menu show-on-hover shadow-lg">
                    <li class="dropdown-header small text-secondary px-3">周邊分類</li>
                    <li><a class="dropdown-item" href="/OnlineStore/Browse/Index?type=notgame">全部周邊</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    @foreach (var merchType in db.SMerchTypes.AsNoTracking().OrderBy(x => x.MerchTypeName).ToList())
                    {
                        <li>
                            <a class="dropdown-item" href="/OnlineStore/Browse/Index?type=notgame&merchTypeId=@merchType.MerchTypeId">@merchType.MerchTypeName</a>
                        </li>
                    }
                </ul>
            </li>

            <!-- Suppliers Dropdown -->
            <li class="dropdown hover-dd">
                <a class="cats-pill dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">供應商</a>
                <ul class="dropdown-menu show-on-hover shadow-lg suppliers-menu">
                    <li class="dropdown-header small text-secondary px-3">品牌 / 發行商</li>
                    @foreach (var supplier in db.SSuppliers.AsNoTracking().Where(s => s.IsActive == 1).OrderBy(s => s.SupplierName).ToList())
                    {
                        <li><a class="dropdown-item" href="/OnlineStore/Browse/Index?supplierId=@supplier.SupplierId">@supplier.SupplierName</a></li>
                    }
                </ul>
            </li>
        </ul>
    </div>
</nav>


<style>
    :root {
        --topbar-h: 68px; /* Default height, will be updated by JS */
    }

    #storeCats {
        top: var(--topbar-h);
        z-index: 1019; /* Lower than main topbar (1020) to slide under */
        transition: transform .25s ease, box-shadow .2s ease;
    }

        #storeCats.sc-hide {
            transform: translateY(-100%);
            box-shadow: none;
        }

        #storeCats.sc-show {
            transform: translateY(0);
            box-shadow: 0 6px 22px rgba(0,0,0,.08);
        }

    .store-cats-list {
        list-style: none;
        margin: 0;
        padding: .5rem 0;
        display: flex;
        justify-content: center;
        gap: 1.1rem;
        flex-wrap: wrap;
    }

    /* pill 外觀（沿用你原本風格，可微調） */
    .store-cats .cats-pill {
        display: inline-block;
        padding: .5rem .9rem;
        border-radius: 999px;
        background: transparent;
        color: #111;
        text-decoration: none;
        transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
        border: 1px solid transparent;
    }

        .store-cats .cats-pill.no-dd {
            background: #f7f7f9;
            border-color: #eee;
        }

        /* 懸浮騰空＋陰影 */
        .store-cats .cats-pill:hover,
        .store-cats .dropdown-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(0,0,0,.12);
        }

        /* 快速篩選 pill 視覺淡一點 */
        .store-cats .cats-pill.quick {
            background: #fff;
            border-color: #eee;
        }

    /* dropdown hover（滑過父項即可顯示，下拉仍可用 Bootstrap 的 data-bs-toggle） */
    .hover-dd:hover > .dropdown-menu {
        display: block;
        margin-top: .5rem;
    }

    /* 下拉選單樣式微調 */
    .store-cats .dropdown-menu {
        border-radius: .75rem;
        overflow: hidden;
        min-width: 220px;
    }

    .store-cats .dropdown-item {
        transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
        border-radius: .5rem;
        margin: .15rem .4rem;
    }

    .cats-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 26px rgba(0,0,0,.12);
        background: #fff;
    }

    .hover-dd:hover > .dropdown-menu {
        display: block;
    }

    /* Other existing styles... */
    .hover-dd {
        position: relative;
    }

        .hover-dd .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + .5rem);
            left: 0;
            border-radius: 14px;
            padding: .5rem;
            z-index: 1060;
            background: #fff;
        }

    .store-cats, .container-xxl {
        overflow: visible !important;
    }

    .suppliers-menu {
        max-height: 50vh;
        overflow-y: auto;
        min-width: 260px;
    }

    @@media (max-width: 992px) {
        .store-cats-list {
            justify-content: flex-start;
            gap: .6rem;
            padding: .4rem .5rem;
        }
    }

    /* Jelly / 果凍感：圓角 + 玻璃感 + 微陰影 */
    .cats-jellybar {
        display: flex;
        justify-content: center;
        gap: .5rem;
    }

    .cats-pill {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .425rem .9rem;
        border-radius: 999px;
        backdrop-filter: blur(6px);
        background: rgba(255,255,255,.6);
        border: 1px solid rgba(255,255,255,.65);
        box-shadow: 0 4px 14px rgba(0,0,0,.08);
        transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
        text-decoration: none;
        color: #111;
    }

        .cats-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(0,0,0,.12);
        }

        .cats-pill:active {
            transform: translateY(0);
        }

        .cats-pill .bi {
            font-size: 1rem;
        }
</style>

<script>
    (function(){
        const catBar = document.getElementById('storeCats');
        const topBar = document.querySelector('.topbar1.navbar');
        if(!catBar || !topBar) return;

        let lastY = window.scrollY;
        let ticking = false;

        // Function to set the correct top position
        function setTopPosition() {
            const topbarHeight = topBar.offsetHeight;
            catBar.style.top = topbarHeight + 'px';
        }

        // Function to handle scroll events
        function onScroll(){
            const y = window.scrollY;
            const goingDown = y > lastY + 10;
            const goingUp = y < lastY - 10;

            if (y > (topBar.offsetHeight + catBar.offsetHeight)) { // Start hiding only after scrolling past both bars
                if(goingDown){
                    catBar.classList.remove('sc-show');
                    catBar.classList.add('sc-hide');
                } else if(goingUp){
                    catBar.classList.remove('sc-hide');
                    catBar.classList.add('sc-show');
                }
            } else {
                // Keep it shown when near the top
                catBar.classList.remove('sc-hide');
                catBar.classList.add('sc-show');
            }

            lastY = y < 0 ? 0 : y;
            ticking = false;
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            setTopPosition(); // Set position on load
            catBar.classList.add('sc-show'); // Set initial visible state

            // Add scroll listener
            window.addEventListener('scroll', ()=>{
                if(!ticking){
                    window.requestAnimationFrame(onScroll);
                    ticking = true;
                }
            }, {passive:true});

            // Re-calculate on window resize
            window.addEventListener('resize', setTopPosition);
        });

          // 共用導頁：把條件轉成 /OnlineStore/Browse 的 querystring
    function goToBrowse(params){
      const url = new URL('/OnlineStore/Browse', location.origin);
      // 只帶我們想帶的參數（與你的 GetProducts 對齊）
      const allow = ['q','type','platformId','merchTypeId','priceMin','priceMax','sort','tag'];
      Object.entries(params||{}).forEach(([k,v])=>{
        if(v!==undefined && v!==null && v!==''){
          if(allow.includes(k)) url.searchParams.set(k, v);
        }
      });
      location.href = url.toString();
    }

    // 綁定：新品 / 折扣
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('[data-cmd="go-browse"]');
      if(!a) return;
      const sort = a.getAttribute('data-sort') || undefined;
      const tag  = a.getAttribute('data-tag')  || undefined;
      goToBrowse({ sort, tag });
    });
    })();
</script>