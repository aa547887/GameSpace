@model CheckoutStep1Vm

@{
    ViewData["Title"] = "結帳（1/3）收件/配送";
    var full = ViewBag.Full;
}

<h2 class="mb-3">結帳（1/3）收件/配送</h2>

<div class="row g-4">
    <div class="col-lg-8">
        <form id="checkout-step1-form" asp-action="Step1" method="post" novalidate>
            @Html.AntiForgeryToken()

            <div class="mb-3">
                <label class="form-label">收件人</label>
                <input asp-for="Recipient" class="form-control" />
                <span asp-validation-for="Recipient" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">電話</label>
                <input asp-for="Phone" class="form-control" />
                <span asp-validation-for="Phone" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">郵遞區號</label>
                    <input asp-for="DestZip" class="form-control" id="Zipcode" placeholder="例如：100、320…" />
                    <span asp-validation-for="DestZip" class="text-danger"></span>
                </div>
                <div class="col-md-9 mb-3">
                    <label class="form-label">地址（路名/門牌）</label>
                    <input asp-for="Address1" class="form-control" id="Address1" placeholder="例如：中山北路三段 123 號" />
                    <span asp-validation-for="Address1" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">地址補充</label>
                <input asp-for="Address2" class="form-control" />
                <span asp-validation-for="Address2" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">配送方式</label>
                    <select asp-for="ShipMethodId" class="form-select" id="ShipMethodId">
                        @foreach (var sm in (IEnumerable<dynamic>)ViewBag.ShipMethods)
                        {
                            <option value="@sm.ShipMethodId">@sm.MethodName</option>
                        }
                    </select>
                    <span asp-validation-for="ShipMethodId" class="text-danger"></span>
                    <div class="form-text">※ 選擇不同配送方式會影響運費與免運門檻。</div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <a asp-area="OnlineStore" asp-controller="Cart" asp-action="Index" class="btn btn-outline-secondary">
                    返回購物車
                </a>
                <button id="btnStep1Next" type="submit" class="btn btn-primary" disabled>
                    下一步：付款方式
                </button>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <partial name="_CheckoutSummary" model="full.Summary" />
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const $form = $("#checkout-step1-form");
            const $next = $("#btnStep1Next");

            if ($.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse($form);
            }

            function toggleNextByValidity() {
                const valid = $form.valid();
                $next.prop("disabled", !valid);
            }

            toggleNextByValidity();

            // 只監聽 ship + zip（Step1 不再處理 coupon）
            (function attachSummaryRefresh() {
                const $zip = document.getElementById('Zipcode');
                const $ship = document.getElementById('ShipMethodId');
                let timer; const deb = fn => { clearTimeout(timer); timer = setTimeout(fn, 400); };

                async function refreshSummary() {
                    const ship = $ship?.value || 1;
                    const zip  = $zip?.value  || '';
                    const url  = `/OnlineStore/Checkout/SummaryBox?shipMethodId=${encodeURIComponent(ship)}&destZip=${encodeURIComponent(zip)}`;
                    const res  = await fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest' }});
                    if (!res.ok) return;
                    const html = await res.text();
                    const box  = document.getElementById('summaryBox');
                    if (box) {
                        const tmp = document.createElement('div'); tmp.innerHTML = html.trim();
                        const newBox = tmp.querySelector('#summaryBox'); if (newBox) box.replaceWith(newBox);
                    }
                }

                $ship?.addEventListener('change', ()=>{ deb(refreshSummary); });
                $zip?.addEventListener('input',  ()=>{ deb(refreshSummary); });
            })();

            $form.on("keyup change", "input, select, textarea", function () {
                const $field = $(this);
                if ($field.attr("name")) $form.validate().element($field);
                toggleNextByValidity();
            });

            $form.on("submit", function (e) {
                if (!$form.valid()) {
                    e.preventDefault();
                    const $firstError = $form.find(".input-validation-error").first();
                    if ($firstError.length) $firstError.trigger("focus");
                    return false;
                }
                $next.prop("disabled", true).text("處理中…");
            });
        })();
    </script>
}
