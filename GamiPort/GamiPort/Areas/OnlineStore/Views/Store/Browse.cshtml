<!--這是舊的了用不到整個檔案都是-->


@* @{
    ViewData["Title"] = "全部商品 - GamiStore";
}

@section Styles {
    <style>
        .rank-tabs .nav-link.active {
            font-weight: 700
        }

        .product-card img {
            object-fit: cover;
            width: 100%;
            height: 180px
        }

        .sticky-side {
            position: sticky;
            top: 72px
        }
    </style>
}

<div class="container-xxl py-3">
    <div class="row g-3">
        <aside class="col-lg-2 d-none d-lg-block">
            <div class="sticky-side">
                <div class="list-group small">
                    <a class="list-group-item list-group-item-action" href="/OnlineStore/store/browse?type=game">數位/主機</a>
                    <a class="list-group-item list-group-item-action" href="/OnlineStore/store/browse?type=notgame">週邊/點數</a>
                    <a class="list-group-item list-group-item-action" href="/OnlineStore/store/browse?tag=sale">特價</a>
                </div>
            </div>
        </aside>

        <div class="col-12 col-lg-10">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <div class="input-group" style="max-width:520px">
                    <input id="q" class="form-control" placeholder="搜尋想要的商品或遊戲…" />
                    <button id="btnSearch" class="btn btn-primary">搜尋</button>
                </div>
                <div class="vr mx-1 d-none d-lg-block"></div>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm filter-type" data-type="">全部</button>
                    <button class="btn btn-outline-secondary btn-sm filter-type" data-type="game">數位/主機</button>
                    <button class="btn btn-outline-secondary btn-sm filter-type" data-type="notgame">週邊/點數</button>
                </div>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <select id="sort" class="form-select form-select-sm" style="width:auto">
                        <option value="newest">最新</option>
                        <option value="price_asc">價格 ↑</option>
                        <option value="price_desc">價格 ↓</option>
                    </select>
                    <select id="pageSize" class="form-select form-select-sm" style="width:auto">
                        <option>12</option>
                        <option>24</option>
                        <option>36</option>
                    </select>
                </div>
            </div>

            <div id="product-list" class="row g-3"></div>
            <nav class="mt-3"><ul class="pagination pagination-sm" id="pager"></ul></nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const apiBase="/api/store";
        let state={
          q:new URLSearchParams(location.search).get("q")||"",
          type:new URLSearchParams(location.search).get("type")||"",
          sort:"newest", page:1, pageSize:12
        };
        if(state.q) document.getElementById("q").value=state.q;

        document.getElementById("btnSearch").addEventListener("click",()=>{ state.q=document.getElementById("q").value.trim(); state.page=1; load(); });
        document.getElementById("sort").addEventListener("change",e=>{ state.sort=e.target.value; state.page=1; load(); });
        document.getElementById("pageSize").addEventListener("change",e=>{ state.pageSize=parseInt(e.target.value,10)||12; state.page=1; load(); });
        document.querySelectorAll(".filter-type").forEach(btn=>{
          btn.addEventListener("click",()=>{
            document.querySelectorAll(".filter-type").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active"); state.type=btn.dataset.type||""; state.page=1; load();
          });
        });

        function cardCol(item){
          const p = new Intl.NumberFormat('zh-TW',{style:'currency',currency:item.currencyCode||'TWD'}).format(item.price||0);
          const platform = item.platformName?`<span class="badge bg-secondary">${item.platformName}</span>`:"";
          return `<div class="col-6 col-md-4 col-lg-3">
            <div class="card product-card h-100">
              <img src="${item.coverUrl||""}" class="card-img-top" alt="${(item.productName||"").replace(/"/g,'&quot;')}" onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-1">${platform}${item.isPreorder?'<span class="badge bg-danger">預購</span>':''}</div>
                <h6 class="card-title mb-2 text-truncate" title="${(item.productName||"").replace(/"/g,'&quot;')}">${item.productName||""}</h6>
                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <div class="fw-bold">${p}</div>
                  <a class="btn btn-sm btn-primary" href="/OnlineStore/store/product/${encodeURIComponent(item.productCode||"")}">前往</a>
                </div>
              </div>
            </div>
          </div>`;
        }
        function pager(total,page,size){
          const host=document.getElementById("pager");
          const pages=Math.max(1,Math.ceil(total/size));
          const mk=(p,t,d=false,a=false)=>`<li class="page-item ${d?'disabled':''} ${a?'active':''}"><a class="page-link" href="#" data-page="${p}">${t}</a></li>`;
          const items=[mk(page-1,"&laquo;",page<=1)];
          for(let i=1;i<=pages && i<=8;i++) items.push(mk(i,i,false,i===page));
          items.push(mk(page+1,"&raquo;",page>=pages));
          host.innerHTML=items.join("");
          host.querySelectorAll("a.page-link").forEach(a=>a.addEventListener("click",e=>{
            e.preventDefault(); const p=parseInt(a.dataset.page,10); if(!isNaN(p)){ state.page=p; load(); }
          }));
        }
        async function load(){
          const p = new URLSearchParams({q:state.q||"",type:state.type||"",sort:state.sort||"newest",page:state.page,pageSize:state.pageSize});
          const res=await fetch(`${apiBase}/products?${p.toString()}`); const data=await res.json();
          document.getElementById("product-list").innerHTML=data.items.map(cardCol).join("");
          pager(data.totalCount,state.page,state.pageSize);
        }
        document.addEventListener("DOMContentLoaded",load);
    </script>
} *@
@{
    ViewData["Title"] = "瀏覽商品";
    Layout = "~/Areas/OnlineStore/Views/Shared/_Layout.cshtml"; // 若你區專用 layout 路徑不同請改這行
}

<section class="container py-4">
    <h2 class="fw-bold mb-3">商城商品</h2>

    <!-- 搜尋條（保留位） -->
    <div class="row mb-4">
        <div class="col-12 col-lg-8">
            <div class="input-group shadow-sm rounded-pill">
                <input id="q" type="text" class="form-control border-0 rounded-start-pill px-4" placeholder="搜尋商品/關鍵字">
                <button id="btnSearch" class="btn btn-light rounded-end-pill px-4">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="grid" class="row g-3"></div>
</section>

@section Styles {
    <style>
        #grid .card {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
            transition: transform .15s ease, box-shadow .15s ease;
            background: rgba(255,255,255,.9);
            box-shadow: 0 6px 16px rgba(0,0,0,.07);
        }

            #grid .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 24px rgba(0,0,0,.12);
            }

        .card-img-wrap {
            position: relative;
            padding-top: 100%; /* 1:1 */
            background: #f7f7f7;
        }

            .card-img-wrap img {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .badge-type {
            position: absolute;
            top: .5rem;
            left: .5rem;
            backdrop-filter: blur(4px);
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
        }
    </style>
}

@section Scripts {
    <script>
        const apiList = "/OnlineStore/api/StoreApi/GetBrowseCards";

        function money(v){
            if (v == null) return "";
            return new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
        }

        function cardTpl(x){
          const detailUrl = `/OnlineStore/Product/Detail/${x.productId}`;
          const img = x.coverUrl || "/images/placeholder-cover.png";
          return `
            <div class="col-6 col-md-4 col-lg-3 col-xxl-2">
              <div class="card h-100">
                <a class="card-img-wrap" href="${detailUrl}" title="${x.productName}">
                  <img src="${img}" alt="${x.productName}">
                  ${x.productType ? `<span class="badge rounded-pill text-bg-dark badge-type">${x.productType}</span>` : ""}
                </a>
                <div class="card-body d-flex flex-column p-3">
                  <h6 class="card-title text-truncate mb-1" title="${x.productName}">${x.productName}</h6>
                  <div class="mb-3">
                    <span class="fw-bold">\$${money(x.price)}</span>
                    <span class="text-muted small">${x.currencyCode || "TWD"}</span>
                  </div>
                  <div class="mt-auto d-flex gap-2">
                    <button class="btn btn-sm btn-outline-dark flex-fill btn-icon" data-action="add-cart" data-id="${x.productId}">
                      <i class="bi bi-cart-plus"></i><span>加入購物車</span>
                    </button>
                    <button class="btn btn-sm btn-dark flex-fill btn-icon" data-action="buy-now" data-id="${x.productId}">
                      <i class="bi bi-bag-check"></i><span>直接下單</span>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" data-action="fav" data-id="${x.productId}" title="加入我的最愛">
                      <i class="bi bi-heart"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        }

        async function load(){
          const res = await fetch(apiList);
          const data = await res.json();
          const q = (document.getElementById('q').value || "").trim().toLowerCase();
          const filtered = !q ? data : data.filter(x =>
            x.productName?.toLowerCase().includes(q) ||
            x.productType?.toLowerCase().includes(q)
          );
          document.getElementById('grid').innerHTML = filtered.map(cardTpl).join("");
        }

        document.getElementById('btnSearch').addEventListener('click', load);
        document.addEventListener('keyup', (e)=>{ if(e.key==='Enter') load(); });

        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-action]');
          if(!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');

          if(action === 'add-cart'){
            // TODO: 串購物車 API
            alert(`已加入購物車（商品ID: ${id}）`);
          }else if(action === 'buy-now'){
            // TODO: 串直接下單流程
            location.href = `/OnlineStore/Checkout/CreateOrder?productId=${id}`;
          }else if(action === 'fav'){
            // TODO: 串加入我的最愛 API
            btn.classList.toggle('text-danger');
          }
        });

        load();
    </script>
}
