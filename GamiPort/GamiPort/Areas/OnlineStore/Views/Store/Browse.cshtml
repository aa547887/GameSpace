@{
    ViewData["Title"] = "全部商品 - GamiStore";
}

@section Styles {
    <style>
        .rank-tabs .nav-link.active {
            font-weight: 700
        }

        .product-card img {
            object-fit: cover;
            width: 100%;
            height: 180px
        }

        .sticky-side {
            position: sticky;
            top: 72px
        }
    </style>
}

<div class="container-xxl py-3">
    <div class="row g-3">
        <aside class="col-lg-2 d-none d-lg-block">
            <div class="sticky-side">
                <div class="list-group small">
                    <a class="list-group-item list-group-item-action" href="/OnlineStore/store/browse?type=game">數位/主機</a>
                    <a class="list-group-item list-group-item-action" href="/OnlineStore/store/browse?type=notgame">週邊/點數</a>
                    <a class="list-group-item list-group-item-action" href="/OnlineStore/store/browse?tag=sale">特價</a>
                </div>
            </div>
        </aside>

        <div class="col-12 col-lg-10">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <div class="input-group" style="max-width:520px">
                    <input id="q" class="form-control" placeholder="搜尋想要的商品或遊戲…" />
                    <button id="btnSearch" class="btn btn-primary">搜尋</button>
                </div>
                <div class="vr mx-1 d-none d-lg-block"></div>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm filter-type" data-type="">全部</button>
                    <button class="btn btn-outline-secondary btn-sm filter-type" data-type="game">數位/主機</button>
                    <button class="btn btn-outline-secondary btn-sm filter-type" data-type="notgame">週邊/點數</button>
                </div>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <select id="sort" class="form-select form-select-sm" style="width:auto">
                        <option value="newest">最新</option>
                        <option value="price_asc">價格 ↑</option>
                        <option value="price_desc">價格 ↓</option>
                    </select>
                    <select id="pageSize" class="form-select form-select-sm" style="width:auto">
                        <option>12</option>
                        <option>24</option>
                        <option>36</option>
                    </select>
                </div>
            </div>

            <div id="product-list" class="row g-3"></div>
            <nav class="mt-3"><ul class="pagination pagination-sm" id="pager"></ul></nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const apiBase="/api/store";
        let state={
          q:new URLSearchParams(location.search).get("q")||"",
          type:new URLSearchParams(location.search).get("type")||"",
          sort:"newest", page:1, pageSize:12
        };
        if(state.q) document.getElementById("q").value=state.q;

        document.getElementById("btnSearch").addEventListener("click",()=>{ state.q=document.getElementById("q").value.trim(); state.page=1; load(); });
        document.getElementById("sort").addEventListener("change",e=>{ state.sort=e.target.value; state.page=1; load(); });
        document.getElementById("pageSize").addEventListener("change",e=>{ state.pageSize=parseInt(e.target.value,10)||12; state.page=1; load(); });
        document.querySelectorAll(".filter-type").forEach(btn=>{
          btn.addEventListener("click",()=>{
            document.querySelectorAll(".filter-type").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active"); state.type=btn.dataset.type||""; state.page=1; load();
          });
        });

        function cardCol(item){
          const p = new Intl.NumberFormat('zh-TW',{style:'currency',currency:item.currencyCode||'TWD'}).format(item.price||0);
          const platform = item.platformName?`<span class="badge bg-secondary">${item.platformName}</span>`:"";
          return `<div class="col-6 col-md-4 col-lg-3">
            <div class="card product-card h-100">
              <img src="${item.coverUrl||""}" class="card-img-top" alt="${(item.productName||"").replace(/"/g,'&quot;')}" onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-1">${platform}${item.isPreorder?'<span class="badge bg-danger">預購</span>':''}</div>
                <h6 class="card-title mb-2 text-truncate" title="${(item.productName||"").replace(/"/g,'&quot;')}">${item.productName||""}</h6>
                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <div class="fw-bold">${p}</div>
                  <a class="btn btn-sm btn-primary" href="/OnlineStore/store/product/${encodeURIComponent(item.productCode||"")}">前往</a>
                </div>
              </div>
            </div>
          </div>`;
        }
        function pager(total,page,size){
          const host=document.getElementById("pager");
          const pages=Math.max(1,Math.ceil(total/size));
          const mk=(p,t,d=false,a=false)=>`<li class="page-item ${d?'disabled':''} ${a?'active':''}"><a class="page-link" href="#" data-page="${p}">${t}</a></li>`;
          const items=[mk(page-1,"&laquo;",page<=1)];
          for(let i=1;i<=pages && i<=8;i++) items.push(mk(i,i,false,i===page));
          items.push(mk(page+1,"&raquo;",page>=pages));
          host.innerHTML=items.join("");
          host.querySelectorAll("a.page-link").forEach(a=>a.addEventListener("click",e=>{
            e.preventDefault(); const p=parseInt(a.dataset.page,10); if(!isNaN(p)){ state.page=p; load(); }
          }));
        }
        async function load(){
          const p = new URLSearchParams({q:state.q||"",type:state.type||"",sort:state.sort||"newest",page:state.page,pageSize:state.pageSize});
          const res=await fetch(`${apiBase}/products?${p.toString()}`); const data=await res.json();
          document.getElementById("product-list").innerHTML=data.items.map(cardCol).join("");
          pager(data.totalCount,state.page,state.pageSize);
        }
        document.addEventListener("DOMContentLoaded",load);
    </script>
}
