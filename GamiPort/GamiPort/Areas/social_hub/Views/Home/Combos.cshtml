@{
    ViewData["Title"] = "統合操作測試（交友 + 通知）";
    var relExecUrl = Url.Action("Exec", "Relations", new { area = "social_hub" });
    var ntfAjaxUrl = Url.Action("Ajax", "Notifications", new { area = "social_hub" });
}

<div class="container py-4">
    <h2 class="mb-3">統合操作測試（交友 + 通知）</h2>

    @Html.AntiForgeryToken()

    <p class="text-muted">
        此頁面整合了交友關係操作與通知發送功能，並使用程式化方式呼叫各自的 JavaScript 函式。
        交友操作成功且狀態有變更時，會自動觸發通知發送。
    </p>

    <hr />

    <h3>交友關係操作</h3>
    <div class="d-grid gap-2 col-md-6 mb-4">
        <!-- 送出交友邀請 -->
        <button class="btn btn-primary" id="sendFriendRequestBtn">
            送出交友邀請（1 → 2）
        </button>

        <!-- 接受邀請 -->
        <button class="btn btn-success" id="acceptRequestBtn">
            接受邀請（2 接受 1）
        </button>

        <!-- 拒絕邀請 -->
        <button class="btn btn-outline-danger" id="rejectRequestBtn">
            拒絕邀請（2 拒絕 1）
        </button>

        <!-- 取消邀請（由邀請者取消） -->
        <button class="btn btn-warning" id="cancelRequestBtn">
            取消邀請（1 取消）
        </button>

        <!-- 封鎖 / 解除封鎖 -->
        <button class="btn btn-dark" id="blockUserBtn">
            封鎖（1 封鎖 2）
        </button>

        <button class="btn btn-secondary" id="unblockUserBtn">
            解除封鎖（1 → 2）
        </button>

        <!-- 解除好友 -->
        <button class="btn btn-danger" id="unfriendBtn">
            解除好友（1 → 2）
        </button>

        <!-- 設定暱稱（雙向關係一筆資料；這裡僅示範存 FriendNickname） -->
        <button class="btn btn-info" id="setNicknameBtn">
            設定暱稱（1 對 2：小明）
        </button>
    </div>

    <hr />

    <div class="row g-3">
        <div class="col-md-6">
            <h5>最後一次送出的 Payload</h5>
            <pre id="lastPayload" class="bg-light p-2 border small" style="min-height: 160px; white-space: pre-wrap;"></pre>
        </div>
        <div class="col-md-6">
            <h5>伺服器回應</h5>
            <pre id="lastResponse" class="bg-light p-2 border small" style="min-height: 160px; white-space: pre-wrap;"></pre>
        </div>
    </div>

    <div id="status" class="mt-3 small text-muted"></div>
</div>

@section Scripts {
    <script src="~/js/social_hub/relation.js"></script>
    <script src="~/js/social_hub/notify.js"></script>
    <script>
        console.log('Combos.cshtml inline script loaded.');

        const $ = (s) => document.querySelector(s);
        const toInt = (v) => (v == null || v === "" ? null : (isFinite(v) ? Number(v) : null));
        const toStr = (v) => (v == null || v === "" ? null : String(v));

        const relExecUrl = '@relExecUrl';
        const ntfAjaxUrl = '@ntfAjaxUrl';

        // 處理交友指令發送的通用函式
        async function handleSendRelationCommand(command) {
            $('#lastPayload').textContent = JSON.stringify({ relation: command }, null, 2);
            $('#lastResponse').textContent = '';
            $('#status').textContent = '送出交友指令中…';

            const result = await window.sendRelationCommand({ url: relExecUrl, command: command });

            if (result.succeeded) {
                console.log("交友指令發送成功！", result);
                $('#lastResponse').textContent = JSON.stringify(result, null, 2);
                $('#status').textContent = `交友操作完成: ${result.newStatusCode} (NoOp: ${result.noOp})`;
            } else {
                console.error("交友指令發送失敗！原因: ", result.reason);
                $('#lastResponse').textContent = JSON.stringify(result, null, 2);
                $('#status').textContent = `交友操作失敗: ${result.reason}`;
            }
            return result;
        }

        // 處理通知發送的通用函式
        async function handleSendNotification(payload) {
            $('#lastPayload').textContent = JSON.stringify({ notification: payload }, null, 2);
            $('#lastResponse').textContent = '';
            $('#status').textContent = '送出通知中…';

            const result = await window.sendNotification({ url: ntfAjaxUrl, payload: payload });

            if (result.succeeded) {
                console.log("通知發送成功！Notification ID: " + result.notificationId);
                $('#lastResponse').textContent = JSON.stringify(result, null, 2);
                $('#status').textContent = `通知發送完成: ID ${result.notificationId}`;
            } else {
                console.error("通知發送失敗！原因: " + result.reason);
                $('#lastResponse').textContent = JSON.stringify(result, null, 2);
                $('#status').textContent = `通知發送失敗: ${result.reason}`;
            }
            return result;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 檢查 window.sendRelationCommand 和 window.sendNotification 是否為函式
            if (typeof window.sendRelationCommand !== 'function') {
                console.error('錯誤：window.sendRelationCommand 函式未定義或無法存取。請確認 relation.js 已正確載入並執行。');
                return;
            }
            if (typeof window.sendNotification !== 'function') {
                console.error('錯誤：window.sendNotification 函式未定義或無法存取。請確認 notify.js 已正確載入並執行。');
                return;
            }

            // ===================================================================
            // 交友關係操作按鈕事件
            // ===================================================================

            // 送出交友邀請
            const sendFriendRequestBtn = $('#sendFriendRequestBtn');
            if (sendFriendRequestBtn) {
                sendFriendRequestBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000001,
                        targetUserId: 10000002,
                        actionCode: "friend_request"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 6, // 好友邀請
                            toUserId: 10000002,
                            title: "好友邀請",
                            message: `使用者 #${command.actorUserId} 向你送出了好友邀請。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 接受邀請
            const acceptRequestBtn = $('#acceptRequestBtn');
            if (acceptRequestBtn) {
                acceptRequestBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000002,
                        targetUserId: 10000001,
                        actionCode: "accept"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 1, // 泛用公告
                            toUserId: 10000001,
                            title: "好友邀請已接受",
                            message: `你的好友邀請已被 #${command.actorUserId} 接受。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 拒絕邀請
            const rejectRequestBtn = $('#rejectRequestBtn');
            if (rejectRequestBtn) {
                rejectRequestBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000002,
                        targetUserId: 10000001,
                        actionCode: "reject"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 1, // 泛用公告
                            toUserId: 10000001,
                            title: "好友邀請被拒絕",
                            message: `你對 #${command.targetUserId} 的好友邀請已被 #${command.actorUserId} 拒絕。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 取消邀請
            const cancelRequestBtn = $('#cancelRequestBtn');
            if (cancelRequestBtn) {
                cancelRequestBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000001,
                        targetUserId: 10000002,
                        actionCode: "cancel_request"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 1, // 泛用公告
                            toUserId: 10000002,
                            title: "好友邀請已取消",
                            message: `使用者 #${command.actorUserId} 已取消對你的好友邀請。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 封鎖
            const blockUserBtn = $('#blockUserBtn');
            if (blockUserBtn) {
                blockUserBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000001,
                        targetUserId: 10000002,
                        actionCode: "block"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 5, // 封鎖
                            toUserId: 10000002,
                            title: "封鎖通知",
                            message: `你已被使用者 #${command.actorUserId} 設為封鎖。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 解除封鎖
            const unblockUserBtn = $('#unblockUserBtn');
            if (unblockUserBtn) {
                unblockUserBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000001,
                        targetUserId: 10000002,
                        actionCode: "unblock"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 1, // 泛用公告
                            toUserId: 10000002,
                            title: "解除封鎖",
                            message: `你已被使用者 #${command.actorUserId} 解除封鎖。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 解除好友
            const unfriendBtn = $('#unfriendBtn');
            if (unfriendBtn) {
                unfriendBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000001,
                        targetUserId: 10000002,
                        actionCode: "unfriend"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 1, // 泛用公告
                            toUserId: 10000002,
                            title: "解除好友",
                            message: `使用者 #${command.actorUserId} 已將你從好友中移除。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }

            // 設定暱稱
            const setNicknameBtn = $('#setNicknameBtn');
            if (setNicknameBtn) {
                setNicknameBtn.addEventListener('click', async () => {
                    const command = {
                        actorUserId: 10000001,
                        targetUserId: 10000002,
                        actionCode: "set_nickname",
                        nickname: "小明"
                    };
                    const relResult = await handleSendRelationCommand(command);

                    if (relResult.succeeded && !relResult.noOp) {
                        const notificationPayload = {
                            sourceId: 1,
                            actionId: 1, // 泛用公告
                            toUserId: 10000002,
                            title: "好友暱稱變更",
                            message: `使用者 #${command.actorUserId} 將你的暱稱設定為「${command.nickname}」。`
                        };
                        await handleSendNotification(notificationPayload);
                    }
                });
            }
        });
    </script>
}